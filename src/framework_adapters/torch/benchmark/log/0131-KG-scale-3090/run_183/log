WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240206 00:35:05.009172 25047 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_127', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=3, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=3, gpu=[0, 1, 2], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [25047 sampler.py:454] Start PreSampling
WARNING [25047 sampler.py:532] Before construct renumbering_dict
WARNING [25047 sampler.py:555] PreSampling done
W20240206 00:53:27.485436 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240206 00:53:27.485641 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240206 00:53:27.485682 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240206 00:53:27.485711 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240206 00:53:27.485740 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240206 00:53:27.485778 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240206 00:53:27.485812 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240206 00:53:27.485858 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240206 00:53:27.485891 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240206 00:53:27.485936 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240206 00:53:27.485972 25047 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240206 00:53:27.486002 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240206 00:53:27.486028 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240206 00:53:27.486227 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240206 00:53:27.486272 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240206 00:53:27.486301 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240206 00:53:27.486347 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240206 00:53:27.486377 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240206 00:53:27.486421 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240206 00:53:27.486475 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240206 00:53:27.486505 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240206 00:53:27.486546 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240206 00:53:27.486574 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240206 00:53:27.486609 25047 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240206 00:53:27.486632 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240206 00:53:27.486657 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240206 00:53:27.486717 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240206 00:53:27.486757 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240206 00:53:27.486784 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240206 00:53:27.486819 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240206 00:53:27.486847 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240206 00:53:27.486882 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240206 00:53:27.486913 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240206 00:53:27.486950 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240206 00:53:27.486987 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240206 00:53:27.487022 25047 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240206 00:53:27.487052 25047 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240206 00:53:27.487075 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240206 00:53:27.487100 25047 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
{0: Graph(num_nodes=32806815, num_edges=98289586,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=31756927, num_edges=120802495,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=32681333, num_edges=137186093,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 32806815 N 98289586 E
MertisPartition: part 1 has 31756927 N 120802495 E
MertisPartition: part 2 has 32681333 N 137186093 E
Rank0: cached key size 1434235
Rank1: cached key size 1434235
Rank2: cached key size 1434235
Before renumbering graph:  {'_ID': tensor([     196,      197,      239,  ..., 85907466, 77843586,   627118]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4309125,  4309159,  4310529,  ..., 83907326, 84201586, 22904488]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=32806815, num_edges=98289586,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=32806815, num_edges=98289586,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1711.097 seconds
[Rank1] pid = 25931
INFO [25047 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [26027 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [26027 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [25931 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [25047 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [25931 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
E20240206 01:03:40.588833 25932 recstore.cc:66] init folly done
E20240206 01:03:40.588833 26028 recstore.cc:66] init folly done
E20240206 01:03:40.588884 26095 recstore.cc:66] init folly done
I20240206 01:03:54.108477 26095 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 3
I20240206 01:03:58.095105 25932 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
I20240206 01:04:00.510236 26028 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 12.420 ms                 | 12.420 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 7.830 ms                  | 129.021 ms                |
| Forward                   | 9.289 ms                  | 17.453 ms                 |
| Backward                  | 5.959 ms                  | 6.107 ms                  |
| Optimize                  | 9.537 ms                  | 14.205 ms                 |
| OneStep                   | 42.912 ms                 | 282.526 ms                |
+---------------------------+---------------------------+---------------------------+
[Rank2] pid = 26027
train_sampler.Prefill()
-------Step 0-------
tensor([  541290,    46225,   541319, 17591832,   541352,   541391,     2362,
         1220131,   974217,   541425]) tensor([ 7571077, 41698382, 21458631, 71436309, 28091318,   389722, 71711760,
        19126321, 59267598, 40437646])
-------Step 1-------
tensor([  541290,    46225,   541319, 17591832,   541352,   541391,     2362,
         1220131,   974217,   541425]) tensor([67362542, 22265596,  4572960, 56515123, 61868993, 51558624, 17341409,
        22447585,  1812952, 38626506])
-------Step 2-------
tensor([641617, 641661,   2548, 983243, 641701, 641751, 641786, 519391, 641824,
        641857]) tensor([26128967, 49411327, 79415988, 65171493, 18585302, 43649509, 23857496,
        31976869, 70427712, 77335112])
-------Step 3-------
tensor([641617, 641661,   2548, 983243, 641701, 641751, 641786, 519391, 641824,
        641857]) tensor([56832667,  1294377, 50645669, 11700286, 79438854, 11420361, 14755230,
        78334546, 80787322, 83253978])
-------Step 4-------
tensor([  741405,   741449,   352255,   741479,  1231437,   741512, 20278685,
          741552,   741587,   741630]) tensor([48562508, 79525586, 10760948, 58308687, 63295998, 85988039, 13679753,
        31372764,  8679888, 25676685])
-------Step 5-------
tensor([  741405,   741449,   352255,   741479,  1231437,   741512, 20278685,
          741552,   741587,   741630]) tensor([45276900, 52068797, 30632795, 45192497, 10908709, 81050151, 44502020,
        28150555,  1108849, 49744491])
-------Step 6-------
tensor([  842146,   842181,   842208,  1237346, 20278685,   842255,   842304,
          842342,   842384,       68]) tensor([56001204, 13669548, 75051790, 23750541,   965174, 34031237, 16462256,
         8095853,   275438, 25268337])
-------Step 7-------
tensor([  842146,   842181,   842208,  1237346, 20278685,   842255,   842304,
          842342,   842384,       68]) tensor([49356137, 46826274, 52966702,   242540, 29741518, 42719585, 79764366,
        83815109, 34073955, 37118071])
-------Step 8-------
tensor([  940017,   940059,   940095,   940143,  1007615,   940189, 14333871,
          940229,   940263, 14644371]) tensor([82790913, 27904264, 23375934, 17229450, 69656059,  9403299, 72019236,
         1377186, 71867754, 56341428])
-------Step 9-------
tensor([  940017,   940059,   940095,   940143,  1007615,   940189, 14333871,
          940229,   940263, 14644371]) tensor([26649640, 49318543, 47438987, 51189976, 41113569, 61312895, 45612834,
        25435143, 69571134, 21369677])
before start barrier
start train
[proc 0] 100 steps, total: 13.017, sample: 1.661, forward: 1.621, backward: 0.754, update: 1.015
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 9.030, sample: 1.825, forward: 2.478, backward: 0.763, update: 1.139
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 6.615, sample: 1.855, forward: 2.445, backward: 0.857, update: 1.148
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.106 ms                  | 112.460 ms                |
| Forward                   | 9.289 ms                  | 23.088 ms                 |
| Backward                  | 5.960 ms                  | 6.129 ms                  |
| Optimize                  | 9.788 ms                  | 16.382 ms                 |
| OneStep                   | 40.366 ms                 | 254.615 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 5.199, sample: 1.417, forward: 1.619, backward: 0.606, update: 1.019
[proc 2] 200 steps, total: 5.199, sample: 1.463, forward: 1.611, backward: 0.582, update: 1.067
[proc 0] 200 steps, total: 5.199, sample: 1.129, forward: 1.020, backward: 0.628, update: 1.079
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.831 ms                  | 111.578 ms                |
| Forward                   | 9.151 ms                  | 19.044 ms                 |
| Backward                  | 5.957 ms                  | 6.274 ms                  |
| Optimize                  | 9.746 ms                  | 26.306 ms                 |
| OneStep                   | 38.900 ms                 | 238.218 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 300 steps, total: 4.505, sample: 0.996, forward: 1.528, backward: 0.612, update: 0.988
[proc 2] 300 steps, total: 4.505, sample: 1.045, forward: 1.556, backward: 0.485, update: 1.007
[proc 0] 300 steps, total: 4.505, sample: 0.883, forward: 0.998, backward: 0.584, update: 1.063
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.250 ms                  | 90.235 ms                 |
| Forward                   | 9.189 ms                  | 19.044 ms                 |
| Backward                  | 5.957 ms                  | 6.274 ms                  |
| Optimize                  | 9.863 ms                  | 26.306 ms                 |
| OneStep                   | 37.633 ms                 | 229.516 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 2] 400 steps, total: 4.545, sample: 1.149, forward: 1.428, backward: 0.660, update: 1.044
[proc 0] 400 steps, total: 4.544, sample: 0.788, forward: 0.964, backward: 0.594, update: 1.058
[proc 1] 400 steps, total: 4.545, sample: 0.976, forward: 1.443, backward: 0.628, update: 0.980
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.005 ms                  | 86.294 ms                 |
| Forward                   | 9.204 ms                  | 19.080 ms                 |
| Backward                  | 5.953 ms                  | 11.805 ms                 |
| Optimize                  | 10.000 ms                 | 25.824 ms                 |
| OneStep                   | 38.067 ms                 | 223.169 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 2] 500 steps, total: 4.653, sample: 1.236, forward: 1.359, backward: 0.633, update: 1.067
[proc 1] 500 steps, total: 4.653, sample: 0.832, forward: 1.454, backward: 0.601, update: 0.998
[proc 0] 500 steps, total: 4.653, sample: 0.786, forward: 1.021, backward: 0.599, update: 1.063
Successfully xmh. training takes 31.91927695274353 seconds
before call kg_cache_controller.StopThreads()
