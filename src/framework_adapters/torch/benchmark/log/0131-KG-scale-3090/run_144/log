WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240205 21:19:16.347245 60920 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_FB15k_30', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=3, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=3, gpu=[0, 1, 2], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [60920 sampler.py:454] Start PreSampling
WARNING [60920 sampler.py:532] Before construct renumbering_dict
WARNING [60920 sampler.py:555] PreSampling done
W20240205 21:19:21.386831 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240205 21:19:21.387063 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240205 21:19:21.387115 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240205 21:19:21.387168 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240205 21:19:21.387215 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240205 21:19:21.387271 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240205 21:19:21.387318 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240205 21:19:21.387374 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240205 21:19:21.387423 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240205 21:19:21.387466 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240205 21:19:21.387511 60920 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240205 21:19:21.387552 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240205 21:19:21.387590 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240205 21:19:21.387738 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240205 21:19:21.387792 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240205 21:19:21.387836 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240205 21:19:21.387893 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240205 21:19:21.387933 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240205 21:19:21.387988 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240205 21:19:21.388036 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240205 21:19:21.388087 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240205 21:19:21.388126 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240205 21:19:21.388181 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240205 21:19:21.388221 60920 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240205 21:19:21.388255 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240205 21:19:21.388291 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240205 21:19:21.388373 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240205 21:19:21.388427 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240205 21:19:21.388468 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240205 21:19:21.388526 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240205 21:19:21.388571 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240205 21:19:21.388618 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240205 21:19:21.388677 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240205 21:19:21.388718 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240205 21:19:21.388763 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240205 21:19:21.388804 60920 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240205 21:19:21.388845 60920 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240205 21:19:21.388877 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240205 21:19:21.388912 60920 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240205 21:19:21.660264 60920 IPCTensor.h:369] NewIPCTensor: full_emb [14951, 400]0x10000e52e000 22.81 MB
W20240205 21:19:21.749099 60920 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x10000fc00000 58.4 kB
{0: Graph(num_nodes=11088, num_edges=209563,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=12469, num_edges=203028,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=11122, num_edges=307147,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 11088 N 209563 E
MertisPartition: part 1 has 12469 N 203028 E
MertisPartition: part 2 has 11122 N 307147 E
Rank0: cached key size 249
Rank1: cached key size 249
Rank2: cached key size 249
Before renumbering graph:  {'_ID': tensor([   7,   10,   16,  ..., 9100, 2559, 8058]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([1043, 1139, 1362,  ..., 8807, 6590, 3745]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 5.500 seconds
[Rank1] pid = 61126
INFO [60920 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [60920 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [61126 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [61180 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [61126 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [61180 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
W20240205 21:19:23.580983 61191 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [747, 400]; dev=0; size=1.14 MB
W20240205 21:19:23.584496 61127 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [747, 400]; dev=1; size=1.14 MB
W20240205 21:19:23.584496 61254 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_2 [747, 400]; dev=2; size=1.14 MB
W20240205 21:19:23.614776 61191 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x10000fc16000 7.629 MB
W20240205 21:19:23.614859 61127 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x1000103b9000 7.629 MB
W20240205 21:19:23.614863 61254 IPCTensor.h:369] NewIPCTensor: input_keys_2 [1000000]0x100010b5c000 7.629 MB
W20240205 21:19:23.614996 61191 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x1000112ff000 7.629 MB
W20240205 21:19:23.615060 61191 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x100011aa2000 1.49 GB
W20240205 21:19:23.615109 61254 IPCTensor.h:369] NewIPCTensor: input_keys_neg_2 [1000000]0x100071085000 7.629 MB
W20240205 21:19:23.615118 61191 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x100071828000 1.49 GB
W20240205 21:19:23.615134 61127 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x1000d0e0b000 7.629 MB
W20240205 21:19:23.615188 61191 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240205 21:19:23.615237 61254 IPCTensor.h:369] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000d15ae000 1.49 GB
W20240205 21:19:23.615271 61127 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x100130b91000 1.49 GB
W20240205 21:19:23.615314 61254 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x100190174000 1.49 GB
W20240205 21:19:23.615374 61127 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1001ef757000 1.49 GB
W20240205 21:19:23.616748 61127 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 21:19:23.616750 61254 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240205 21:19:23.619997 61191 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240205 21:19:23.620136 61127 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 21:19:23.623005 61254 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
cudaHostRegister 0x10000e52e000
2: KnownLocalCachedEmbedding init done
WARNING [61180 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank2] pid = 61180
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 747), (747, 1494), (1494, 2241)]
cudaHostRegister 0x10000e52e000
0: KnownLocalCachedEmbedding init done
WARNING [60920 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x10000e52e000
1: KnownLocalCachedEmbedding init done
WARNING [61126 DistTensor.py:59] The tensor name already exists in the kvstore
I20240205 21:19:26.057967 61127 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 3
I20240205 21:19:26.058151 61254 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 3
I20240205 21:19:26.058524 61191 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 3
W20240205 21:19:26.061029 61191 grad_base.h:55] KGCacheController, config={
        "num_gpus": 3,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240205 21:19:26.061334 61191 grad_base.h:184] Init GradProcessingBase done
I20240205 21:19:26.072654 61191 grad_async_v2.h:42] Use main thread to update emb.
W20240205 21:19:26.072713 61191 kg_controller.h:78] after init GradAsyncProcessingV2
I20240205 21:19:26.072732 61191 kg_controller.h:84] Construct KGCacheController done
E20240205 21:19:27.393451 61254 recstore.cc:66] init folly done
E20240205 21:19:27.393819 61127 recstore.cc:66] init folly done
E20240205 21:19:27.393843 61191 recstore.cc:66] init folly done
I20240205 21:19:27.394855 61191 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240205 21:19:27.664496 61511 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240205 21:19:27.664897 61511 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
I20240205 21:19:27.720527 61191 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 3
I20240205 21:19:27.725590 61127 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
I20240205 21:19:27.736511 61254 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
E20240205 21:19:28.738834 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240205 21:19:28.766824 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=1, pq.top=1
W20240205 21:19:28.770547 61511 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240205 21:19:28.796635 61191 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=1, sample_step_cpp_seen_[rank]=0
E20240205 21:19:29.738039 61516 parallel_pq_v2.h:79] insert failed, size(hashtable)=2070
W20240205 21:19:29.777943 61511 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
W20240205 21:19:29.798905 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=24, pq.top=24
E20240205 21:19:30.738075 61517 parallel_pq_v2.h:79] insert failed, size(hashtable)=13173
W20240205 21:19:30.834913 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=49, pq.top=49
W20240205 21:19:30.855406 61511 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.440 ms                  | 31.577 ms                 |
| Forward                   | 5.327 ms                  | 9.458 ms                  |
| Backward                  | 5.308 ms                  | 10.859 ms                 |
| Optimize                  | 2.785 ms                  | 9.033 ms                  |
| BarrierTimeBeforeRank0    | 989.848 us                | 7.467 ms                  |
| AfterBackward             | 21.042 ms                 | 45.592 ms                 |
| BlockToStepN              | 367.035 us                | 2.918 ms                  |
| OneStep                   | 39.198 ms                 | 76.855 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 21:19:31.738044 61542 parallel_pq_v2.h:79] insert failed, size(hashtable)=5964
W20240205 21:19:31.840494 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=71, pq.top=71
W20240205 21:19:31.866300 61511 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 306.935 us                | 5.153 ms                  |
| ProcessBack:Shuffle       | 1.749 ms                  | 2.691 ms                  |
| ProcessBack:UpdateCache   | 1.424 ms                  | 2.541 ms                  |
| ProcessBack:UpsertPq      | 15.985 ms                 | 21.252 ms                 |
| ProcessOneStep            | 21.140 ms                 | 150.870 ms                |
| BlockToStepN              | 300.481 us                | 3.941 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240205 21:19:32.738014 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=450
W20240205 21:19:32.859488 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=94, pq.top=94
W20240205 21:19:32.884713 61511 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end5
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.345, sample: 0.414, forward: 0.894, backward: 0.814, update: 0.271
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.335, sample: 0.447, forward: 0.907, backward: 0.752, update: 0.271
train_sampler.Prefill()
-------Step 0-------
tensor([ 152, 9930, 9307, 6328,   99, 7934, 5128, 7743, 6351, 9289]) tensor([ 1362,  3064, 14657,  5014,  6800, 10067,   258,  7429,  5477, 14901])
-------Step 1-------
tensor([ 152, 9930, 9307, 6328,   99, 7934, 5128, 7743, 6351, 9289]) tensor([ 5327,  9615,  6585, 14927,  6863,  6627,  1605, 13357,  5386,  3392])
-------Step 2-------
tensor([ 7849,  1586,  9251,     3,  6552,  3152,   163,  3485, 14564, 12384]) tensor([ 5501,  6905, 14462,  7040,  4974, 11942,  6777,  1032,  1888,  9389])
-------Step 3-------
tensor([ 7849,  1586,  9251,     3,  6552,  3152,   163,  3485, 14564, 12384]) tensor([ 7257,   296,  6456,  2267,  8780,  1687,  3417,  3959,   997, 12789])
-------Step 4-------
tensor([12462, 14236,   169,  5671, 11851,  2358,   185,   209,    83,  6845]) tensor([ 2862,  6245,  9662,  6478, 14552,  8793,  9537,   690,   346,  4177])
-------Step 5-------
tensor([12462, 14236,   169,  5671, 11851,  2358,   185,   209,    83,  6845]) tensor([ 4858, 12386, 10981,  6073, 14823, 11265, 12984, 13502, 14049,  1720])
-------Step 6-------
tensor([14461,  3778, 13770,     0, 14080,  2533, 12891, 14685,  7136,   750]) tensor([ 2314, 11037, 11940,  4812, 14910,  4363,  5149,  5803,  2931, 14596])
-------Step 7-------
tensor([14461,  3778, 13770,     0, 14080,  2533, 12891, 14685,  7136,   750]) tensor([10641,  8735,  9669,   589, 13650, 11085,  1660,  2699, 10109,   929])
-------Step 8-------
tensor([ 5699,   176,  8141,  1440, 10891,   934,   224,  6311,  1719,  7249]) tensor([ 3923, 11010,    47, 13731,  6698,  3365,  6845,  8310, 10312, 11168])
-------Step 9-------
tensor([ 5699,   176,  8141,  1440, 10891,   934,   224,  6311,  1719,  7249]) tensor([14042,  5142,  8530,   333,  3338, 12291,  1642,  4833,  7727,  7285])
before start barrier
start train
[proc 0] 100 steps, total: 5.351, sample: 0.512, forward: 0.966, backward: 0.711, update: 0.324
E20240205 21:19:33.738044 61514 parallel_pq_v2.h:79] insert failed, size(hashtable)=9022
W20240205 21:19:33.947860 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=120, pq.top=119
W20240205 21:19:33.967146 61511 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end1
E20240205 21:19:34.738056 61370 parallel_pq_v2.h:79] insert failed, size(hashtable)=1269
W20240205 21:19:34.974365 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=143, pq.top=143
W20240205 21:19:34.975924 61511 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
E20240205 21:19:35.738044 61536 parallel_pq_v2.h:79] insert failed, size(hashtable)=8001
W20240205 21:19:35.993614 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=165, pq.top=165
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.569 ms                  | 33.623 ms                 |
| Forward                   | 5.457 ms                  | 8.702 ms                  |
| Backward                  | 5.284 ms                  | 9.575 ms                  |
| Optimize                  | 2.792 ms                  | 7.605 ms                  |
| BarrierTimeBeforeRank0    | 34.671 us                 | 6.536 ms                  |
| AfterBackward             | 22.205 ms                 | 103.008 ms                |
| BlockToStepN              | 544.908 us                | 3.830 ms                  |
| OneStep                   | 40.874 ms                 | 118.508 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 21:19:36.120383 61511 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end7
E20240205 21:19:36.327728 61370 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=171, sample_step_cpp_seen_[rank]=170
E20240205 21:19:36.738024 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=176
W20240205 21:19:37.030748 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=186, pq.top=186
W20240205 21:19:37.127084 61511 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end9
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 371.691 us                | 5.406 ms                  |
| ProcessBack:Shuffle       | 1.799 ms                  | 2.931 ms                  |
| ProcessBack:UpdateCache   | 1.392 ms                  | 2.159 ms                  |
| ProcessBack:UpsertPq      | 16.303 ms                 | 24.866 ms                 |
| ProcessOneStep            | 22.510 ms                 | 102.965 ms                |
| BlockToStepN              | 590.603 us                | 3.762 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240205 21:19:37.738013 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=267
[proc 2] 200 steps, total: 4.772, sample: 0.459, forward: 0.485, backward: 0.533, update: 0.220
[proc 1] 200 steps, total: 4.772, sample: 0.522, forward: 0.515, backward: 0.585, update: 0.231
[proc 0] 200 steps, total: 4.772, sample: 0.626, forward: 0.542, backward: 0.514, update: 0.278
W20240205 21:19:38.067252 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=205, pq.top=205
W20240205 21:19:38.131698 61511 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
E20240205 21:19:38.738027 61538 parallel_pq_v2.h:79] insert failed, size(hashtable)=3945
W20240205 21:19:39.147002 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=225, pq.top=225
W20240205 21:19:39.171510 61511 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end6
E20240205 21:19:39.738009 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=1365
W20240205 21:19:40.167037 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=244, pq.top=244
W20240205 21:19:40.213879 61511 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end5
E20240205 21:19:40.738066 61511 parallel_pq_v2.h:79] insert failed, size(hashtable)=22
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.698 ms                  | 36.128 ms                 |
| Forward                   | 5.462 ms                  | 8.702 ms                  |
| Backward                  | 5.256 ms                  | 7.689 ms                  |
| Optimize                  | 2.858 ms                  | 6.025 ms                  |
| BarrierTimeBeforeRank0    | 69.939 us                 | 41.142 ms                 |
| AfterBackward             | 23.529 ms                 | 64.192 ms                 |
| BlockToStepN              | 905.884 us                | 4.000 ms                  |
| OneStep                   | 43.050 ms                 | 95.401 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240205 21:19:41.193455 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=263, pq.top=263
W20240205 21:19:41.219245 61511 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
E20240205 21:19:41.738010 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=2735
W20240205 21:19:42.213450 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=281, pq.top=281
W20240205 21:19:42.232122 61511 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 485.584 us                | 5.657 ms                  |
| ProcessBack:Shuffle       | 1.874 ms                  | 2.900 ms                  |
| ProcessBack:UpdateCache   | 1.375 ms                  | 2.050 ms                  |
| ProcessBack:UpsertPq      | 16.994 ms                 | 28.584 ms                 |
| ProcessOneStep            | 24.081 ms                 | 64.157 ms                 |
| BlockToStepN              | 902.748 us                | 4.503 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240205 21:19:42.738104 61526 parallel_pq_v2.h:79] insert failed, size(hashtable)=5682
W20240205 21:19:43.246145 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=299, pq.top=299
W20240205 21:19:43.248005 61511 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
[proc 1] 300 steps, total: 5.453, sample: 0.522, forward: 0.585, backward: 0.511, update: 0.265
[proc 0] 300 steps, total: 5.453, sample: 0.607, forward: 0.552, backward: 0.506, update: 0.290
[proc 2] 300 steps, total: 5.453, sample: 0.435, forward: 0.484, backward: 0.517, update: 0.214
E20240205 21:19:43.738121 61526 parallel_pq_v2.h:79] insert failed, size(hashtable)=5791
W20240205 21:19:44.261063 61511 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
W20240205 21:19:44.278220 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=317, pq.top=317
E20240205 21:19:44.738009 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=309
W20240205 21:19:45.261567 61511 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
W20240205 21:19:45.310770 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=335, pq.top=335
E20240205 21:19:45.738009 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=23
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.819 ms                  | 40.132 ms                 |
| Forward                   | 5.478 ms                  | 9.458 ms                  |
| Backward                  | 5.234 ms                  | 7.689 ms                  |
| Optimize                  | 2.891 ms                  | 6.025 ms                  |
| BarrierTimeBeforeRank0    | 40.953 us                 | 41.142 ms                 |
| AfterBackward             | 25.320 ms                 | 64.192 ms                 |
| BlockToStepN              | 1.160 ms                  | 5.947 ms                  |
| OneStep                   | 45.337 ms                 | 95.401 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240205 21:19:46.288889 61511 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end3
W20240205 21:19:46.357564 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=354, pq.top=354
E20240205 21:19:46.738097 61524 parallel_pq_v2.h:79] insert failed, size(hashtable)=5379
W20240205 21:19:47.350262 61511 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end4
W20240205 21:19:47.365255 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=374, pq.top=374
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 433.160 us                | 5.655 ms                  |
| ProcessBack:Shuffle       | 1.891 ms                  | 2.930 ms                  |
| ProcessBack:UpdateCache   | 1.331 ms                  | 2.050 ms                  |
| ProcessBack:UpsertPq      | 17.860 ms                 | 29.071 ms                 |
| ProcessOneStep            | 25.215 ms                 | 56.134 ms                 |
| BlockToStepN              | 1.138 ms                  | 6.816 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240205 21:19:47.738091 61522 parallel_pq_v2.h:79] insert failed, size(hashtable)=10215
W20240205 21:19:48.366245 61511 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 21:19:48.427649 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=393, pq.top=393
E20240205 21:19:48.738729 61519 parallel_pq_v2.h:79] insert failed, size(hashtable)=6149
[proc 2] 400 steps, total: 5.538, sample: 0.403, forward: 0.482, backward: 0.456, update: 0.221
[proc 1] 400 steps, total: 5.538, sample: 0.441, forward: 0.479, backward: 0.549, update: 0.218
[proc 0] 400 steps, total: 5.538, sample: 0.605, forward: 0.526, backward: 0.509, update: 0.262
W20240205 21:19:49.368539 61511 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
W20240205 21:19:49.476540 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=411, pq.top=411
E20240205 21:19:49.738009 61514 parallel_pq_v2.h:79] insert failed, size(hashtable)=6825
W20240205 21:19:50.386435 61511 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end8
W20240205 21:19:50.519747 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=430, pq.top=430
E20240205 21:19:50.738085 61511 parallel_pq_v2.h:79] insert failed, size(hashtable)=95
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 2.075 ms                  | 40.132 ms                 |
| Forward                   | 5.416 ms                  | 8.702 ms                  |
| Backward                  | 5.231 ms                  | 7.525 ms                  |
| Optimize                  | 2.815 ms                  | 5.601 ms                  |
| BarrierTimeBeforeRank0    | 34.895 us                 | 40.410 ms                 |
| AfterBackward             | 25.101 ms                 | 56.265 ms                 |
| BlockToStepN              | 1.435 ms                  | 7.759 ms                  |
| OneStep                   | 46.895 ms                 | 93.435 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240205 21:19:51.476138 61511 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end8
W20240205 21:19:51.519173 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=448, pq.top=448
E20240205 21:19:51.738037 61539 parallel_pq_v2.h:79] insert failed, size(hashtable)=12008
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 550.400 us                | 7.736 ms                  |
| ProcessBack:Shuffle       | 1.901 ms                  | 3.285 ms                  |
| ProcessBack:UpdateCache   | 1.252 ms                  | 2.029 ms                  |
| ProcessBack:UpsertPq      | 18.513 ms                 | 29.081 ms                 |
| ProcessOneStep            | 25.261 ms                 | 45.447 ms                 |
| BlockToStepN              | 1.509 ms                  | 9.205 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240205 21:19:52.544086 61511 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end5
W20240205 21:19:52.550276 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=465, pq.top=465
E20240205 21:19:52.738015 61370 parallel_pq_v2.h:79] insert failed, size(hashtable)=184
E20240205 21:19:52.782963 61191 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=469, sample_step_cpp_seen_[rank]=468
W20240205 21:19:53.563527 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=478, pq.top=478
W20240205 21:19:53.594813 61511 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end9
E20240205 21:19:53.738010 61370 parallel_pq_v2.h:79] insert failed, size(hashtable)=198
W20240205 21:19:54.588266 61191 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=494, pq.top=494
W20240205 21:19:54.601981 61511 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end5
E20240205 21:19:54.738009 61191 parallel_pq_v2.h:79] insert failed, size(hashtable)=903
[proc 1] 500 steps, total: 5.982, sample: 0.360, forward: 0.444, backward: 0.652, update: 0.200
[proc 0] 500 steps, total: 5.982, sample: 0.618, forward: 0.502, backward: 0.511, update: 0.268
Successfully xmh. training takes 27.097058057785034 seconds
before call kg_cache_controller.StopThreads()
[proc 2] 500 steps, total: 5.982, sample: 0.437, forward: 0.502, backward: 0.501, update: 0.232
W20240205 21:19:54.817663 61191 grad_async_v2.h:84] call StopThreads. PID = 60920
W20240205 21:19:54.817703 61191 grad_base.h:212] before processOneStepNegThread_.join();
W20240205 21:19:54.818135 61191 grad_base.h:214] after processOneStepNegThread_.join();
W20240205 21:19:54.818150 61191 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
W20240205 21:19:54.932685 61191 grad_async_v2.h:105] StopThreads done.
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7f23c436e990>
