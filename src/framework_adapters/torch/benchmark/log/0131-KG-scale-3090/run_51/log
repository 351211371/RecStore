WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240202 17:22:24.034046 34112 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_45', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [34112 sampler.py:454] Start PreSampling
WARNING [34112 sampler.py:532] Before construct renumbering_dict
WARNING [34112 sampler.py:555] PreSampling done
W20240202 17:41:05.669625 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240202 17:41:05.669859 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240202 17:41:05.669906 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240202 17:41:05.669940 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240202 17:41:05.669975 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240202 17:41:05.670017 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240202 17:41:05.670053 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240202 17:41:05.670094 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240202 17:41:05.670125 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240202 17:41:05.670164 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240202 17:41:05.670200 34112 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240202 17:41:05.670230 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240202 17:41:05.670262 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240202 17:41:05.670436 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240202 17:41:05.670482 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240202 17:41:05.670521 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240202 17:41:05.670567 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240202 17:41:05.670598 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240202 17:41:05.670631 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240202 17:41:05.670670 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240202 17:41:05.670703 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240202 17:41:05.670748 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240202 17:41:05.670784 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240202 17:41:05.670815 34112 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240202 17:41:05.670838 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240202 17:41:05.670864 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240202 17:41:05.670923 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240202 17:41:05.670962 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240202 17:41:05.670992 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240202 17:41:05.671022 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240202 17:41:05.671051 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240202 17:41:05.671082 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240202 17:41:05.671115 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240202 17:41:05.671146 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240202 17:41:05.671183 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240202 17:41:05.671213 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240202 17:41:05.671247 34112 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240202 17:41:05.671272 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240202 17:41:05.671296 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240202 17:41:05.671355 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240202 17:41:05.671396 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240202 17:41:05.671427 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240202 17:41:05.671464 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240202 17:41:05.671500 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240202 17:41:05.671530 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240202 17:41:05.671563 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240202 17:41:05.671599 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240202 17:41:05.671636 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240202 17:41:05.671666 34112 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240202 17:41:05.671696 34112 IPCTensor.h:369] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240202 17:41:05.671720 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240202 17:41:05.671744 34112 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
{0: Graph(num_nodes=27225865, num_edges=100970380,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=23781260, num_edges=94780459,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=24473167, num_edges=94766529,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=27322260, num_edges=74213630,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 27225865 N 100970380 E
MertisPartition: part 1 has 23781260 N 94780459 E
MertisPartition: part 2 has 24473167 N 94766529 E
MertisPartition: part 3 has 27322260 N 74213630 E
Rank0: cached key size 1075676
Rank1: cached key size 1075676
Rank2: cached key size 1075676
Rank3: cached key size 1075676
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 82487883, 64859130, 64482679]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 2, 2])}
After renumbering graph:  {'_ID': tensor([ 4302715,  4302736,   110642,  ..., 50508164, 15028695,  2609796]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 2, 2])}
part_g: DGLGraph(num_nodes=27225865, num_edges=100970380,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=27225865, num_edges=100970380,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1726.990 seconds
[Rank1] pid = 54295
[Rank2] pid = 54488
INFO [34112 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [34112 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [54295 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [54649 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [54488 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [54295 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [54649 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [54488 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
E20240202 17:51:15.968992 54296 recstore.cc:66] init folly done
E20240202 17:51:15.968940 54713 recstore.cc:66] init folly done
E20240202 17:51:15.969010 54489 recstore.cc:66] init folly done
E20240202 17:51:15.969053 54650 recstore.cc:66] init folly done
I20240202 17:51:27.620723 54713 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240202 17:51:30.437881 54489 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240202 17:51:30.836822 54650 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240202 17:51:31.046370 54296 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 7.218 ms                  | 113.236 ms                |
| Forward                   | 10.552 ms                 | 16.315 ms                 |
| Backward                  | 5.952 ms                  | 6.495 ms                  |
| Optimize                  | 9.993 ms                  | 30.265 ms                 |
| OneStep                   | 48.159 ms                 | 182.816 ms                |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 9.788, sample: 1.172, forward: 2.535, backward: 0.486, update: 1.024
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 6.362, sample: 1.235, forward: 2.595, backward: 0.748, update: 1.204
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 6.971, sample: 1.251, forward: 2.661, backward: 0.783, update: 1.101
[Rank3] pid = 54649
train_sampler.Prefill()
-------Step 0-------
tensor([   60807,   510172, 54729866,   980435,   474106,   510197,   510222,
          224773,    60835,    60887]) tensor([ 5050811, 23346154, 18932403, 58184027, 61590709, 33426765, 83792301,
        65390733, 46060934, 68467914])
-------Step 1-------
tensor([   60807,   510172, 54729866,   980435,   474106,   510197,   510222,
          224773,    60835,    60887]) tensor([33633528, 62809157, 71414544,  9095072, 46438166,  9625980, 81787234,
        83746417, 20948402, 38886179])
-------Step 2-------
tensor([  584074,    74322, 78554252,    74346,   584099,   584127,   584157,
        50196340,   584179,   584213]) tensor([42441293,  4784287, 48554524,  8963967, 18474752, 14236674, 69864309,
        10890580, 68604151, 35612699])
-------Step 3-------
tensor([  584074,    74322, 78554252,    74346,   584099,   584127,   584157,
        50196340,   584179,   584213]) tensor([21870634, 53544872, 81284150, 33602311, 12456736, 75952591, 77848463,
        54237336, 27314672, 81024208])
-------Step 4-------
tensor([659535,  88277, 659563, 659588,  88316, 659608,  88340, 659632,  88381,
        659662]) tensor([63488421, 32737972, 16346374, 12273347, 45493266, 37799278, 82665618,
        55584842, 53259124, 10124937])
-------Step 5-------
tensor([659535,  88277, 659563, 659588,  88316, 659608,  88340, 659632,  88381,
        659662]) tensor([37684629, 38383283, 81134663,  8343972, 43863072, 25257296, 41744395,
        57617442, 83548183,   610966])
-------Step 6-------
tensor([81338687,   733321,   733343,   733369,  4309575,   733400,   733424,
          733451,   733483,   230385]) tensor([22137034, 51753756, 30969471, 23084082, 80165646, 53226121, 50026250,
        12671542, 65520411,  9313559])
-------Step 7-------
tensor([81338687,   733321,   733343,   733369,  4309575,   733400,   733424,
          733451,   733483,   230385]) tensor([44625039, 72268669, 41299382, 58550344, 77390322,  1490544, 16667183,
        58561274, 23057856, 13746541])
-------Step 8-------
tensor([  804047,   116972,   804073, 30460533,  1010274,   804105,   804130,
          804154,   231969,  1010289]) tensor([29269103, 47870481, 39047690, 76520864, 67671743, 73852942, 51641161,
        72310264,  9250127,  3241376])
-------Step 9-------
tensor([  804047,   116972,   804073, 30460533,  1010274,   804105,   804130,
          804154,   231969,  1010289]) tensor([61425740, 62708284, 28894612, 49802724, 10805815,  1034968, 17485851,
        12255955, 82728729, 37440271])
before start barrier
start train
[proc 0] 100 steps, total: 6.572, sample: 1.550, forward: 1.718, backward: 0.754, update: 1.047
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.578 ms                  | 100.286 ms                |
| Forward                   | 10.564 ms                 | 23.425 ms                 |
| Backward                  | 5.965 ms                  | 17.655 ms                 |
| Optimize                  | 9.881 ms                  | 16.871 ms                 |
| OneStep                   | 43.566 ms                 | 138.752 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 3] 200 steps, total: 4.926, sample: 0.850, forward: 1.674, backward: 0.634, update: 0.966
[proc 1] 200 steps, total: 4.926, sample: 1.003, forward: 1.647, backward: 0.598, update: 1.148
[proc 2] 200 steps, total: 4.926, sample: 1.087, forward: 1.706, backward: 0.596, update: 1.043
[proc 0] 200 steps, total: 4.926, sample: 1.147, forward: 1.058, backward: 0.624, update: 1.034
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.877 ms                  | 98.913 ms                 |
| Forward                   | 10.308 ms                 | 17.223 ms                 |
| Backward                  | 6.018 ms                  | 17.655 ms                 |
| Optimize                  | 9.881 ms                  | 16.871 ms                 |
| OneStep                   | 41.110 ms                 | 133.366 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 300 steps, total: 4.613, sample: 0.977, forward: 1.041, backward: 0.625, update: 1.005
[proc 1] 300 steps, total: 4.613, sample: 0.825, forward: 1.651, backward: 0.608, update: 1.097
[proc 3] 300 steps, total: 4.613, sample: 0.778, forward: 1.576, backward: 0.594, update: 1.004
[proc 2] 300 steps, total: 4.613, sample: 0.841, forward: 1.660, backward: 0.619, update: 1.021
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.493 ms                  | 94.866 ms                 |
| Forward                   | 10.308 ms                 | 17.223 ms                 |
| Backward                  | 6.086 ms                  | 17.655 ms                 |
| Optimize                  | 9.844 ms                  | 16.871 ms                 |
| OneStep                   | 40.002 ms                 | 131.596 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 4.564, sample: 0.815, forward: 1.590, backward: 0.585, update: 1.095
[proc 2] 400 steps, total: 4.564, sample: 0.909, forward: 1.570, backward: 0.598, update: 1.012
[proc 0] 400 steps, total: 4.564, sample: 0.962, forward: 1.051, backward: 0.632, update: 1.011
[proc 3] 400 steps, total: 4.564, sample: 0.764, forward: 1.490, backward: 0.620, update: 1.024
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.584 ms                  | 94.102 ms                 |
| Forward                   | 10.313 ms                 | 23.425 ms                 |
| Backward                  | 6.042 ms                  | 7.539 ms                  |
| Optimize                  | 9.881 ms                  | 23.250 ms                 |
| OneStep                   | 40.205 ms                 | 131.040 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 500 steps, total: 4.726, sample: 1.024, forward: 1.567, backward: 0.598, update: 1.112
[proc 3] 500 steps, total: 4.726, sample: 0.740, forward: 1.510, backward: 0.612, update: 1.004
[proc 0] 500 steps, total: 4.726, sample: 0.898, forward: 1.101, backward: 0.589, update: 1.053
[proc 2] 500 steps, total: 4.726, sample: 0.852, forward: 1.571, backward: 0.618, update: 1.034
Successfully xmh. training takes 25.40047788619995 seconds
before call kg_cache_controller.StopThreads()
