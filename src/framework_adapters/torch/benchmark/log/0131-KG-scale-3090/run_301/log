WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240210 07:43:44.130255 64210 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_161', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=5, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=5, gpu=[0, 1, 2, 3, 4], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='PySync', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [64210 sampler.py:454] Start PreSampling
WARNING [64210 sampler.py:532] Before construct renumbering_dict
WARNING [64210 sampler.py:555] PreSampling done
W20240210 08:04:08.415784 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240210 08:04:08.415977 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240210 08:04:08.416013 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240210 08:04:08.416082 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240210 08:04:08.416117 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240210 08:04:08.416148 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240210 08:04:08.416188 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240210 08:04:08.416234 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240210 08:04:08.416263 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240210 08:04:08.416301 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240210 08:04:08.416345 64210 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240210 08:04:08.416374 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240210 08:04:08.416401 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240210 08:04:08.416566 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240210 08:04:08.416616 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240210 08:04:08.416651 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240210 08:04:08.416690 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240210 08:04:08.416730 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240210 08:04:08.416759 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240210 08:04:08.416797 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240210 08:04:08.416829 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240210 08:04:08.416862 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240210 08:04:08.416899 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240210 08:04:08.416936 64210 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240210 08:04:08.416960 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240210 08:04:08.416990 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240210 08:04:08.417059 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240210 08:04:08.417090 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240210 08:04:08.417119 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240210 08:04:08.417155 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240210 08:04:08.417198 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240210 08:04:08.417227 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240210 08:04:08.417253 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240210 08:04:08.417281 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240210 08:04:08.417311 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240210 08:04:08.417341 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240210 08:04:08.417371 64210 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240210 08:04:08.417392 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240210 08:04:08.417418 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240210 08:04:08.417472 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240210 08:04:08.417500 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240210 08:04:08.417531 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240210 08:04:08.417559 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240210 08:04:08.417595 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240210 08:04:08.417630 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240210 08:04:08.417673 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240210 08:04:08.417706 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240210 08:04:08.417749 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240210 08:04:08.417776 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240210 08:04:08.417806 64210 IPCTensor.h:369] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240210 08:04:08.417829 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240210 08:04:08.417857 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240210 08:04:08.417913 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_0 [1000000]0x100013192000 7.629 MB
W20240210 08:04:08.417943 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_1 [1000000]0x100013935000 7.629 MB
W20240210 08:04:08.417977 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_2 [1000000]0x1000140d8000 7.629 MB
W20240210 08:04:08.418007 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_3 [1000000]0x10001487b000 7.629 MB
W20240210 08:04:08.418038 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_4 [1000000]0x10001501e000 7.629 MB
W20240210 08:04:08.418074 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_5 [1000000]0x1000157c1000 7.629 MB
W20240210 08:04:08.418110 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_6 [1000000]0x100015f64000 7.629 MB
W20240210 08:04:08.418139 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_7 [1000000]0x100016707000 7.629 MB
W20240210 08:04:08.418174 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_8 [1000000]0x100016eaa000 7.629 MB
W20240210 08:04:08.418205 64210 IPCTensor.h:369] NewIPCTensor: cached_sampler_r4_9 [1000000]0x10001764d000 7.629 MB
W20240210 08:04:08.418233 64210 IPCTensor.h:369] NewIPCTensor: step_r4 [10]0x100017df0000 80 B 
W20240210 08:04:08.418663 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r4 [1]0x100017df2000 8 B 
W20240210 08:04:08.418700 64210 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r4 [1]0x100017df4000 8 B 
W20240210 08:04:08.855701 64210 IPCTensor.h:369] NewIPCTensor: full_emb [86054151, 400]0x100017df6000 128.2 GB
W20240210 08:12:55.543345 64210 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [86054151]0x102026a2e000 328.3 MB
{0: Graph(num_nodes=20747160, num_edges=52627628,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=22453096, num_edges=82686155,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=19237572, num_edges=68187033,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=19123946, num_edges=82521325,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 4: Graph(num_nodes=24344931, num_edges=85060575,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 20747160 N 52627628 E
MertisPartition: part 1 has 22453096 N 82686155 E
MertisPartition: part 2 has 19237572 N 68187033 E
MertisPartition: part 3 has 19123946 N 82521325 E
MertisPartition: part 4 has 24344931 N 85060575 E
Rank0: cached key size 860541
Rank1: cached key size 860541
Rank2: cached key size 860541
Rank3: cached key size 860541
Rank4: cached key size 860541
Before renumbering graph:  {'_ID': tensor([     239,      240,      265,  ..., 86036354,  5226631, 86047326]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 1, 2])}
After renumbering graph:  {'_ID': tensor([ 4310055,  4310080,   572833,  ...,  2047151, 84211638, 76969475]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 1, 2])}
part_g: DGLGraph(num_nodes=20747160, num_edges=52627628,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=20747160, num_edges=52627628,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2263.520 seconds
[Rank1] pid = 38261
[Rank2] pid = 38529
[Rank3] pid = 38770
INFO [64210 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [38261 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [38529 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [38770 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [38529 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 5 nodes.
INFO [38261 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 5 nodes.
INFO [38770 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 5 nodes.
INFO [38984 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 4
INFO [38984 distributed_c10d.py:476] Rank 4: Completed store-based barrier for key:store_based_barrier_key:1 with 5 nodes.
W20240210 08:21:35.199764 38564 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_2 [4302707, 400]; dev=2; size=6.412 GB
W20240210 08:21:35.199887 38292 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [4302707, 400]; dev=1; size=6.412 GB
W20240210 08:21:35.200080 38792 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_3 [4302707, 400]; dev=3; size=6.412 GB
W20240210 08:21:35.203730 39078 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_4 [4302707, 400]; dev=4; size=6.412 GB
INFO [64210 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 5 nodes.
W20240210 08:21:35.207755 38988 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [4302707, 400]; dev=0; size=6.412 GB
W20240210 08:21:35.270785 38564 IPCTensor.h:369] NewIPCTensor: input_keys_2 [1000000]0x10203b27d000 7.629 MB
W20240210 08:21:35.270983 39078 IPCTensor.h:369] NewIPCTensor: input_keys_4 [1000000]0x10203ba22000 7.629 MB
W20240210 08:21:35.270996 38988 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x10203c1c5000 7.629 MB
W20240210 08:21:35.271011 38792 IPCTensor.h:369] NewIPCTensor: input_keys_3 [1000000]0x10203c968000 7.629 MB
W20240210 08:21:35.271026 38292 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x10203d10b000 7.629 MB
W20240210 08:21:35.271062 38564 IPCTensor.h:369] NewIPCTensor: input_keys_neg_2 [1000000]0x10203d8ae000 7.629 MB
W20240210 08:21:35.271145 38564 IPCTensor.h:369] NewIPCTensor: backward_grads_2 [1000000, 400]0x10203e051000 1.49 GB
W20240210 08:21:35.271250 38564 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x10209d634000 1.49 GB
W20240210 08:21:35.271337 38564 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240210 08:21:35.271353 38988 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x1020fcc17000 7.629 MB
W20240210 08:21:35.271430 39078 IPCTensor.h:369] NewIPCTensor: input_keys_neg_4 [1000000]0x1020fd3ba000 7.629 MB
W20240210 08:21:35.271456 38292 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x1020fdb5d000 7.629 MB
W20240210 08:21:35.271463 38988 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x1020feaa3000 1.49 GB
W20240210 08:21:35.271462 38792 IPCTensor.h:369] NewIPCTensor: input_keys_neg_3 [1000000]0x1020fe300000 7.629 MB
W20240210 08:21:35.271512 38988 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x10215e086000 1.49 GB
W20240210 08:21:35.271543 39078 IPCTensor.h:369] NewIPCTensor: backward_grads_4 [1000000, 400]0x1021bd669000 1.49 GB
W20240210 08:21:35.271585 38988 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240210 08:21:35.271591 38292 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x10221cc4c000 1.49 GB
W20240210 08:21:35.271631 38792 IPCTensor.h:369] NewIPCTensor: backward_grads_3 [1000000, 400]0x10227c22f000 1.49 GB
W20240210 08:21:35.271673 38292 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1022db812000 1.49 GB
W20240210 08:21:35.271781 38292 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240210 08:21:35.273236 39078 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_4 [1000000, 400]0x10233adf5000 1.49 GB
W20240210 08:21:35.273278 38792 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x10239a3d8000 1.49 GB
W20240210 08:21:35.273337 39078 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_4_gpu [1000000, 400]; dev=4; size=1.49 GB
W20240210 08:21:35.278290 38792 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240210 08:21:35.283454 38564 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240210 08:21:35.283666 38988 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240210 08:21:35.283731 38292 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240210 08:21:35.285542 39078 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_4_gpu [1000000, 400]; dev=4; size=1.49 GB
W20240210 08:21:35.290550 38792 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
cudaHostRegister 0x100017df6000
4: KnownLocalCachedEmbedding init done
WARNING [38984 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank4] pid = 38984
New CachedEmbedding, name=full_emb, shape=(86054151, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 4302707), (4302707, 8605414), (8605414, 12908121), (12908121, 17210828), (17210828, 21513535)]
cudaHostRegister 0x100017df6000
0: KnownLocalCachedEmbedding init done
WARNING [64210 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100017df6000
3: KnownLocalCachedEmbedding init done
WARNING [38770 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100017df6000
1: KnownLocalCachedEmbedding init done
WARNING [38261 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100017df6000
2: KnownLocalCachedEmbedding init done
WARNING [38529 DistTensor.py:59] The tensor name already exists in the kvstore
I20240210 08:22:13.200924 38564 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 5
I20240210 08:22:13.201192 38292 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 5
I20240210 08:22:13.201242 38792 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 5
I20240210 08:22:13.201323 38988 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 5
I20240210 08:22:13.201400 39078 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 5
E20240210 08:22:14.729496 38292 recstore.cc:66] init folly done
E20240210 08:22:14.729527 39078 recstore.cc:66] init folly done
E20240210 08:22:14.729534 38988 recstore.cc:66] init folly done
E20240210 08:22:14.729545 38792 recstore.cc:66] init folly done
E20240210 08:22:14.729547 38564 recstore.cc:66] init folly done
I20240210 08:22:22.895742 38988 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 5
I20240210 08:22:26.210980 38564 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 5
I20240210 08:22:26.949631 38792 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 5
I20240210 08:22:27.052453 38292 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 5
I20240210 08:22:27.923142 39078 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 5
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 21.899 ms                 | 21.899 ms                 |
| Forward                   | 572.102 ms                | 572.102 ms                |
| back: bucket keys         | 20.192 ms                 | 20.192 ms                 |
| back: a2a                 | 44.228 s                  | 44.228 s                  |
| back: cache               | 6.160 ms                  | 6.160 ms                  |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 10.371 ms                 | 191.423 ms                |
| Forward                   | 5.183 ms                  | 572.102 ms                |
| back: bucket keys         | 572.681 us                | 20.192 ms                 |
| back: a2a                 | 11.808 ms                 | 44.228 s                  |
| back: cache               | 6.160 ms                  | 69.357 ms                 |
| back: aggr dram keys      | 39.696 ms                 | 571.538 ms                |
| back: set dram grad       | 5.570 ms                  | 51.347 ms                 |
| Backward                  | 152.134 ms                | 45.178 s                  |
| Optimize                  | 61.116 ms                 | 75.810 ms                 |
| BarrierTimeBeforeRank0    | 52.185 us                 | 110.294 us                |
| BlockToStepN              | 25.720 us                 | 1.548 ms                  |
| OneStep                   | 236.561 ms                | 45.848 s                  |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 6.995 ms                  | 191.423 ms                |
| Forward                   | 5.019 ms                  | 572.102 ms                |
| back: bucket keys         | 509.262 us                | 1.173 ms                  |
| back: a2a                 | 11.876 ms                 | 30.876 ms                 |
| back: cache               | 6.160 ms                  | 52.165 ms                 |
| back: aggr dram keys      | 41.078 ms                 | 82.142 ms                 |
| back: set dram grad       | 5.504 ms                  | 19.652 ms                 |
| Backward                  | 165.686 ms                | 45.178 s                  |
| Optimize                  | 46.782 ms                 | 75.810 ms                 |
| BarrierTimeBeforeRank0    | 47.939 us                 | 110.294 us                |
| BlockToStepN              | 30.598 us                 | 14.814 ms                 |
| OneStep                   | 238.499 ms                | 45.848 s                  |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.084 ms                  | 129.764 ms                |
| Forward                   | 5.028 ms                  | 7.581 ms                  |
| back: bucket keys         | 509.262 us                | 1.173 ms                  |
| back: a2a                 | 12.029 ms                 | 43.720 ms                 |
| back: cache               | 6.160 ms                  | 65.420 ms                 |
| back: aggr dram keys      | 41.487 ms                 | 82.142 ms                 |
| back: set dram grad       | 5.511 ms                  | 48.759 ms                 |
| Backward                  | 177.846 ms                | 242.307 ms                |
| Optimize                  | 47.121 ms                 | 75.810 ms                 |
| BarrierTimeBeforeRank0    | 46.061 us                 | 87.645 us                 |
| BlockToStepN              | 43.552 us                 | 13.549 ms                 |
| OneStep                   | 239.961 ms                | 384.627 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.547 ms                  | 129.764 ms                |
| Forward                   | 4.960 ms                  | 25.586 ms                 |
| back: bucket keys         | 499.010 us                | 1.118 ms                  |
| back: a2a                 | 12.095 ms                 | 43.720 ms                 |
| back: cache               | 11.176 ms                 | 52.165 ms                 |
| back: aggr dram keys      | 41.435 ms                 | 70.286 ms                 |
| back: set dram grad       | 5.511 ms                  | 19.652 ms                 |
| Backward                  | 177.559 ms                | 242.307 ms                |
| Optimize                  | 46.760 ms                 | 77.106 ms                 |
| BarrierTimeBeforeRank0    | 41.747 us                 | 87.645 us                 |
| BlockToStepN              | 44.209 us                 | 13.549 ms                 |
| OneStep                   | 239.456 ms                | 384.627 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.547 ms                  | 129.764 ms                |
| Forward                   | 4.940 ms                  | 25.586 ms                 |
| back: bucket keys         | 495.434 us                | 1.118 ms                  |
| back: a2a                 | 12.013 ms                 | 43.720 ms                 |
| back: cache               | 11.176 ms                 | 52.165 ms                 |
| back: aggr dram keys      | 42.098 ms                 | 72.545 ms                 |
| back: set dram grad       | 5.504 ms                  | 19.652 ms                 |
| Backward                  | 177.350 ms                | 242.307 ms                |
| Optimize                  | 46.648 ms                 | 77.106 ms                 |
| BarrierTimeBeforeRank0    | 40.826 us                 | 87.645 us                 |
| BlockToStepN              | 43.798 us                 | 14.814 ms                 |
| OneStep                   | 238.190 ms                | 384.627 ms                |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 4] 100 steps, total: 70.572, sample: 1.358, forward: 1.041, backward: 57.590, update: 0.476
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 72.285, sample: 1.346, forward: 1.039, backward: 57.528, update: 0.471
train_sampler.Prefill()
-------Step 0-------
tensor([ 4313217,   334282,   791484,   334327,   334379,   334421,   791505,
          334475, 27605658,   791523]) tensor([ 7998215, 21882125,   745028, 85466780,   486509, 30574332, 56045907,
        44329842, 78376405, 65169605])
-------Step 1-------
tensor([ 4313217,   334282,   791484,   334327,   334379,   334421,   791505,
          334475, 27605658,   791523]) tensor([75734028, 46541325, 17956506, 35529272, 32352975,   202638, 29246346,
        83757153,  5636493, 40199090])
-------Step 2-------
tensor([  439766,   439807,   439837,   439879, 16922660, 61398481,   439937,
          439977,   440033,   440068]) tensor([59924436, 15871703, 12250486,  4318444, 33855219, 49991772, 66427308,
        65131204, 16477867, 59263521])
-------Step 3-------
tensor([  439766,   439807,   439837,   439879, 16922660, 61398481,   439937,
          439977,   440033,   440068]) tensor([ 8171304, 12099893, 56755592, 72666390, 27192508, 78126105, 20876570,
           21162, 58467544, 29021148])
-------Step 4-------
tensor([20850000,   542496,   542532,   542580,   542619,   542664,   542698,
          334661,   542731,   542770]) tensor([54134051, 43504478, 82998784, 19895451, 55016234, 65569773, 69681991,
        66575119, 47021370, 71095748])
-------Step 5-------
tensor([20850000,   542496,   542532,   542580,   542619,   542664,   542698,
          334661,   542731,   542770]) tensor([75202953, 60461805, 13292105, 67196238, 12354049, 34127872, 62734081,
        79421295, 71473908, 12493971])
-------Step 6-------
tensor([  640585, 15734492,   640614,   640652,   640685,   808395,   640718,
          808416,   640748,   640781]) tensor([ 9984822, 20770708, 68663360,    97591,  9930203, 43290363, 58745004,
        70263012, 70780861, 46289784])
-------Step 7-------
tensor([  640585, 15734492,   640614,   640652,   640685,   808395,   640718,
          808416,   640748,   640781]) tensor([ 3812733, 17006118, 71489323, 47211127, 20487912, 43040053, 26004493,
        41863398, 10450450,  5878145])
-------Step 8-------
tensor([ 4983007,   695639,  4313217,   695665,   695685,   695706,   695726,
          695745,   695771, 64635253]) tensor([15764677, 62069796, 51365333, 44457047, 38472155,  1372188, 41882602,
          230361, 40058895, 63487332])
-------Step 9-------
tensor([ 4983007,   695639,  4313217,   695665,   695685,   695706,   695726,
          695745,   695771, 64635253]) tensor([72874651, 79847788, 27934125, 78111581, 16621928, 41670561, 32703856,
        74975916, 68689051,   180230])
before start barrier
start train
[proc 0] 100 steps, total: 75.600, sample: 1.639, forward: 1.078, backward: 62.654, update: 5.056
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 71.546, sample: 1.361, forward: 1.095, backward: 57.518, update: 0.413
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 71.443, sample: 1.438, forward: 1.034, backward: 57.454, update: 0.480
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.331 ms                  | 129.764 ms                |
| Forward                   | 4.984 ms                  | 25.586 ms                 |
| back: bucket keys         | 480.890 us                | 1.118 ms                  |
| back: a2a                 | 12.101 ms                 | 43.720 ms                 |
| back: cache               | 11.176 ms                 | 52.165 ms                 |
| back: aggr dram keys      | 41.736 ms                 | 72.545 ms                 |
| back: set dram grad       | 5.480 ms                  | 19.652 ms                 |
| Backward                  | 174.771 ms                | 242.307 ms                |
| Optimize                  | 46.512 ms                 | 77.106 ms                 |
| BarrierTimeBeforeRank0    | 40.447 us                 | 87.645 us                 |
| BlockToStepN              | 43.798 us                 | 16.576 ms                 |
| OneStep                   | 236.639 ms                | 384.627 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.777 ms                  | 129.764 ms                |
| Forward                   | 5.002 ms                  | 25.586 ms                 |
| back: bucket keys         | 480.890 us                | 1.112 ms                  |
| back: a2a                 | 12.136 ms                 | 37.597 ms                 |
| back: cache               | 28.946 ms                 | 55.028 ms                 |
| back: aggr dram keys      | 41.273 ms                 | 70.286 ms                 |
| back: set dram grad       | 5.480 ms                  | 19.652 ms                 |
| Backward                  | 173.416 ms                | 242.307 ms                |
| Optimize                  | 46.250 ms                 | 77.106 ms                 |
| BarrierTimeBeforeRank0    | 39.858 us                 | 87.645 us                 |
| BlockToStepN              | 43.552 us                 | 16.576 ms                 |
| OneStep                   | 236.344 ms                | 384.627 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.721 ms                  | 111.301 ms                |
| Forward                   | 4.981 ms                  | 7.581 ms                  |
| back: bucket keys         | 521.421 us                | 1.295 ms                  |
| back: a2a                 | 12.165 ms                 | 37.597 ms                 |
| back: cache               | 28.946 ms                 | 55.028 ms                 |
| back: aggr dram keys      | 41.036 ms                 | 70.286 ms                 |
| back: set dram grad       | 5.488 ms                  | 19.652 ms                 |
| Backward                  | 171.238 ms                | 235.673 ms                |
| Optimize                  | 46.250 ms                 | 75.810 ms                 |
| BarrierTimeBeforeRank0    | 39.601 us                 | 72.056 us                 |
| BlockToStepN              | 43.258 us                 | 16.154 ms                 |
| OneStep                   | 233.200 ms                | 352.577 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.777 ms                  | 111.301 ms                |
| Forward                   | 4.981 ms                  | 7.581 ms                  |
| back: bucket keys         | 527.620 us                | 1.293 ms                  |
| back: a2a                 | 12.165 ms                 | 37.458 ms                 |
| back: cache               | 28.946 ms                 | 54.897 ms                 |
| back: aggr dram keys      | 40.790 ms                 | 70.071 ms                 |
| back: set dram grad       | 5.488 ms                  | 19.277 ms                 |
| Backward                  | 168.697 ms                | 235.673 ms                |
| Optimize                  | 46.214 ms                 | 75.810 ms                 |
| BarrierTimeBeforeRank0    | 39.696 us                 | 72.312 us                 |
| BlockToStepN              | 40.011 us                 | 16.154 ms                 |
| OneStep                   | 231.466 ms                | 352.577 ms                |
+---------------------------+---------------------------+---------------------------+
Successfully xmh. training takes 96.25729894638062 seconds
before call kg_cache_controller.StopThreads()
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
INFO [64210 controller_process.py:421] call rank0 to StopThreads
