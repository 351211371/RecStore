WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240207 03:07:41.584619 45699 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_Freebase_24', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [45699 sampler.py:454] Start PreSampling
WARNING [45699 sampler.py:532] Before construct renumbering_dict
WARNING [45699 sampler.py:555] PreSampling done
W20240207 03:26:28.148774 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240207 03:26:28.148977 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240207 03:26:28.149014 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240207 03:26:28.149048 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240207 03:26:28.149070 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240207 03:26:28.149094 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240207 03:26:28.149118 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240207 03:26:28.149149 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240207 03:26:28.149168 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240207 03:26:28.149194 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240207 03:26:28.149220 45699 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240207 03:26:28.149240 45699 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240207 03:26:28.149257 45699 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240207 03:26:28.149413 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240207 03:26:28.149441 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240207 03:26:28.149464 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240207 03:26:28.149497 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240207 03:26:28.149518 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240207 03:26:28.149534 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240207 03:26:28.149555 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240207 03:26:28.149592 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240207 03:26:28.149612 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240207 03:26:28.149636 45699 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240207 03:26:28.149672 45699 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240207 03:26:28.149686 45699 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240207 03:26:28.149703 45699 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240207 03:26:28.536974 45699 IPCTensor.h:369] NewIPCTensor: full_emb [86054151, 400]0x1000098ca000 128.2 GB
W20240207 03:29:24.259071 45699 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [86054151]0x102018502000 328.3 MB
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2151353
Rank1: cached key size 2151353
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4302713,  4302742,   522311,  ..., 21082260, 37859790, 57046118]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1468.596 seconds
INFO [45699 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [46490 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [45699 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [46490 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
W20240207 03:32:12.992683 46491 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [4302707, 400]; dev=0; size=6.412 GB
W20240207 03:32:12.994100 46554 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [4302707, 400]; dev=1; size=6.412 GB
W20240207 03:32:13.034912 46491 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x10202cd4d000 7.629 MB
W20240207 03:32:13.034935 46554 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x10202d4f0000 7.629 MB
W20240207 03:32:13.035118 46491 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x10202dc93000 7.629 MB
W20240207 03:32:13.035144 46554 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x10202e436000 7.629 MB
W20240207 03:32:13.035209 46491 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x10202ebd9000 1.49 GB
W20240207 03:32:13.035226 46554 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x10208e1bc000 1.49 GB
W20240207 03:32:13.035244 46491 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x1020ed79f000 1.49 GB
W20240207 03:32:13.035277 46554 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x10214cd82000 1.49 GB
W20240207 03:32:13.035295 46491 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240207 03:32:13.035383 46554 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240207 03:32:13.038494 46491 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240207 03:32:13.038549 46554 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
cudaHostRegister 0x1000098ca000
1: KnownLocalCachedEmbedding init done
WARNING [46490 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank1] pid = 46490
New CachedEmbedding, name=full_emb, shape=(86054151, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 4302707), (4302707, 8605414)]
cudaHostRegister 0x1000098ca000
0: KnownLocalCachedEmbedding init done
WARNING [45699 DistTensor.py:59] The tensor name already exists in the kvstore
I20240207 03:32:36.240514 46491 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 2
I20240207 03:32:36.240659 46554 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 2
W20240207 03:32:36.241844 46491 grad_base.h:55] KGCacheController, config={
        "num_gpus": 2,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240207 03:32:36.241962 46491 grad_base.h:184] Init GradProcessingBase done
I20240207 03:32:49.318846 46491 grad_async_v2.h:42] Use main thread to update emb.
W20240207 03:32:49.319108 46491 kg_controller.h:78] after init GradAsyncProcessingV2
I20240207 03:32:49.319119 46491 kg_controller.h:84] Construct KGCacheController done
E20240207 03:32:50.564193 46554 recstore.cc:66] init folly done
E20240207 03:32:50.564332 46491 recstore.cc:66] init folly done
I20240207 03:32:50.565191 46491 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240207 03:33:04.181798 46772 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240207 03:33:04.182122 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240207 03:33:05.415863 46772 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240207 03:33:05.416082 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 137.152 us                | 316.077 us                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 137.152 us                | 316.077 us                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 137.152 us                | 316.077 us                |
+---------------------------+---------------------------+---------------------------+
W20240207 03:33:15.791594 46772 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240207 03:33:15.806133 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240207 03:33:15.974033 46554 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
W20240207 03:33:18.624339 46772 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240207 03:33:18.640152 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240207 03:33:18.691273 46491 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
E20240207 03:33:19.676339 46491 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240207 03:33:19.730445 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=1, pq.top=1
W20240207 03:33:19.735477 46772 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240207 03:33:20.408239 46491 grad_async_v2.h:257] pq is empty
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 168.182 us                | 971.302 us                |
| ProcessBack:Shuffle       | 835.031 us                | 41.619 ms                 |
| ProcessBack:UpdateCache   | 779.423 us                | 79.240 ms                 |
| ProcessBack:UpsertPq      | 17.785 ms                 | 53.887 ms                 |
| ProcessOneStep            | 27.782 ms                 | 202.870 ms                |
| BlockToStepN              | 107.284 us                | 832.291 us                |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:20.676029 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=90
W20240207 03:33:20.747051 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=13, pq.top=13
W20240207 03:33:20.805627 46772 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end4
E20240207 03:33:21.058482 46673 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=18, sample_step_cpp_seen_[rank]=17
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 15.686 ms                 | 161.134 ms                |
| Forward                   | 4.988 ms                  | 575.104 ms                |
| Backward                  | 4.869 ms                  | 204.422 ms                |
| Optimize                  | 1.957 ms                  | 44.662 ms                 |
| BarrierTimeBeforeRank0    | 36.522 us                 | 17.414 ms                 |
| AfterBackward             | 24.487 ms                 | 203.112 ms                |
| BlockToStepN              | 339.570 us                | 3.920 ms                  |
| OneStep                   | 74.399 ms                 | 1.040 s                   |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:21.676012 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=3
W20240207 03:33:21.826359 46772 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end3
W20240207 03:33:22.200887 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=29, pq.top=29
E20240207 03:33:22.676017 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=686
W20240207 03:33:23.043282 46772 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end9
W20240207 03:33:23.400872 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=45, pq.top=45
E20240207 03:33:23.676010 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=72
W20240207 03:33:24.098673 46772 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end4
W20240207 03:33:24.497128 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=59, pq.top=59
E20240207 03:33:24.676009 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=193
W20240207 03:33:25.132720 46772 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end1
W20240207 03:33:25.517078 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=80, pq.top=80
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 333.592 us                | 2.476 ms                  |
| ProcessBack:Shuffle       | 831.130 us                | 2.333 ms                  |
| ProcessBack:UpdateCache   | 745.056 us                | 1.047 ms                  |
| ProcessBack:UpsertPq      | 10.554 ms                 | 42.968 ms                 |
| ProcessOneStep            | 22.527 ms                 | 369.718 ms                |
| BlockToStepN              | 262.234 us                | 3.868 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:25.676012 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=4465
W20240207 03:33:26.156980 46772 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end8
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 10.914 ms                 | 128.970 ms                |
| Forward                   | 5.110 ms                  | 8.842 ms                  |
| Backward                  | 4.787 ms                  | 7.609 ms                  |
| Optimize                  | 2.109 ms                  | 5.237 ms                  |
| BarrierTimeBeforeRank0    | 28.848 us                 | 12.714 ms                 |
| AfterBackward             | 23.889 ms                 | 369.759 ms                |
| BlockToStepN              | 335.168 us                | 3.920 ms                  |
| OneStep                   | 52.369 ms                 | 483.027 ms                |
+---------------------------+---------------------------+---------------------------+
W20240207 03:33:26.539659 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=97, pq.top=97
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 10.653, sample: 1.922, forward: 0.914, backward: 0.677, update: 0.236
train_sampler.Prefill()
-------Step 0-------
tensor([1500511, 1500553, 1500597, 1148654, 1500628, 1500672, 1500711,   15583,
        1500742, 1500787]) tensor([  237697,  4708084, 15054952, 39841195, 29412848, 19237692, 78856806,
         7728264, 36958381, 52462684])
-------Step 1-------
tensor([1500511, 1500553, 1500597, 1148654, 1500628, 1500672, 1500711,   15583,
        1500742, 1500787]) tensor([57317567, 52669506, 76017547, 33678846, 34902401,   160828, 24833630,
        44638343, 61437362, 81456477])
-------Step 2-------
tensor([1604299, 1604329, 1604381, 1604415, 1604450, 1604486, 1604535, 1604565,
        1155645, 1604595]) tensor([15045481, 13421420, 33607108, 78241208, 29143944,  1515264, 45799873,
        40354409, 53029993, 11364366])
-------Step 3-------
tensor([1604299, 1604329, 1604381, 1604415, 1604450, 1604486, 1604535, 1604565,
        1155645, 1604595]) tensor([39586234, 83097923,  2338065, 23242633, 43824979, 51755081, 27368953,
        57265157, 66467236, 26425141])
-------Step 4-------
tensor([ 1712861,  1712910,   207647,  1712941,   207683, 65745303,   846091,
         1712994,  1713027,  1713068]) tensor([  876575, 63917022, 30075622, 29463384, 68270474, 44967877, 43199754,
        25448680, 21971160, 32148028])
-------Step 5-------
tensor([ 1712861,  1712910,   207647,  1712941,   207683, 65745303,   846091,
         1712994,  1713027,  1713068]) tensor([42721796, 31788821, 68817336, 14280744, 27304227, 77930756, 62453062,
        12875480, 72483642, 84997955])
-------Step 6-------
tensor([ 1821216,  1821246,  1821291,   368466,  1821321,  1821354,  1821393,
        13077083,  1821418,  4326460]) tensor([17303115, 26757413,  6452411,  1184034, 14856299, 19537753,  2753134,
         1383894, 67814983, 18760145])
-------Step 7-------
tensor([ 1821216,  1821246,  1821291,   368466,  1821321,  1821354,  1821393,
        13077083,  1821418,  4326460]) tensor([56314327, 56596695, 72312439,  1588045,  8278081, 32352689, 77883205,
        65308518, 74434166, 11324948])
-------Step 8-------
tensor([1875525, 1875542, 1875555,  370800, 1875570, 1875584, 1875600,  209615,
        1875616, 1875629]) tensor([66991245, 78909686,   357597,  4348641, 35443030, 24878215, 73722725,
        62426188, 46985852, 21099581])
-------Step 9-------
tensor([1875525, 1875542, 1875555,  370800, 1875570, 1875584, 1875600,  209615,
        1875616, 1875629]) tensor([  494485, 32297496, 24481675, 55787599, 40002529,  1750342, 24258772,
        31767440, 32507183, 81400421])
before start barrier
start train
[proc 0] 100 steps, total: 7.936, sample: 2.187, forward: 1.072, backward: 0.672, update: 0.261
E20240207 03:33:26.676010 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=9128
E20240207 03:33:26.915007 46673 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=104, sample_step_cpp_seen_[rank]=103
W20240207 03:33:27.285681 46772 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end1
W20240207 03:33:27.618703 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=117, pq.top=117
E20240207 03:33:27.676015 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=114
W20240207 03:33:28.506184 46772 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end6
E20240207 03:33:28.676007 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=327
W20240207 03:33:29.240761 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=151, pq.top=151
W20240207 03:33:29.529307 46772 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end5
E20240207 03:33:29.676007 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=272
W20240207 03:33:30.264581 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=169, pq.top=169
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 313.934 us                | 6.493 ms                  |
| ProcessBack:Shuffle       | 811.481 us                | 2.245 ms                  |
| ProcessBack:UpdateCache   | 712.385 us                | 998.500 us                |
| ProcessBack:UpsertPq      | 11.635 ms                 | 34.467 ms                 |
| ProcessOneStep            | 20.638 ms                 | 324.229 ms                |
| BlockToStepN              | 354.080 us                | 6.311 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:30.676008 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=2481
W20240207 03:33:30.702960 46772 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.047 ms                  | 122.421 ms                |
| Forward                   | 4.654 ms                  | 7.686 ms                  |
| Backward                  | 4.792 ms                  | 10.731 ms                 |
| Optimize                  | 2.050 ms                  | 5.493 ms                  |
| BarrierTimeBeforeRank0    | 27.460 us                 | 17.414 ms                 |
| AfterBackward             | 20.478 ms                 | 324.452 ms                |
| BlockToStepN              | 400.945 us                | 6.361 ms                  |
| OneStep                   | 40.921 ms                 | 388.294 ms                |
+---------------------------+---------------------------+---------------------------+
W20240207 03:33:31.334934 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=191, pq.top=191
E20240207 03:33:31.676012 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=281
W20240207 03:33:31.719872 46772 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
[proc 0] 200 steps, total: 5.399, sample: 1.035, forward: 0.433, backward: 0.606, update: 0.213
[proc 1] 200 steps, total: 5.400, sample: 1.053, forward: 0.462, backward: 0.665, update: 0.193
W20240207 03:33:32.384835 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=209, pq.top=209
E20240207 03:33:32.470430 46673 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=211, sample_step_cpp_seen_[rank]=210
E20240207 03:33:32.676007 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=4732
W20240207 03:33:32.738751 46772 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end4
W20240207 03:33:33.469931 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=227, pq.top=227
E20240207 03:33:33.676010 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=1022
W20240207 03:33:33.835033 46772 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240207 03:33:34.596515 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=245, pq.top=245
E20240207 03:33:34.676012 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=18586
W20240207 03:33:34.861420 46772 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end8
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 289.886 us                | 8.542 ms                  |
| ProcessBack:Shuffle       | 805.583 us                | 2.325 ms                  |
| ProcessBack:UpdateCache   | 714.823 us                | 1.004 ms                  |
| ProcessBack:UpsertPq      | 10.849 ms                 | 40.658 ms                 |
| ProcessOneStep            | 20.507 ms                 | 251.264 ms                |
| BlockToStepN              | 503.839 us                | 6.016 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:35.676008 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=769
W20240207 03:33:35.818046 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=263, pq.top=263
W20240207 03:33:35.891961 46772 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.336 ms                  | 121.750 ms                |
| Forward                   | 4.654 ms                  | 7.686 ms                  |
| Backward                  | 4.824 ms                  | 10.731 ms                 |
| Optimize                  | 2.046 ms                  | 5.237 ms                  |
| BarrierTimeBeforeRank0    | 33.739 us                 | 31.026 ms                 |
| AfterBackward             | 20.532 ms                 | 251.303 ms                |
| BlockToStepN              | 589.916 us                | 6.069 ms                  |
| OneStep                   | 42.235 ms                 | 346.051 ms                |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:36.676012 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=306
W20240207 03:33:36.837275 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=284, pq.top=284
W20240207 03:33:37.195399 46772 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
E20240207 03:33:37.676029 46805 parallel_pq_v2.h:79] insert failed, size(hashtable)=14462
[proc 1] 300 steps, total: 5.773, sample: 1.248, forward: 0.464, backward: 0.692, update: 0.221
[proc 0] 300 steps, total: 5.773, sample: 0.905, forward: 0.492, backward: 0.551, update: 0.216
W20240207 03:33:37.841493 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=301, pq.top=301
W20240207 03:33:38.364850 46772 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end1
E20240207 03:33:38.604631 46673 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=317, sample_step_cpp_seen_[rank]=316
E20240207 03:33:38.676007 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=11900
W20240207 03:33:38.863287 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=323, pq.top=323
W20240207 03:33:39.656208 46772 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
E20240207 03:33:39.676013 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=13
W20240207 03:33:40.198762 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=345, pq.top=345
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 351.621 us                | 8.399 ms                  |
| ProcessBack:Shuffle       | 800.710 us                | 2.362 ms                  |
| ProcessBack:UpdateCache   | 694.699 us                | 998.500 us                |
| ProcessBack:UpsertPq      | 10.264 ms                 | 42.476 ms                 |
| ProcessOneStep            | 20.507 ms                 | 247.022 ms                |
| BlockToStepN              | 722.455 us                | 14.187 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:40.676010 46491 parallel_pq_v2.h:79] insert failed, size(hashtable)=105
W20240207 03:33:40.935755 46772 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end7
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.095 ms                  | 115.627 ms                |
| Forward                   | 4.668 ms                  | 6.869 ms                  |
| Backward                  | 4.792 ms                  | 10.731 ms                 |
| Optimize                  | 2.046 ms                  | 5.139 ms                  |
| BarrierTimeBeforeRank0    | 47.215 us                 | 38.642 ms                 |
| AfterBackward             | 20.532 ms                 | 247.052 ms                |
| BlockToStepN              | 775.304 us                | 14.243 ms                 |
| OneStep                   | 43.619 ms                 | 268.418 ms                |
+---------------------------+---------------------------+---------------------------+
W20240207 03:33:41.373667 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=363, pq.top=363
E20240207 03:33:41.676028 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=72582
W20240207 03:33:41.996549 46772 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end5
W20240207 03:33:42.429145 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=379, pq.top=379
E20240207 03:33:42.677472 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=49
W20240207 03:33:43.010660 46772 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
E20240207 03:33:43.677009 46491 parallel_pq_v2.h:79] insert failed, size(hashtable)=455
W20240207 03:33:43.876212 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=397, pq.top=397
[proc 0] 400 steps, total: 6.192, sample: 1.668, forward: 0.491, backward: 0.475, update: 0.229
[proc 1] 400 steps, total: 6.192, sample: 1.537, forward: 0.455, backward: 0.506, update: 0.188
W20240207 03:33:44.135321 46772 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end3
E20240207 03:33:44.595345 46673 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=408, sample_step_cpp_seen_[rank]=407
E20240207 03:33:44.679944 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240207 03:33:45.117157 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=415, pq.top=415
W20240207 03:33:45.173908 46772 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end7
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 273.701 us                | 9.961 ms                  |
| ProcessBack:Shuffle       | 804.975 us                | 2.559 ms                  |
| ProcessBack:UpdateCache   | 681.269 us                | 998.500 us                |
| ProcessBack:UpsertPq      | 10.383 ms                 | 46.199 ms                 |
| ProcessOneStep            | 20.452 ms                 | 262.358 ms                |
| BlockToStepN              | 766.481 us                | 16.632 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:45.679013 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=807
W20240207 03:33:46.128166 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=432, pq.top=432
W20240207 03:33:46.220348 46772 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end5
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.272 ms                  | 128.970 ms                |
| Forward                   | 4.747 ms                  | 7.686 ms                  |
| Backward                  | 4.761 ms                  | 10.731 ms                 |
| Optimize                  | 2.100 ms                  | 5.237 ms                  |
| BarrierTimeBeforeRank0    | 30.123 us                 | 38.642 ms                 |
| AfterBackward             | 20.423 ms                 | 262.396 ms                |
| BlockToStepN              | 837.463 us                | 21.302 ms                 |
| OneStep                   | 44.324 ms                 | 341.156 ms                |
+---------------------------+---------------------------+---------------------------+
E20240207 03:33:46.679013 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=2649
W20240207 03:33:47.174355 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=451, pq.top=451
W20240207 03:33:47.337129 46772 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end3
E20240207 03:33:47.679014 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=290
W20240207 03:33:48.202453 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=467, pq.top=467
W20240207 03:33:48.471212 46772 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end1
E20240207 03:33:48.679008 46772 parallel_pq_v2.h:79] insert failed, size(hashtable)=11147
W20240207 03:33:49.384883 46491 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=487, pq.top=487
W20240207 03:33:49.557242 46772 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end9
E20240207 03:33:49.679052 46491 parallel_pq_v2.h:79] insert failed, size(hashtable)=29
[proc 1] 500 steps, total: 6.047, sample: 1.081, forward: 0.500, backward: 0.501, update: 0.210
[proc 0] 500 steps, total: 6.047, sample: 1.998, forward: 0.524, backward: 0.522, update: 0.250
Successfully xmh. training takes 31.34700036048889 seconds
before call kg_cache_controller.StopThreads()
W20240207 03:33:50.038383 46491 grad_async_v2.h:84] call StopThreads. PID = 45699
W20240207 03:33:50.038417 46491 grad_base.h:212] before processOneStepNegThread_.join();
W20240207 03:33:50.038841 46491 grad_base.h:214] after processOneStepNegThread_.join();
W20240207 03:33:50.038857 46491 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
W20240207 03:33:50.241719 46491 grad_async_v2.h:105] StopThreads done.
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 389.028 us                | 15.983 ms                 |
| ProcessBack:Shuffle       | 813.099 us                | 2.611 ms                  |
| ProcessBack:UpdateCache   | 670.968 us                | 1.010 ms                  |
| ProcessBack:UpsertPq      | 9.898 ms                  | 42.476 ms                 |
| ProcessOneStep            | 20.394 ms                 | 251.264 ms                |
| BlockToStepN              | 962.165 us                | 21.864 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.336 ms                  | 125.357 ms                |
| Forward                   | 4.851 ms                  | 7.686 ms                  |
| Backward                  | 4.847 ms                  | 11.248 ms                 |
| Optimize                  | 2.140 ms                  | 5.311 ms                  |
| BarrierTimeBeforeRank0    | 29.266 us                 | 37.093 ms                 |
| AfterBackward             | 20.423 ms                 | 251.303 ms                |
| BlockToStepN              | 1.029 ms                  | 21.927 ms                 |
| OneStep                   | 45.150 ms                 | 286.785 ms                |
+---------------------------+---------------------------+---------------------------+
