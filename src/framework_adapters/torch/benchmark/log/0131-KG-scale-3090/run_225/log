WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240207 04:51:00.151721 59141 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_Freebase_27', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [59141 sampler.py:454] Start PreSampling
WARNING [59141 sampler.py:532] Before construct renumbering_dict
WARNING [59141 sampler.py:555] PreSampling done
W20240207 05:09:40.619417 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240207 05:09:40.619627 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240207 05:09:40.619671 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240207 05:09:40.619704 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240207 05:09:40.619731 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240207 05:09:40.619760 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240207 05:09:40.619794 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240207 05:09:40.619840 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240207 05:09:40.619889 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240207 05:09:40.619925 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240207 05:09:40.619961 59141 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240207 05:09:40.619990 59141 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240207 05:09:40.620018 59141 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240207 05:09:40.620208 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240207 05:09:40.620257 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240207 05:09:40.620293 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240207 05:09:40.620337 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240207 05:09:40.620363 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240207 05:09:40.620400 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240207 05:09:40.620429 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240207 05:09:40.620461 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240207 05:09:40.620491 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240207 05:09:40.620519 59141 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240207 05:09:40.620546 59141 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240207 05:09:40.620569 59141 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240207 05:09:40.620591 59141 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2151353
Rank1: cached key size 2151353
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4302740,  4302764,   760708,  ..., 27166629, 27618136, 70703424]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1727.904 seconds
INFO [59141 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [59141 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [60136 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [60136 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
E20240207 05:19:50.215010 60137 recstore.cc:66] init folly done
E20240207 05:19:50.215019 60202 recstore.cc:66] init folly done
I20240207 05:20:15.286636 60137 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
I20240207 05:20:17.249475 60202 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 12.523 ms                 | 149.230 ms                |
| Forward                   | 9.142 ms                  | 421.599 ms                |
| Backward                  | 6.755 ms                  | 193.490 ms                |
| Optimize                  | 9.312 ms                  | 52.109 ms                 |
| OneStep                   | 47.160 ms                 | 679.058 ms                |
+---------------------------+---------------------------+---------------------------+
[Rank1] pid = 60136
train_sampler.Prefill()
-------Step 0-------
tensor([1165728, 1165755, 1165801, 1668457, 1165837, 1165868, 1165893,   18150,
        1165929, 1165963]) tensor([  169560,  4610853, 19170773, 53637033, 38373207, 17696523, 64633288,
         9069720, 50431355, 61151574])
-------Step 1-------
tensor([1165728, 1165755, 1165801, 1668457, 1165837, 1165868, 1165893,   18150,
        1165929, 1165963]) tensor([74045210, 70403464, 59222446, 42021613, 47351352,   183051, 32223128,
        58967031, 81923912, 83773332])
-------Step 2-------
tensor([1244639, 1244661, 1244686, 1244708, 1244729, 1244753, 1244779, 1244807,
        1678410, 1244844]) tensor([18349481, 14665627, 37187361, 66527398, 36312064,  2018479, 42055076,
        54096657, 68604285, 14283340])
-------Step 3-------
tensor([1244639, 1244661, 1244686, 1244708, 1244729, 1244753, 1244779, 1244807,
        1678410, 1244844]) tensor([51926848, 85541946,  2313645, 27643235, 57578494, 46075619, 35577603,
        45530134, 54118386, 23040300])
-------Step 4-------
tensor([ 1324460,  1324496,   300073,  1324517,   300126, 58179408,  1296651,
         1324543,  1324562,  1324599]) tensor([  784089, 83612548, 25815066, 39178986, 77960724, 60152425, 46983209,
        28308433, 26437549, 37865616])
-------Step 5-------
tensor([ 1324460,  1324496,   300073,  1324517,   300126, 58179408,  1296651,
         1324543,  1324562,  1324599]) tensor([46434864, 40335909, 60816781, 18501863, 23442969, 74080472, 46523013,
        12230721, 59171839, 78816583])
-------Step 6-------
tensor([ 1401537,  1401562,  1401585,   528383,  1401616,  1401651,  1401680,
        15737955,  1401698,  4331661]) tensor([16033575, 34723007,  6444769,  1489579, 17766630, 15528864,  2796163,
         1713606, 75718737, 20059777])
-------Step 7-------
tensor([ 1401537,  1401562,  1401585,   528383,  1401616,  1401651,  1401680,
        15737955,  1401698,  4331661]) tensor([73467409, 76088166, 66106563,  2035995,  8571142, 40739300, 66552478,
        83649016, 67759626,  8914962])
-------Step 8-------
tensor([1478805, 1478837, 1478877,  531816, 1478895, 1478925, 1478957,  303015,
        1478977, 1478996]) tensor([74539034, 80902670,   375938,  4358417, 48086793, 33132257, 64011733,
        82076012, 39020879, 27189925])
-------Step 9-------
tensor([1478805, 1478837, 1478877,  531816, 1478895, 1478925, 1478957,  303015,
        1478977, 1478996]) tensor([  602084, 40686044, 19973524, 69952634, 31232414,  1599289, 19471930,
        41580434, 25306352, 64313250])
before start barrier
start train
[proc 0] 100 steps, total: 5.885, sample: 1.705, forward: 1.417, backward: 0.851, update: 0.963
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 7.848, sample: 1.428, forward: 2.183, backward: 0.844, update: 1.178
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 7.787 ms                  | 108.955 ms                |
| Forward                   | 9.337 ms                  | 42.810 ms                 |
| Backward                  | 6.795 ms                  | 19.143 ms                 |
| Optimize                  | 9.169 ms                  | 19.540 ms                 |
| OneStep                   | 42.328 ms                 | 174.232 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 4.759, sample: 1.073, forward: 1.586, backward: 0.693, update: 1.089
[proc 0] 200 steps, total: 4.759, sample: 1.279, forward: 1.014, backward: 0.683, update: 1.048
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.444 ms                  | 98.411 ms                 |
| Forward                   | 9.349 ms                  | 39.183 ms                 |
| Backward                  | 6.825 ms                  | 13.113 ms                 |
| Optimize                  | 9.285 ms                  | 19.540 ms                 |
| OneStep                   | 39.415 ms                 | 135.388 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 300 steps, total: 4.223, sample: 0.924, forward: 1.448, backward: 0.662, update: 0.963
[proc 0] 300 steps, total: 4.222, sample: 1.068, forward: 0.954, backward: 0.682, update: 1.020
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.991 ms                  | 98.411 ms                 |
| Forward                   | 9.237 ms                  | 25.394 ms                 |
| Backward                  | 6.807 ms                  | 13.729 ms                 |
| Optimize                  | 9.256 ms                  | 16.949 ms                 |
| OneStep                   | 38.502 ms                 | 135.388 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 4.164, sample: 0.765, forward: 1.371, backward: 0.688, update: 0.903
[proc 0] 400 steps, total: 4.164, sample: 1.129, forward: 0.913, backward: 0.710, update: 0.946
[proc 1] 500 steps, total: 3.938, sample: 0.633, forward: 1.358, backward: 0.649, update: 0.878
[proc 0] 500 steps, total: 3.938, sample: 0.960, forward: 0.944, backward: 0.668, update: 0.965
Successfully xmh. training takes 22.969138145446777 seconds
before call kg_cache_controller.StopThreads()
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.479 ms                  | 96.601 ms                 |
| Forward                   | 9.021 ms                  | 26.338 ms                 |
| Backward                  | 6.790 ms                  | 13.729 ms                 |
| Optimize                  | 9.225 ms                  | 17.935 ms                 |
| OneStep                   | 37.752 ms                 | 125.149 ms                |
+---------------------------+---------------------------+---------------------------+
