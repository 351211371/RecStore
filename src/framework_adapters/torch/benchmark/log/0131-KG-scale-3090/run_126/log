WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240205 20:48:45.405278 26414 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_FB15k_12', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.1, shuffle=False, backwardMode='CppAsyncV2', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [26414 sampler.py:454] Start PreSampling
WARNING [26414 sampler.py:532] Before construct renumbering_dict
WARNING [26414 sampler.py:555] PreSampling done
W20240205 20:48:50.697927 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240205 20:48:50.698227 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240205 20:48:50.698279 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240205 20:48:50.698323 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240205 20:48:50.698364 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240205 20:48:50.698395 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240205 20:48:50.698424 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240205 20:48:50.698457 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240205 20:48:50.698499 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240205 20:48:50.698525 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240205 20:48:50.698580 26414 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240205 20:48:50.698613 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240205 20:48:50.698637 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240205 20:48:50.698841 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240205 20:48:50.698895 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240205 20:48:50.698925 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240205 20:48:50.698966 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240205 20:48:50.698998 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240205 20:48:50.699025 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240205 20:48:50.699061 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240205 20:48:50.699098 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240205 20:48:50.699131 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240205 20:48:50.699165 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240205 20:48:50.699196 26414 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240205 20:48:50.699218 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240205 20:48:50.699239 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240205 20:48:50.699288 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240205 20:48:50.699319 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240205 20:48:50.699345 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240205 20:48:50.699369 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240205 20:48:50.699416 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240205 20:48:50.699451 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240205 20:48:50.699501 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240205 20:48:50.699532 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240205 20:48:50.699560 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240205 20:48:50.699585 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240205 20:48:50.699610 26414 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240205 20:48:50.699631 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240205 20:48:50.699652 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240205 20:48:50.699720 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240205 20:48:50.699752 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240205 20:48:50.699777 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240205 20:48:50.699802 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240205 20:48:50.699826 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240205 20:48:50.699867 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240205 20:48:50.699899 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240205 20:48:50.699924 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240205 20:48:50.699960 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240205 20:48:50.699985 26414 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240205 20:48:50.700017 26414 IPCTensor.h:369] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240205 20:48:50.700039 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240205 20:48:50.700067 26414 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240205 20:48:50.955806 26414 IPCTensor.h:369] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240205 20:48:51.046044 26414 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=9703, num_edges=161860,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=11374, num_edges=168961,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=10715, num_edges=190828,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=11184, num_edges=240046,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 9703 N 161860 E
MertisPartition: part 1 has 11374 N 168961 E
MertisPartition: part 2 has 10715 N 190828 E
MertisPartition: part 3 has 11184 N 240046 E
Rank0: cached key size 373
Rank1: cached key size 373
Rank2: cached key size 373
Rank3: cached key size 373
Before renumbering graph:  {'_ID': tensor([   6,   10,   11,  ..., 5824, 6189, 2559]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
After renumbering graph:  {'_ID': tensor([1647, 1748, 1768,  ..., 8964, 5630, 6796]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 5.741 seconds
[Rank1] pid = 26617
[Rank2] pid = 26634
INFO [26414 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [26617 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [26414 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [26634 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [26745 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [26745 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [26634 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [26617 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240205 20:48:52.070381 26746 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [1495, 400]; dev=0; size=2.281 MB
W20240205 20:48:52.071826 26682 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_2 [1495, 400]; dev=2; size=2.281 MB
W20240205 20:48:52.071918 26618 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [1495, 400]; dev=1; size=2.281 MB
W20240205 20:48:52.071933 26809 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_3 [1495, 400]; dev=3; size=2.281 MB
W20240205 20:48:52.099380 26746 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x100014876000 7.629 MB
W20240205 20:48:52.099565 26746 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x100015019000 7.629 MB
W20240205 20:48:52.099642 26746 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x1000157bc000 1.49 GB
W20240205 20:48:52.099704 26746 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x100074d9f000 1.49 GB
W20240205 20:48:52.099759 26746 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240205 20:48:52.100013 26618 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x1000d4384000 7.629 MB
W20240205 20:48:52.100181 26618 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x1000d4b27000 7.629 MB
W20240205 20:48:52.100253 26618 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x1000d52ca000 1.49 GB
W20240205 20:48:52.100327 26618 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1001348ad000 1.49 GB
W20240205 20:48:52.100399 26618 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 20:48:52.102118 26809 IPCTensor.h:369] NewIPCTensor: input_keys_3 [1000000]0x100193e92000 7.629 MB
W20240205 20:48:52.102279 26809 IPCTensor.h:369] NewIPCTensor: input_keys_neg_3 [1000000]0x100194635000 7.629 MB
W20240205 20:48:52.102348 26809 IPCTensor.h:369] NewIPCTensor: backward_grads_3 [1000000, 400]0x100194dd8000 1.49 GB
W20240205 20:48:52.102423 26809 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001f43bb000 1.49 GB
W20240205 20:48:52.102490 26809 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240205 20:48:52.105742 26746 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240205 20:48:52.105842 26809 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240205 20:48:52.105849 26618 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 20:48:52.105896 26682 IPCTensor.h:369] NewIPCTensor: input_keys_2 [1000000]0x1002539a6000 7.629 MB
W20240205 20:48:52.105998 26682 IPCTensor.h:369] NewIPCTensor: input_keys_neg_2 [1000000]0x100254149000 7.629 MB
W20240205 20:48:52.106053 26682 IPCTensor.h:369] NewIPCTensor: backward_grads_2 [1000000, 400]0x1002548ec000 1.49 GB
W20240205 20:48:52.106101 26682 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x1002b3ecf000 1.49 GB
W20240205 20:48:52.106155 26682 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240205 20:48:52.111984 26682 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [26617 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [26745 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [26634 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank3] pid = 26745
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 1495), (1495, 2990), (2990, 4485), (4485, 5980)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [26414 DistTensor.py:59] The tensor name already exists in the kvstore
I20240205 20:48:53.705262 26746 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240205 20:48:53.705545 26809 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240205 20:48:53.705667 26618 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240205 20:48:53.705865 26682 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240205 20:48:53.707819 26746 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.1,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240205 20:48:53.708190 26746 grad_base.h:184] Init GradProcessingBase done
I20240205 20:48:53.720005 26746 grad_async_v2.h:42] Use main thread to update emb.
W20240205 20:48:53.720077 26746 kg_controller.h:78] after init GradAsyncProcessingV2
I20240205 20:48:53.720094 26746 kg_controller.h:84] Construct KGCacheController done
E20240205 20:48:54.136597 26618 recstore.cc:66] init folly done
E20240205 20:48:54.136628 26746 recstore.cc:66] init folly done
E20240205 20:48:54.136795 26682 recstore.cc:66] init folly done
E20240205 20:48:54.136795 26809 recstore.cc:66] init folly done
I20240205 20:48:54.137681 26746 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240205 20:48:54.466181 27130 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240205 20:48:54.466560 27130 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240205 20:48:54.502365 26746 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240205 20:48:54.509694 26618 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240205 20:48:54.512802 26809 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240205 20:48:54.514668 26682 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240205 20:48:55.733335 26746 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240205 20:48:55.765475 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=1, pq.top=1
W20240205 20:48:55.768330 27130 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240205 20:48:55.794653 26942 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=1, sample_step_cpp_seen_[rank]=0
E20240205 20:48:56.733064 27132 parallel_pq_v2.h:79] insert failed, size(hashtable)=8142
W20240205 20:48:56.781540 27130 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end7
W20240205 20:48:56.794523 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=27, pq.top=27
E20240205 20:48:57.733124 27146 parallel_pq_v2.h:79] insert failed, size(hashtable)=7625
W20240205 20:48:57.806537 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=51, pq.top=51
W20240205 20:48:57.818154 27130 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.508 ms                  | 21.078 ms                 |
| Forward                   | 4.865 ms                  | 9.288 ms                  |
| Backward                  | 4.689 ms                  | 9.433 ms                  |
| Optimize                  | 2.039 ms                  | 3.880 ms                  |
| BarrierTimeBeforeRank0    | 1.211 ms                  | 15.313 ms                 |
| AfterBackward             | 22.934 ms                 | 50.900 ms                 |
| BlockToStepN              | 799.460 us                | 3.975 ms                  |
| OneStep                   | 40.344 ms                 | 73.337 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 20:48:58.733280 27137 parallel_pq_v2.h:79] insert failed, size(hashtable)=4023
W20240205 20:48:58.822679 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 20:48:58.832458 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=73, pq.top=73
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 369.813 us                | 4.178 ms                  |
| ProcessBack:Shuffle       | 2.617 ms                  | 6.438 ms                  |
| ProcessBack:UpdateCache   | 2.620 ms                  | 3.289 ms                  |
| ProcessBack:UpsertPq      | 15.941 ms                 | 21.891 ms                 |
| ProcessOneStep            | 23.312 ms                 | 50.869 ms                 |
| BlockToStepN              | 755.225 us                | 3.847 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240205 20:48:59.733021 26942 parallel_pq_v2.h:79] insert failed, size(hashtable)=1018
W20240205 20:48:59.828706 27130 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
W20240205 20:48:59.859150 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=97, pq.top=97
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 5.478, sample: 0.318, forward: 0.845, backward: 0.659, update: 0.201
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.476, sample: 0.432, forward: 0.930, backward: 0.648, update: 0.258
train_sampler.Prefill()
-------Step 0-------
tensor([ 5410,  9463, 13271,  6116,   185,  1006,  9531,   258,   145,  9183]) tensor([ 1768, 11575,  3594, 13668,  3273,   305,  4733,  5329,  3789, 12076])
-------Step 1-------
tensor([ 5410,  9463, 13271,  6116,   185,  1006,  9531,   258,   145,  9183]) tensor([ 4299,  7923,   180,  8579,   421, 12727, 10356,  2737,  6844, 11260])
-------Step 2-------
tensor([13774, 10945,  9828,  4795,   235,  3620,    68,  6927,  5139,   213]) tensor([ 8615,  2826,  6963,  9130,  9199,   155, 13029,  1076, 10777, 10212])
-------Step 3-------
tensor([13774, 10945,  9828,  4795,   235,  3620,    68,  6927,  5139,   213]) tensor([10810,  2287, 12299,  4347,  9147,  3469, 11144,  4802,  7649, 12839])
-------Step 4-------
tensor([13200,  6985,  5331,  2692,  5362, 10200, 10564, 13405,   172, 11850]) tensor([ 1368,  6408, 11952, 10462,   657,    26,  3547,   181, 12529,  6934])
-------Step 5-------
tensor([13200,  6985,  5331,  2692,  5362, 10200, 10564, 13405,   172, 11850]) tensor([ 7910,  7892,  4575, 14085, 12445, 11757,  6839,  9827,   326, 13404])
-------Step 6-------
tensor([ 2385,    73,  3850, 14724,  5888,   314, 13537,  5863,   283,  4069]) tensor([ 7137, 14580, 12720,  3851,  9540, 11198,  2692,  7275, 12616,  8758])
-------Step 7-------
tensor([ 2385,    73,  3850, 14724,  5888,   314, 13537,  5863,   283,  4069]) tensor([12101,  5554,   935,  8364,  2557,  1671,  3545,  4212,  5751,  3229])
-------Step 8-------
tensor([  242, 10885,   353,  9745,  5608, 11262, 12852,  5726,  5394,  4492]) tensor([ 9259,  4092,  1954,  8972,  1272, 14586,  2511,  8650, 10173, 13680])
-------Step 9-------
tensor([  242, 10885,   353,  9745,  5608, 11262, 12852,  5726,  5394,  4492]) tensor([ 5911,  8349,  8550,  3308, 12945,  2754, 10474,  2737,  5217,   137])
before start barrier
start train
[proc 0] 100 steps, total: 5.488, sample: 0.384, forward: 0.892, backward: 0.664, update: 0.250
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.481, sample: 0.318, forward: 0.860, backward: 0.705, update: 0.217
E20240205 20:49:00.733009 26746 parallel_pq_v2.h:79] insert failed, size(hashtable)=1001
W20240205 20:49:00.850333 27130 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
W20240205 20:49:00.885571 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=120, pq.top=120
E20240205 20:49:01.733088 27147 parallel_pq_v2.h:79] insert failed, size(hashtable)=6493
W20240205 20:49:01.851302 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 20:49:01.906541 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=144, pq.top=144
E20240205 20:49:02.733043 27162 parallel_pq_v2.h:79] insert failed, size(hashtable)=10108
W20240205 20:49:02.873574 27130 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end7
W20240205 20:49:02.940289 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=168, pq.top=168
E20240205 20:49:03.311769 26746 grad_async_v2.h:404] Stalled in ProcessBackward: rank=2, step_no=177, sample_step_cpp_seen_[rank]=176
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.685 ms                  | 21.104 ms                 |
| Forward                   | 4.631 ms                  | 9.288 ms                  |
| Backward                  | 4.701 ms                  | 9.273 ms                  |
| Optimize                  | 2.039 ms                  | 4.094 ms                  |
| BarrierTimeBeforeRank0    | 888.235 us                | 11.606 ms                 |
| AfterBackward             | 24.180 ms                 | 80.110 ms                 |
| BlockToStepN              | 1.358 ms                  | 4.719 ms                  |
| OneStep                   | 40.991 ms                 | 96.003 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 20:49:03.733065 27130 parallel_pq_v2.h:79] insert failed, size(hashtable)=522
W20240205 20:49:04.010991 27130 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end9
W20240205 20:49:04.118708 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=191, pq.top=191
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 381.553 us                | 3.864 ms                  |
| ProcessBack:Shuffle       | 2.592 ms                  | 6.350 ms                  |
| ProcessBack:UpdateCache   | 2.512 ms                  | 3.228 ms                  |
| ProcessBack:UpsertPq      | 16.423 ms                 | 21.891 ms                 |
| ProcessOneStep            | 23.949 ms                 | 124.399 ms                |
| BlockToStepN              | 1.206 ms                  | 4.655 ms                  |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 4.540, sample: 0.366, forward: 0.438, backward: 0.647, update: 0.150
[proc 0] 200 steps, total: 4.541, sample: 0.427, forward: 0.449, backward: 0.451, update: 0.197
[proc 2] 200 steps, total: 4.541, sample: 0.351, forward: 0.440, backward: 0.457, update: 0.160
[proc 3] 200 steps, total: 4.541, sample: 0.351, forward: 0.440, backward: 0.483, update: 0.154
E20240205 20:49:04.733026 27150 parallel_pq_v2.h:79] insert failed, size(hashtable)=9718
W20240205 20:49:05.091457 27130 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
W20240205 20:49:05.207381 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=217, pq.top=217
E20240205 20:49:05.733034 27145 parallel_pq_v2.h:79] insert failed, size(hashtable)=11256
W20240205 20:49:06.093362 27130 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
W20240205 20:49:06.234591 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=238, pq.top=238
E20240205 20:49:06.733040 27141 parallel_pq_v2.h:79] insert failed, size(hashtable)=8663
W20240205 20:49:07.134464 27130 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end0
W20240205 20:49:07.259382 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=263, pq.top=263
E20240205 20:49:07.733750 27130 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240205 20:49:08.149765 27130 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240205 20:49:08.260164 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=283, pq.top=283
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.640 ms                  | 21.150 ms                 |
| Forward                   | 4.589 ms                  | 9.288 ms                  |
| Backward                  | 4.614 ms                  | 6.972 ms                  |
| Optimize                  | 2.003 ms                  | 10.764 ms                 |
| BarrierTimeBeforeRank0    | 858.937 us                | 16.635 ms                 |
| AfterBackward             | 22.934 ms                 | 159.865 ms                |
| BlockToStepN              | 1.236 ms                  | 4.719 ms                  |
| OneStep                   | 40.230 ms                 | 174.848 ms                |
+---------------------------+---------------------------+---------------------------+
E20240205 20:49:08.733034 27129 parallel_pq_v2.h:79] insert failed, size(hashtable)=8472
[proc 3] 300 steps, total: 4.484, sample: 0.297, forward: 0.426, backward: 0.449, update: 0.156
[proc 0] 300 steps, total: 4.484, sample: 0.378, forward: 0.449, backward: 0.441, update: 0.190
[proc 1] 300 steps, total: 4.484, sample: 0.325, forward: 0.414, backward: 0.486, update: 0.164
[proc 2] 300 steps, total: 4.484, sample: 0.341, forward: 0.441, backward: 0.468, update: 0.170
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 371.925 us                | 4.950 ms                  |
| ProcessBack:Shuffle       | 2.605 ms                  | 5.883 ms                  |
| ProcessBack:UpdateCache   | 2.477 ms                  | 3.228 ms                  |
| ProcessBack:UpsertPq      | 15.853 ms                 | 21.730 ms                 |
| ProcessOneStep            | 23.026 ms                 | 159.828 ms                |
| BlockToStepN              | 1.206 ms                  | 4.655 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240205 20:49:09.155543 27130 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
W20240205 20:49:09.288168 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=306, pq.top=306
E20240205 20:49:09.733009 26746 parallel_pq_v2.h:79] insert failed, size(hashtable)=58
W20240205 20:49:10.188633 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end4
W20240205 20:49:10.334359 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=327, pq.top=327
E20240205 20:49:10.733008 26746 parallel_pq_v2.h:79] insert failed, size(hashtable)=145
W20240205 20:49:11.219338 27130 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end6
W20240205 20:49:11.334609 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=348, pq.top=348
E20240205 20:49:11.733011 27130 parallel_pq_v2.h:79] insert failed, size(hashtable)=158
W20240205 20:49:12.285509 27130 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end7
W20240205 20:49:12.373454 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=368, pq.top=368
E20240205 20:49:12.733054 27131 parallel_pq_v2.h:79] insert failed, size(hashtable)=7664
W20240205 20:49:13.306965 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end6
W20240205 20:49:13.426586 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=388, pq.top=388
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.760 ms                  | 21.266 ms                 |
| Forward                   | 4.566 ms                  | 9.288 ms                  |
| Backward                  | 4.555 ms                  | 6.962 ms                  |
| Optimize                  | 1.990 ms                  | 4.094 ms                  |
| BarrierTimeBeforeRank0    | 858.937 us                | 23.717 ms                 |
| AfterBackward             | 23.421 ms                 | 124.446 ms                |
| BlockToStepN              | 1.778 ms                  | 7.082 ms                  |
| OneStep                   | 41.068 ms                 | 138.917 ms                |
+---------------------------+---------------------------+---------------------------+
E20240205 20:49:13.733045 27149 parallel_pq_v2.h:79] insert failed, size(hashtable)=5588
[proc 2] 400 steps, total: 5.097, sample: 0.297, forward: 0.358, backward: 0.510, update: 0.152
[proc 0] 400 steps, total: 5.097, sample: 0.438, forward: 0.453, backward: 0.433, update: 0.183
[proc 3] 400 steps, total: 5.097, sample: 0.345, forward: 0.424, backward: 0.484, update: 0.157
[proc 1] 400 steps, total: 5.097, sample: 0.410, forward: 0.463, backward: 0.503, update: 0.175
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 444.382 us                | 5.934 ms                  |
| ProcessBack:Shuffle       | 2.617 ms                  | 5.813 ms                  |
| ProcessBack:UpdateCache   | 2.399 ms                  | 3.206 ms                  |
| ProcessBack:UpsertPq      | 16.323 ms                 | 21.730 ms                 |
| ProcessOneStep            | 23.468 ms                 | 124.399 ms                |
| BlockToStepN              | 1.759 ms                  | 7.115 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240205 20:49:14.334697 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end4
W20240205 20:49:14.429342 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=406, pq.top=406
E20240205 20:49:14.733011 26942 parallel_pq_v2.h:79] insert failed, size(hashtable)=1457
W20240205 20:49:15.364145 27130 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
W20240205 20:49:15.463680 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=425, pq.top=425
E20240205 20:49:15.733014 26746 parallel_pq_v2.h:79] insert failed, size(hashtable)=738
W20240205 20:49:16.367719 27130 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 20:49:16.475921 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=445, pq.top=445
E20240205 20:49:16.733018 27129 parallel_pq_v2.h:79] insert failed, size(hashtable)=3807
W20240205 20:49:17.369110 27130 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240205 20:49:17.480902 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=464, pq.top=464
E20240205 20:49:17.733314 27130 parallel_pq_v2.h:79] insert failed, size(hashtable)=46
W20240205 20:49:18.376251 27130 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240205 20:49:18.493106 26746 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=483, pq.top=483
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.867 ms                  | 21.266 ms                 |
| Forward                   | 4.528 ms                  | 7.890 ms                  |
| Backward                  | 4.518 ms                  | 6.592 ms                  |
| Optimize                  | 1.958 ms                  | 3.880 ms                  |
| BarrierTimeBeforeRank0    | 819.119 us                | 26.132 ms                 |
| AfterBackward             | 23.958 ms                 | 95.474 ms                 |
| BlockToStepN              | 2.301 ms                  | 8.370 ms                  |
| OneStep                   | 43.237 ms                 | 120.416 ms                |
+---------------------------+---------------------------+---------------------------+
E20240205 20:49:18.733045 27134 parallel_pq_v2.h:79] insert failed, size(hashtable)=7864
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 550.342 us                | 6.795 ms                  |
| ProcessBack:Shuffle       | 2.620 ms                  | 5.859 ms                  |
| ProcessBack:UpdateCache   | 2.343 ms                  | 3.174 ms                  |
| ProcessBack:UpsertPq      | 16.776 ms                 | 21.979 ms                 |
| ProcessOneStep            | 23.930 ms                 | 95.438 ms                 |
| BlockToStepN              | 2.300 ms                  | 8.435 ms                  |
+---------------------------+---------------------------+---------------------------+
[proc 3] 500 steps, total: 5.251, sample: 0.298, forward: 0.406, backward: 0.469, update: 0.151
[proc 1] 500 steps, total: 5.251, sample: 0.328, forward: 0.439, backward: 0.426, update: 0.167
[proc 2] 500 steps, total: 5.252, sample: 0.289, forward: 0.359, backward: 0.422, update: 0.151
[proc 0] 500 steps, total: 5.252, sample: 0.510, forward: 0.426, backward: 0.425, update: 0.173
Successfully xmh. training takes 24.8624107837677 seconds
before call kg_cache_controller.StopThreads()
W20240205 20:49:19.364857 26746 grad_async_v2.h:84] call StopThreads. PID = 26414
W20240205 20:49:19.364894 26746 grad_base.h:212] before processOneStepNegThread_.join();
W20240205 20:49:19.365237 26746 grad_base.h:214] after processOneStepNegThread_.join();
W20240205 20:49:19.365254 26746 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
W20240205 20:49:19.376765 26746 grad_async_v2.h:105] StopThreads done.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7fdc0b8fe910>
