WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240205 21:24:41.920680  1520 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_FB15k_33', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=3, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=3, gpu=[0, 1, 2], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [1520 sampler.py:454] Start PreSampling
WARNING [1520 sampler.py:532] Before construct renumbering_dict
WARNING [1520 sampler.py:555] PreSampling done
W20240205 21:24:46.939747  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240205 21:24:46.939919  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240205 21:24:46.939960  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240205 21:24:46.939991  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240205 21:24:46.940016  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240205 21:24:46.940045  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240205 21:24:46.940074  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240205 21:24:46.940102  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240205 21:24:46.940132  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240205 21:24:46.940157  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240205 21:24:46.940193  1520 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240205 21:24:46.940217  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240205 21:24:46.940239  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240205 21:24:46.940351  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240205 21:24:46.940379  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240205 21:24:46.940407  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240205 21:24:46.940441  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240205 21:24:46.940466  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240205 21:24:46.940492  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240205 21:24:46.940521  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240205 21:24:46.940547  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240205 21:24:46.940579  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240205 21:24:46.940601  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240205 21:24:46.940622  1520 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240205 21:24:46.940640  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240205 21:24:46.940658  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240205 21:24:46.940701  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240205 21:24:46.940735  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240205 21:24:46.940757  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240205 21:24:46.940786  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240205 21:24:46.940807  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240205 21:24:46.940837  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240205 21:24:46.940874  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240205 21:24:46.940898  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240205 21:24:46.940927  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240205 21:24:46.940948  1520 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240205 21:24:46.940975  1520 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240205 21:24:46.940994  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240205 21:24:46.941020  1520 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
{0: Graph(num_nodes=11088, num_edges=209563,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=12469, num_edges=203028,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=11122, num_edges=307147,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 11088 N 209563 E
MertisPartition: part 1 has 12469 N 203028 E
MertisPartition: part 2 has 11122 N 307147 E
Rank0: cached key size 249
Rank1: cached key size 249
Rank2: cached key size 249
Before renumbering graph:  {'_ID': tensor([   7,   10,   16,  ..., 9100, 2559, 8058]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 957, 1049, 1222,  ..., 9160, 6514, 5037]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 5.314 seconds
[Rank1] pid = 1745
INFO [1745 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [1745 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [1815 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [1520 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [1520 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [1815 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
E20240205 21:24:47.943902  1746 recstore.cc:66] init folly done
E20240205 21:24:47.943917  1817 recstore.cc:66] init folly done
E20240205 21:24:47.943899  1816 recstore.cc:66] init folly done
I20240205 21:24:48.030416  1746 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 3
I20240205 21:24:48.034569  1816 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
I20240205 21:24:48.040846  1817 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 3.556, sample: 0.440, forward: 1.147, backward: 0.833, update: 0.893
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 3.546, sample: 0.431, forward: 1.110, backward: 0.856, update: 0.885
[Rank2] pid = 1815
train_sampler.Prefill()
-------Step 0-------
tensor([  173, 13103, 12667,  4435,    24, 10401,  6925,  5951,  5322, 12913]) tensor([ 1222,  3966, 12213,  4965,  6713,  9229,   256,  4897,  4170, 14757])
-------Step 1-------
tensor([  173, 13103, 12667,  4435,    24, 10401,  6925,  5951,  5322, 12913]) tensor([ 6840,  7290,  8891, 13795,  5198,  5255,  1408, 12385,  3649,  2695])
-------Step 2-------
tensor([ 6003,  1893, 12589,    12,  7015,  2464,   216,  2776, 12037,  9409]) tensor([ 4270,  7408, 12120,  9810,  6670, 14126,  9302,   956,  2302,  7123])
-------Step 3-------
tensor([ 6003,  1893, 12589,    12,  7015,  2464,   216,  2776, 12037,  9409]) tensor([ 7789,   286,  8805,  1836,  6013,  1944,  4509,  5041,  1102, 12469])
-------Step 4-------
tensor([14923, 14750,   178,  7706,  8837,  2033,   219,   233,   201,  6322]) tensor([ 2061,  4774, 12849,  4512, 14346,  6803, 12817,   680,   377,  3330])
-------Step 5-------
tensor([14923, 14750,   178,  7706,  8837,  2033,   219,   233,   201,  6322]) tensor([ 3784, 14153,  8202,  8322, 14607, 13792, 11005, 11416, 13862,  2153])
-------Step 6-------
tensor([12151,  6787,  9432,     0, 14641,  3200, 12249, 12368,  7017,   751]) tensor([ 2163,  8400, 13912,  6944, 14769,  5760,  3851,  7919,  2425, 12082])
-------Step 7-------
tensor([12151,  6787,  9432,     0, 14641,  3200, 12249, 12368,  7017,   751]) tensor([13751,  8073,  7093,   564,  9237, 11586,  1517,  3463,  7734,   910])
-------Step 8-------
tensor([ 5808,   203,  6294,  1294, 13328,   893,   163,  5977,  2096,  9967]) tensor([ 5106,  8216,    51, 10487,  9173,  2943,  6322,  6355,  7719, 13803])
-------Step 9-------
tensor([ 5808,   203,  6294,  1294, 13328,   893,   163,  5977,  2096,  9967]) tensor([11423,  4800,  7204,   385,  2934,  9185,  1392,  3910,  5986,  4810])
before start barrier
start train
[proc 0] 100 steps, total: 3.552, sample: 0.430, forward: 1.142, backward: 0.848, update: 0.875
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.257 ms                  | 32.095 ms                 |
| Forward                   | 7.534 ms                  | 17.245 ms                 |
| Backward                  | 6.852 ms                  | 7.848 ms                  |
| Optimize                  | 7.966 ms                  | 14.504 ms                 |
| OneStep                   | 26.373 ms                 | 64.329 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 2] 200 steps, total: 3.138, sample: 0.470, forward: 0.759, backward: 0.681, update: 0.851
[proc 0] 200 steps, total: 3.138, sample: 0.483, forward: 0.801, backward: 0.682, update: 0.846
[proc 1] 200 steps, total: 3.138, sample: 0.507, forward: 0.784, backward: 0.676, update: 0.871
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.295 ms                  | 31.879 ms                 |
| Forward                   | 7.636 ms                  | 16.633 ms                 |
| Backward                  | 6.863 ms                  | 7.848 ms                  |
| Optimize                  | 8.061 ms                  | 14.504 ms                 |
| OneStep                   | 27.549 ms                 | 61.418 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 2] 300 steps, total: 3.449, sample: 0.485, forward: 0.796, backward: 0.699, update: 0.903
[proc 0] 300 steps, total: 3.449, sample: 0.450, forward: 0.847, backward: 0.696, update: 0.883
[proc 1] 300 steps, total: 3.449, sample: 0.450, forward: 0.865, backward: 0.674, update: 0.914
[proc 1] 400 steps, total: 3.627, sample: 0.507, forward: 0.860, backward: 0.649, update: 0.919
[proc 2] 400 steps, total: 3.627, sample: 0.516, forward: 0.805, backward: 0.687, update: 0.902
[proc 0] 400 steps, total: 3.627, sample: 0.433, forward: 0.849, backward: 0.686, update: 0.901
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.367 ms                  | 31.879 ms                 |
| Forward                   | 7.711 ms                  | 16.779 ms                 |
| Backward                  | 6.874 ms                  | 12.114 ms                 |
| Optimize                  | 8.139 ms                  | 15.761 ms                 |
| OneStep                   | 29.061 ms                 | 63.339 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 2] 500 steps, total: 3.759, sample: 0.525, forward: 0.803, backward: 0.687, update: 0.880
[proc 0] 500 steps, total: 3.759, sample: 0.524, forward: 0.877, backward: 0.698, update: 0.914
Successfully xmh. training takes 17.52539587020874 seconds
[proc 1] 500 steps, total: 3.760, sample: 0.518, forward: 0.791, backward: 0.639, update: 0.900
before call kg_cache_controller.StopThreads()
KGCacheControllerWrapperDummy.StopThreads
