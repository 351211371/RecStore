WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240203 14:32:08.859517 32271 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_66', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [32271 sampler.py:454] Start PreSampling
WARNING [32271 sampler.py:532] Before construct renumbering_dict
WARNING [32271 sampler.py:555] PreSampling done
W20240203 14:50:57.114702 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240203 14:50:57.114892 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240203 14:50:57.114940 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240203 14:50:57.114981 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240203 14:50:57.115012 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240203 14:50:57.115047 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240203 14:50:57.115085 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240203 14:50:57.115128 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240203 14:50:57.115157 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240203 14:50:57.115191 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240203 14:50:57.115229 32271 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240203 14:50:57.115258 32271 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240203 14:50:57.115289 32271 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240203 14:50:57.115444 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240203 14:50:57.115483 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240203 14:50:57.115514 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240203 14:50:57.115556 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240203 14:50:57.115585 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240203 14:50:57.115617 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240203 14:50:57.115646 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240203 14:50:57.115684 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240203 14:50:57.115712 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240203 14:50:57.115754 32271 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240203 14:50:57.115785 32271 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240203 14:50:57.115808 32271 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240203 14:50:57.115831 32271 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240203 14:50:57.528345 32271 IPCTensor.h:369] NewIPCTensor: full_emb [86054151, 400]0x1000098ca000 128.2 GB
W20240203 14:59:44.284999 32271 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [86054151]0x102018502000 328.3 MB
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2151353
Rank1: cached key size 2151353
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4302746,  4302784,   601246,  ..., 23612284, 28740220, 69071676]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2169.528 seconds
INFO [32271 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [32271 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [60268 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
W20240203 15:08:20.274610 60332 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [4302707, 400]; dev=0; size=6.412 GB
INFO [60268 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
W20240203 15:08:20.276785 60269 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [4302707, 400]; dev=1; size=6.412 GB
W20240203 15:08:20.302757 60332 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x10202cd4b000 7.629 MB
W20240203 15:08:20.302883 60332 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x10202d4ee000 7.629 MB
W20240203 15:08:20.302932 60332 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x10202dc91000 1.49 GB
W20240203 15:08:20.302982 60332 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x10208d274000 1.49 GB
W20240203 15:08:20.303028 60332 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240203 15:08:20.311759 60332 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240203 15:08:20.312178 60269 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x1020ec85b000 7.629 MB
W20240203 15:08:20.312281 60269 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x1020ecffe000 7.629 MB
W20240203 15:08:20.312337 60269 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x1020ed7a1000 1.49 GB
W20240203 15:08:20.312388 60269 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x10214cd84000 1.49 GB
W20240203 15:08:20.312430 60269 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240203 15:08:20.315287 60269 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
[Rank1] pid = 60268
New CachedEmbedding, name=full_emb, shape=(86054151, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 4302707), (4302707, 8605414)]
cudaHostRegister 0x1000098ca000
0: KnownLocalCachedEmbedding init done
WARNING [32271 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x1000098ca000
1: KnownLocalCachedEmbedding init done
WARNING [60268 DistTensor.py:59] The tensor name already exists in the kvstore
I20240203 15:08:44.037051 60269 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 2
I20240203 15:08:44.037187 60332 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 2
W20240203 15:08:44.038923 60332 grad_base.h:55] KGCacheController, config={
        "num_gpus": 2,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240203 15:08:44.039232 60332 grad_base.h:184] Init GradProcessingBase done
I20240203 15:08:56.290287 60332 grad_async_v2.h:42] Use main thread to update emb.
W20240203 15:08:56.290385 60332 kg_controller.h:78] after init GradAsyncProcessingV2
I20240203 15:08:56.290393 60332 kg_controller.h:84] Construct KGCacheController done
E20240203 15:08:56.524068 60332 recstore.cc:66] init folly done
E20240203 15:08:56.524111 60269 recstore.cc:66] init folly done
I20240203 15:08:56.524706 60332 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240203 15:09:10.446512 61245 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240203 15:09:10.446887 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 129.037 us                | 307.264 us                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:11.669395 61245 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240203 15:09:11.669502 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 132.883 us                | 360.013 us                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 132.883 us                | 360.013 us                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:22.020359 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240203 15:09:22.038312 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
I20240203 15:09:22.075224 60269 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
W20240203 15:09:24.593842 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240203 15:09:24.613165 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240203 15:09:24.655576 60332 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
E20240203 15:09:25.640417 60332 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240203 15:09:25.672583 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=1, pq.top=1
W20240203 15:09:25.677021 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 211.931 us                | 2.220 ms                  |
| ProcessBack:Shuffle       | 814.212 us                | 61.116 ms                 |
| ProcessBack:UpdateCache   | 691.544 us                | 85.618 ms                 |
| ProcessBack:UpsertPq      | 4.826 ms                  | 53.783 ms                 |
| ProcessOneStep            | 7.948 ms                  | 199.977 ms                |
| BlockToStepN              | 422.598 us                | 2.190 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:26.640007 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=6
W20240203 15:09:26.701313 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=19, pq.top=19
W20240203 15:09:26.873009 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end2
E20240203 15:09:26.988394 60957 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=22, sample_step_cpp_seen_[rank]=21
E20240203 15:09:27.640012 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=456
W20240203 15:09:27.877267 61245 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240203 15:09:28.077433 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=33, pq.top=33
E20240203 15:09:28.640017 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.763 ms                  | 121.434 ms                |
| Forward                   | 4.551 ms                  | 6.326 ms                  |
| Backward                  | 4.735 ms                  | 34.281 ms                 |
| Optimize                  | 2.156 ms                  | 5.111 ms                  |
| BarrierTimeBeforeRank0    | 49.817 us                 | 43.366 ms                 |
| AfterBackward             | 25.219 ms                 | 181.305 ms                |
| BlockToStepN              | 360.717 us                | 2.327 ms                  |
| OneStep                   | 47.135 ms                 | 361.665 ms                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:29.058516 61245 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end4
E20240203 15:09:29.640008 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=2970
W20240203 15:09:30.096195 61245 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
W20240203 15:09:30.181847 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=65, pq.top=65
E20240203 15:09:30.640007 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=85
W20240203 15:09:31.323586 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=83, pq.top=83
W20240203 15:09:31.342020 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 254.680 us                | 2.291 ms                  |
| ProcessBack:Shuffle       | 746.118 us                | 32.609 ms                 |
| ProcessBack:UpdateCache   | 757.877 us                | 25.793 ms                 |
| ProcessBack:UpsertPq      | 6.552 ms                  | 74.674 ms                 |
| ProcessOneStep            | 26.412 ms                 | 181.263 ms                |
| BlockToStepN              | 258.711 us                | 2.232 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:31.640015 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=24
E20240203 15:09:32.058406 60957 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=94, sample_step_cpp_seen_[rank]=93
W20240203 15:09:32.368577 61245 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
E20240203 15:09:32.640015 60957 parallel_pq_v2.h:79] insert failed, size(hashtable)=946
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 10.645, sample: 1.882, forward: 1.144, backward: 0.635, update: 0.230
train_sampler.Prefill()
-------Step 0-------
tensor([1190966, 1190992, 1191013, 1750592, 1191041, 1191066, 1191096,   18695,
        1191121, 1191149]) tensor([  250306,  4604555, 15170261, 47225964, 35071635, 16709867, 69129993,
         7744333, 44972902, 64999061])
-------Step 1-------
tensor([1190966, 1190992, 1191013, 1750592, 1191041, 1191066, 1191096,   18695,
        1191121, 1191149]) tensor([71046719, 66184166, 63578094, 39343447, 45387917,   142970, 30177930,
        51619986, 81046694, 81901070])
-------Step 2-------
tensor([1268653, 1268673, 1268701, 1268726, 1268751, 1268782, 1268803, 1268831,
        1758208, 1268857]) tensor([14762549, 13573200, 40142601, 70198247, 33387478,  2010471, 36839115,
        49302411, 65483663, 11393122])
-------Step 3-------
tensor([1268653, 1268673, 1268701, 1268726, 1268751, 1268782, 1268803, 1268831,
        1758208, 1268857]) tensor([43696329, 84539489,  2303125, 28659014, 48618642, 40465641, 30894767,
        51576723, 54014438, 24546465])
-------Step 4-------
tensor([ 1348500,  1348525,   280298,  1348549,   280320, 51246417,   959212,
         1348573,  1348608,  1348631]) tensor([  718783, 83021450, 27342218, 35137048, 84236456, 53040541, 58088760,
        29125156, 24352038, 37496505])
-------Step 5-------
tensor([ 1348500,  1348525,   280298,  1348549,   280320, 51246417,   959212,
         1348573,  1348608,  1348631]) tensor([57433705, 37004608, 53644638, 18839420, 21206455, 66984039, 47040611,
        10784087, 58944829, 77346797])
-------Step 6-------
tensor([ 1427523,  1427553,  1427587,   440379,  1427606,  1427626,  1427655,
        12854094,  1427684,  4331812]) tensor([17519553, 30065237,  6632627,  1167940, 19095283, 18476163,  2719756,
         1341973, 85828999, 24993243])
-------Step 7-------
tensor([ 1427523,  1427553,  1427587,   440379,  1427606,  1427626,  1427655,
        12854094,  1427684,  4331812]) tensor([70470657, 71491787, 66934635,  1525359,  8468667, 37484868, 66122984,
        73686837, 61650943,  8539767])
-------Step 8-------
tensor([1505045, 1505073, 1505090,  442728, 1505114, 1505151, 1505180,  282289,
        1505211, 1505239]) tensor([82584601, 82765349,   351011,  4347884, 46101067, 27990575, 65796872,
        79413502, 37854928, 23633085])
-------Step 9-------
tensor([1505045, 1505073, 1505090,  442728, 1505114, 1505151, 1505180,  282289,
        1505211, 1505239]) tensor([  466005, 37406458, 20909501, 68612098, 34174556,  1499627, 21631486,
        37647567, 26033137, 72721388])
before start barrier
start train
[proc 0] 100 steps, total: 8.065, sample: 1.643, forward: 1.057, backward: 0.698, update: 0.244
W20240203 15:09:33.319041 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=105, pq.top=105
W20240203 15:09:33.387351 61245 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end7
E20240203 15:09:33.640058 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=119
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.763 ms                  | 128.110 ms                |
| Forward                   | 4.371 ms                  | 11.862 ms                 |
| Backward                  | 4.785 ms                  | 34.281 ms                 |
| Optimize                  | 2.082 ms                  | 7.164 ms                  |
| BarrierTimeBeforeRank0    | 60.960 us                 | 43.366 ms                 |
| AfterBackward             | 26.392 ms                 | 200.329 ms                |
| BlockToStepN              | 340.674 us                | 2.341 ms                  |
| OneStep                   | 63.948 ms                 | 361.665 ms                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:34.358150 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=123, pq.top=123
W20240203 15:09:34.418752 61245 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end5
E20240203 15:09:34.640009 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=2784
W20240203 15:09:35.579425 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end4
E20240203 15:09:35.640009 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=12807
W20240203 15:09:36.074317 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=151, pq.top=151
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 381.559 us                | 7.613 ms                  |
| ProcessBack:Shuffle       | 751.965 us                | 27.538 ms                 |
| ProcessBack:UpdateCache   | 757.406 us                | 1.031 ms                  |
| ProcessBack:UpsertPq      | 5.931 ms                  | 71.484 ms                 |
| ProcessOneStep            | 26.124 ms                 | 181.263 ms                |
| BlockToStepN              | 562.612 us                | 2.608 ms                  |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:36.640005 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=3
W20240203 15:09:36.740672 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end6
W20240203 15:09:37.119562 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=173, pq.top=173
E20240203 15:09:37.248634 60957 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=176, sample_step_cpp_seen_[rank]=175
E20240203 15:09:37.640010 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=15
W20240203 15:09:37.832310 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end4
W20240203 15:09:37.966113 60332 grad_async_v2.h:257] pq is empty
W20240203 15:09:38.185648 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=191, pq.top=191
E20240203 15:09:38.640010 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=3154
[proc 1] 200 steps, total: 5.947, sample: 1.556, forward: 0.424, backward: 0.511, update: 0.192
[proc 0] 200 steps, total: 5.947, sample: 2.179, forward: 0.442, backward: 0.500, update: 0.223
W20240203 15:09:38.951813 61245 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end8
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 7.009 ms                  | 128.110 ms                |
| Forward                   | 4.423 ms                  | 8.949 ms                  |
| Backward                  | 4.847 ms                  | 21.890 ms                 |
| Optimize                  | 2.080 ms                  | 5.111 ms                  |
| BarrierTimeBeforeRank0    | 37.748 us                 | 27.594 ms                 |
| AfterBackward             | 25.901 ms                 | 181.305 ms                |
| BlockToStepN              | 804.494 us                | 5.217 ms                  |
| OneStep                   | 55.402 ms                 | 274.125 ms                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:39.376097 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=213, pq.top=213
E20240203 15:09:39.640012 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1853
W20240203 15:09:39.978346 61245 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end3
W20240203 15:09:40.383038 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=231, pq.top=231
E20240203 15:09:40.640034 61631 parallel_pq_v2.h:79] insert failed, size(hashtable)=10647
W20240203 15:09:41.017026 61245 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end6
W20240203 15:09:41.406275 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=253, pq.top=253
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 334.892 us                | 8.918 ms                  |
| ProcessBack:Shuffle       | 758.932 us                | 14.068 ms                 |
| ProcessBack:UpdateCache   | 768.634 us                | 1.031 ms                  |
| ProcessBack:UpsertPq      | 5.728 ms                  | 68.911 ms                 |
| ProcessOneStep            | 25.584 ms                 | 181.263 ms                |
| BlockToStepN              | 946.163 us                | 10.511 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:41.640148 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=15628
W20240203 15:09:42.136343 61245 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end9
E20240203 15:09:42.359567 60332 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=274, sample_step_cpp_seen_[rank]=273
W20240203 15:09:42.506114 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=277, pq.top=277
E20240203 15:09:42.640007 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=706
W20240203 15:09:43.213986 61245 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end0
W20240203 15:09:43.506477 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=295, pq.top=295
E20240203 15:09:43.640014 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=783
[proc 0] 300 steps, total: 5.053, sample: 1.236, forward: 0.463, backward: 0.531, update: 0.229
[proc 1] 300 steps, total: 5.053, sample: 1.146, forward: 0.410, backward: 0.505, update: 0.185
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 6.139 ms                  | 123.714 ms                |
| Forward                   | 4.496 ms                  | 7.537 ms                  |
| Backward                  | 4.883 ms                  | 14.419 ms                 |
| Optimize                  | 2.087 ms                  | 5.095 ms                  |
| BarrierTimeBeforeRank0    | 31.633 us                 | 27.594 ms                 |
| AfterBackward             | 25.219 ms                 | 181.305 ms                |
| BlockToStepN              | 1.148 ms                  | 16.925 ms                 |
| OneStep                   | 50.473 ms                 | 207.459 ms                |
+---------------------------+---------------------------+---------------------------+
W20240203 15:09:44.240731 61245 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
E20240203 15:09:44.640009 60957 parallel_pq_v2.h:79] insert failed, size(hashtable)=15369
W20240203 15:09:44.726145 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=317, pq.top=317
W20240203 15:09:45.269857 61245 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end7
E20240203 15:09:45.640009 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=15815
W20240203 15:09:45.728942 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=338, pq.top=338
W20240203 15:09:46.421341 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end3
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 349.099 us                | 13.030 ms                 |
| ProcessBack:Shuffle       | 768.604 us                | 12.134 ms                 |
| ProcessBack:UpdateCache   | 782.503 us                | 1.070 ms                  |
| ProcessBack:UpsertPq      | 5.748 ms                  | 64.863 ms                 |
| ProcessOneStep            | 25.084 ms                 | 169.472 ms                |
| BlockToStepN              | 1.217 ms                  | 19.807 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:46.641237 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240203 15:09:46.953682 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=359, pq.top=359
W20240203 15:09:47.462090 61245 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end1
E20240203 15:09:47.650667 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240203 15:09:47.962628 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=380, pq.top=379
E20240203 15:09:48.317956 60957 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=389, sample_step_cpp_seen_[rank]=388
W20240203 15:09:48.538740 61245 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240203 15:09:48.650172 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.830 ms                  | 121.434 ms                |
| Forward                   | 4.626 ms                  | 6.766 ms                  |
| Backward                  | 4.949 ms                  | 11.857 ms                 |
| Optimize                  | 2.190 ms                  | 5.426 ms                  |
| BarrierTimeBeforeRank0    | 28.623 us                 | 27.594 ms                 |
| AfterBackward             | 24.885 ms                 | 169.515 ms                |
| BlockToStepN              | 1.398 ms                  | 22.750 ms                 |
| OneStep                   | 49.670 ms                 | 198.851 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 400 steps, total: 5.341, sample: 0.905, forward: 0.479, backward: 0.649, update: 0.290
[proc 1] 400 steps, total: 5.341, sample: 1.116, forward: 0.412, backward: 0.569, update: 0.185
W20240203 15:09:49.111599 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=401, pq.top=401
W20240203 15:09:49.616089 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end0
E20240203 15:09:49.650015 61634 parallel_pq_v2.h:79] insert failed, size(hashtable)=11221
W20240203 15:09:50.234236 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=423, pq.top=423
W20240203 15:09:50.618645 61245 grad_async_v2.h:137] Detect new sample comes, old_end3, new_end1
E20240203 15:09:50.650007 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=18115
W20240203 15:09:51.392125 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=445, pq.top=445
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 333.266 us                | 11.755 ms                 |
| ProcessBack:Shuffle       | 780.574 us                | 2.908 ms                  |
| ProcessBack:UpdateCache   | 790.792 us                | 1.070 ms                  |
| ProcessBack:UpsertPq      | 5.815 ms                  | 63.581 ms                 |
| ProcessOneStep            | 24.508 ms                 | 169.472 ms                |
| BlockToStepN              | 1.418 ms                  | 24.780 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240203 15:09:51.650008 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=10998
W20240203 15:09:51.822031 61245 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end3
W20240203 15:09:52.393131 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=465, pq.top=465
E20240203 15:09:52.650010 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=36117
W20240203 15:09:52.889464 61245 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end4
E20240203 15:09:53.554711 60957 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=487, sample_step_cpp_seen_[rank]=486
E20240203 15:09:53.650009 61245 parallel_pq_v2.h:79] insert failed, size(hashtable)=22
W20240203 15:09:53.865288 60332 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=491, pq.top=491
W20240203 15:09:53.891446 61245 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.992 ms                  | 114.537 ms                |
| Forward                   | 4.620 ms                  | 6.584 ms                  |
| Backward                  | 5.026 ms                  | 11.135 ms                 |
| Optimize                  | 2.172 ms                  | 5.426 ms                  |
| BarrierTimeBeforeRank0    | 30.992 us                 | 27.594 ms                 |
| AfterBackward             | 24.385 ms                 | 163.740 ms                |
| BlockToStepN              | 1.633 ms                  | 25.495 ms                 |
| OneStep                   | 48.958 ms                 | 191.659 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 500 steps, total: 5.212, sample: 1.220, forward: 0.425, backward: 0.545, update: 0.189
[proc 0] 500 steps, total: 5.212, sample: 0.859, forward: 0.457, backward: 0.541, update: 0.238
Successfully xmh. training takes 29.61811375617981 seconds
before call kg_cache_controller.StopThreads()
W20240203 15:09:54.273725 60332 grad_async_v2.h:84] call StopThreads. PID = 32271
W20240203 15:09:54.273753 60332 grad_base.h:212] before processOneStepNegThread_.join();
W20240203 15:09:54.274325 60332 grad_base.h:214] after processOneStepNegThread_.join();
W20240203 15:09:54.274340 60332 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
W20240203 15:09:54.638983 60332 grad_async_v2.h:105] StopThreads done.
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 292.936 us                | 7.307 ms                  |
| ProcessBack:Shuffle       | 782.216 us                | 3.351 ms                  |
| ProcessBack:UpdateCache   | 791.305 us                | 1.056 ms                  |
| ProcessBack:UpsertPq      | 5.846 ms                  | 60.226 ms                 |
| ProcessOneStep            | 24.341 ms                 | 163.707 ms                |
| BlockToStepN              | 1.581 ms                  | 30.747 ms                 |
+---------------------------+---------------------------+---------------------------+
