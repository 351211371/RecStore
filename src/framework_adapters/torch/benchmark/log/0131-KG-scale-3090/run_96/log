WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240205 19:52:15.289568 28651 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_138', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=3, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=3, gpu=[0, 1, 2], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, nr_background_threads=32, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Partitoning with metis
[19:52:16] /home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/src/graph/transform/metis_partition_hetero.cc:87: Partition a graph with 14951 nodes and 771659 edges into 3 parts and get 84074 edge cuts
WARNING [28651 sampler.py:454] Start PreSampling
WARNING [28651 sampler.py:532] Before construct renumbering_dict
WARNING [28651 sampler.py:555] PreSampling done
W20240205 19:52:20.364372 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240205 19:52:20.364593 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240205 19:52:20.364650 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240205 19:52:20.364697 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240205 19:52:20.364765 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240205 19:52:20.364807 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240205 19:52:20.364854 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240205 19:52:20.364902 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240205 19:52:20.364943 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240205 19:52:20.364984 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240205 19:52:20.365034 28651 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240205 19:52:20.365070 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240205 19:52:20.365116 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240205 19:52:20.365238 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240205 19:52:20.365296 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240205 19:52:20.365334 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240205 19:52:20.365382 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240205 19:52:20.365419 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240205 19:52:20.365468 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240205 19:52:20.365514 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240205 19:52:20.365557 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240205 19:52:20.365597 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240205 19:52:20.365651 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240205 19:52:20.365695 28651 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240205 19:52:20.365729 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240205 19:52:20.365763 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240205 19:52:20.365833 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240205 19:52:20.365873 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240205 19:52:20.365911 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240205 19:52:20.365953 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240205 19:52:20.365998 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240205 19:52:20.366043 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240205 19:52:20.366086 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240205 19:52:20.366122 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240205 19:52:20.366164 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240205 19:52:20.366201 28651 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240205 19:52:20.366240 28651 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240205 19:52:20.366271 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240205 19:52:20.366303 28651 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240205 19:52:20.629843 28651 IPCTensor.h:369] NewIPCTensor: full_emb [14951, 400]0x10000e52e000 22.81 MB
W20240205 19:52:20.719946 28651 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x10000fc00000 58.4 kB
Convert a graph into a bidirected graph: 0.032 seconds, peak memory: 210.348 GB
Construct multi-constraint weights: 0.001 seconds, peak memory: 210.348 GB
Metis partitioning: 0.102 seconds, peak memory: 210.348 GB
Split the graph: 0.077 seconds
Construct subgraphs: 0.018 seconds
MertisPartition: part 0 has 11088 N 209563 E
MertisPartition: part 1 has 12469 N 203028 E
MertisPartition: part 2 has 11122 N 307147 E
Rank0: cached key size 249
Rank1: cached key size 249
Rank2: cached key size 249
Before renumbering graph:  {'_ID': tensor([   7,   10,   16,  ..., 9100, 2559, 8058]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 976, 1122, 1335,  ..., 6323, 6427, 3750]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=11088, num_edges=209563,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 5.526 seconds
[Rank1] pid = 28886
INFO [28651 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [28651 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [28950 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [28886 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [28886 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
INFO [28950 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 3 nodes.
W20240205 19:52:21.599634 28951 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [747, 400]; dev=0; size=1.14 MB
W20240205 19:52:21.600841 29014 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_2 [747, 400]; dev=2; size=1.14 MB
W20240205 19:52:21.600868 28887 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [747, 400]; dev=1; size=1.14 MB
W20240205 19:52:21.626547 28887 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x10000fc12000 7.629 MB
W20240205 19:52:21.626688 28887 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x1000103b5000 7.629 MB
W20240205 19:52:21.626756 28887 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x100010b58000 1.49 GB
W20240205 19:52:21.626824 28887 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x10007013b000 1.49 GB
W20240205 19:52:21.626883 28887 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 19:52:21.628823 29014 IPCTensor.h:369] NewIPCTensor: input_keys_2 [1000000]0x1000cf722000 7.629 MB
W20240205 19:52:21.628845 28887 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240205 19:52:21.628928 29014 IPCTensor.h:369] NewIPCTensor: input_keys_neg_2 [1000000]0x1000cfec5000 7.629 MB
W20240205 19:52:21.628975 29014 IPCTensor.h:369] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000d0668000 1.49 GB
W20240205 19:52:21.629026 29014 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x10012fc4b000 1.49 GB
W20240205 19:52:21.629073 29014 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240205 19:52:21.632889 29014 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240205 19:52:21.632933 28951 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x10018f234000 7.629 MB
W20240205 19:52:21.633025 28951 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x10018f9d7000 7.629 MB
W20240205 19:52:21.633076 28951 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x10019017a000 1.49 GB
W20240205 19:52:21.633137 28951 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x1001ef75d000 1.49 GB
W20240205 19:52:21.633190 28951 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240205 19:52:21.637249 28951 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
cudaHostRegister 0x10000e52e000
2: KnownLocalCachedEmbedding init done
WARNING [28950 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x10000e52e000
1: KnownLocalCachedEmbedding init done
WARNING [28886 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank2] pid = 28950
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 747), (747, 1494), (1494, 2241)]
cudaHostRegister 0x10000e52e000
0: KnownLocalCachedEmbedding init done
WARNING [28651 DistTensor.py:59] The tensor name already exists in the kvstore
I20240205 19:52:23.465961 28951 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 3
I20240205 19:52:23.466243 28887 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 3
I20240205 19:52:23.466378 29014 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 3
W20240205 19:52:23.468322 28951 grad_base.h:55] KGCacheController, config={
        "num_gpus": 3,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240205 19:52:23.468441 28951 grad_base.h:184] Init GradProcessingBase done
I20240205 19:52:23.472803 28951 grad_async_v2.h:42] Use main thread to update emb.
W20240205 19:52:23.472836 28951 kg_controller.h:78] after init GradAsyncProcessingV2
I20240205 19:52:23.472846 28951 kg_controller.h:84] Construct KGCacheController done
E20240205 19:52:23.827795 29014 recstore.cc:66] init folly done
E20240205 19:52:23.827798 28887 recstore.cc:66] init folly done
E20240205 19:52:23.827828 28951 recstore.cc:66] init folly done
I20240205 19:52:23.828981 28951 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240205 19:52:24.064555 29270 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240205 19:52:24.064996 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240205 19:52:24.119532 28951 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 3
I20240205 19:52:24.124346 29014 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
I20240205 19:52:24.124645 28887 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 3
E20240205 19:52:25.284897 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240205 19:52:25.310931 29270 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240205 19:52:25.338487 28951 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=1, sample_step_cpp_seen_[rank]=0
W20240205 19:52:25.382898 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=2, pq.top=0
E20240205 19:52:26.284024 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=1046
W20240205 19:52:26.390082 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=25, pq.top=25
W20240205 19:52:26.399104 29270 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
E20240205 19:52:27.284060 29288 parallel_pq_v2.h:79] insert failed, size(hashtable)=12711
W20240205 19:52:27.398690 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=53, pq.top=53
W20240205 19:52:27.509279 29270 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end6
E20240205 19:52:28.287252 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.439 ms                  | 28.990 ms                 |
| Forward                   | 5.396 ms                  | 10.194 ms                 |
| Backward                  | 4.946 ms                  | 17.997 ms                 |
| Optimize                  | 2.379 ms                  | 5.068 ms                  |
| BarrierTimeBeforeRank0    | 27.192 us                 | 7.216 ms                  |
| AfterBackward             | 14.797 ms                 | 181.864 ms                |
| BlockToStepN              | 355.210 us                | 10.309 ms                 |
| OneStep                   | 31.725 ms                 | 196.884 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:28.518633 29270 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240205 19:52:28.556244 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=72, pq.top=72
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 264.787 us                | 4.186 ms                  |
| ProcessBack:Shuffle       | 1.605 ms                  | 3.042 ms                  |
| ProcessBack:UpdateCache   | 1.523 ms                  | 2.956 ms                  |
| ProcessBack:UpsertPq      | 11.297 ms                 | 21.408 ms                 |
| ProcessOneStep            | 15.012 ms                 | 307.966 ms                |
| BlockToStepN              | 311.814 us                | 10.251 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 19:52:29.287146 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240205 19:52:29.570109 29270 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
W20240205 19:52:29.640144 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=97, pq.top=97
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.613, sample: 0.405, forward: 1.052, backward: 0.659, update: 0.228
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.613, sample: 0.403, forward: 1.042, backward: 0.720, update: 0.218
train_sampler.Prefill()
-------Step 0-------
tensor([  144,  9760,  8898,  4919,    46, 10056,  4958,  8254,  6996,  8975]) tensor([ 1335,  3009, 14720,  4942,  9194, 10654,   280,  7429,  4182, 12475])
-------Step 1-------
tensor([  144,  9760,  8898,  4919,    46, 10056,  4958,  8254,  6996,  8975]) tensor([ 6658, 10545,  6087, 14927,  7031,  4963,  1633, 13330,  5339,  3430])
-------Step 2-------
tensor([ 8562,  1568, 12580,     4,  6552,  3047,   149,  3660, 14619, 13081]) tensor([ 5640,  6902, 14787,  7028,  4878, 11087,  6751,   928,  1805,  9478])
-------Step 3-------
tensor([ 8562,  1568, 12580,     4,  6552,  3047,   149,  3660, 14619, 13081]) tensor([ 7254,   288,  8345,  2213,  6733,  1897,  3194,  4773,  1097, 14839])
-------Step 4-------
tensor([12139, 14079,   166,  5650,  8838,  1993,   217,   147,    98,  7347]) tensor([ 2775,  6337, 12888,  5015, 11764,  6867,  9531,   663,   386,  4398])
-------Step 5-------
tensor([12139, 14079,   166,  5650,  8838,  1993,   217,   147,    98,  7347]) tensor([ 5139, 14184, 11319,  6034, 12266, 11128, 14547, 13965, 10877,  1742])
-------Step 6-------
tensor([12152,  3699, 13592,     0, 13913,  2495, 14400, 14622,  9644,   763]) tensor([ 2700, 11246, 13920,  4713, 12526,  5414,  4903,  5608,  3120, 14650])
-------Step 7-------
tensor([12152,  3699, 13592,     0, 13913,  2495, 14400, 14622,  9644,   763]) tensor([10332,  9293,  9501,   595, 13461,  7996,  1941,  2475,  7389,   982])
-------Step 8-------
tensor([ 4262,   121,  6002,  1426, 13308,   886,   237,  7960,  1713,  7227]) tensor([ 4857, 11699,    45, 13653,  8662,  3612,  7347,  8867,  7710, 13723])
-------Step 9-------
tensor([ 4262,   121,  6002,  1426, 13308,   886,   237,  7960,  1713,  7227]) tensor([13905,  5590, 10901,   340,  4070, 12672,  1609,  3711,  6116,  7296])
before start barrier
start train
[proc 0] 100 steps, total: 5.618, sample: 0.470, forward: 1.085, backward: 0.737, update: 0.253
E20240205 19:52:30.287011 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=183
E20240205 19:52:30.409956 28951 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=117, sample_step_cpp_seen_[rank]=116
W20240205 19:52:30.573838 29270 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end0
W20240205 19:52:30.854750 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=127, pq.top=127
E20240205 19:52:31.287014 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=15
W20240205 19:52:31.595566 29270 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 19:52:31.929842 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=151, pq.top=151
E20240205 19:52:32.287007 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=219
W20240205 19:52:32.598431 29270 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end5
W20240205 19:52:33.121820 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=174, pq.top=174
E20240205 19:52:33.287174 29131 parallel_pq_v2.h:79] insert failed, size(hashtable)=572
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.485 ms                  | 31.836 ms                 |
| Forward                   | 5.341 ms                  | 10.194 ms                 |
| Backward                  | 4.926 ms                  | 15.073 ms                 |
| Optimize                  | 2.445 ms                  | 5.068 ms                  |
| BarrierTimeBeforeRank0    | 32.623 us                 | 5.750 ms                  |
| AfterBackward             | 17.238 ms                 | 181.864 ms                |
| BlockToStepN              | 646.703 us                | 10.309 ms                 |
| OneStep                   | 35.398 ms                 | 196.884 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:33.603569 29270 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 352.413 us                | 6.972 ms                  |
| ProcessBack:Shuffle       | 1.648 ms                  | 2.740 ms                  |
| ProcessBack:UpdateCache   | 1.458 ms                  | 2.542 ms                  |
| ProcessBack:UpsertPq      | 13.126 ms                 | 24.859 ms                 |
| ProcessOneStep            | 17.674 ms                 | 181.822 ms                |
| BlockToStepN              | 610.660 us                | 10.251 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:34.128553 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=196, pq.top=196
E20240205 19:52:34.287026 29300 parallel_pq_v2.h:79] insert failed, size(hashtable)=11896
[proc 0] 200 steps, total: 4.665, sample: 0.562, forward: 0.519, backward: 0.491, update: 0.245
[proc 2] 200 steps, total: 4.666, sample: 0.444, forward: 0.501, backward: 0.499, update: 0.214
[proc 1] 200 steps, total: 4.666, sample: 0.467, forward: 0.509, backward: 0.597, update: 0.223
W20240205 19:52:34.725152 29270 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
W20240205 19:52:35.193377 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=214, pq.top=214
E20240205 19:52:35.287026 29279 parallel_pq_v2.h:79] insert failed, size(hashtable)=79
E20240205 19:52:35.412593 28951 grad_async_v2.h:404] Stalled in ProcessBackward: rank=2, step_no=218, sample_step_cpp_seen_[rank]=217
W20240205 19:52:35.900373 29270 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
W20240205 19:52:36.207971 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=237, pq.top=237
E20240205 19:52:36.287235 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=187
W20240205 19:52:36.900228 29270 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240205 19:52:37.287045 29284 parallel_pq_v2.h:79] insert failed, size(hashtable)=10583
W20240205 19:52:37.552099 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=266, pq.top=266
W20240205 19:52:37.931975 29270 grad_async_v2.h:137] Detect new sample comes, old_end9, new_end0
E20240205 19:52:38.287014 29280 parallel_pq_v2.h:79] insert failed, size(hashtable)=11069
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.428 ms                  | 32.843 ms                 |
| Forward                   | 5.267 ms                  | 7.685 ms                  |
| Backward                  | 4.977 ms                  | 10.494 ms                 |
| Optimize                  | 2.496 ms                  | 4.996 ms                  |
| BarrierTimeBeforeRank0    | 55.272 us                 | 25.309 ms                 |
| AfterBackward             | 16.908 ms                 | 280.514 ms                |
| BlockToStepN              | 881.885 us                | 16.104 ms                 |
| OneStep                   | 35.634 ms                 | 297.353 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:38.582111 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=284, pq.top=284
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 470.926 us                | 6.614 ms                  |
| ProcessBack:Shuffle       | 1.705 ms                  | 2.740 ms                  |
| ProcessBack:UpdateCache   | 1.430 ms                  | 2.479 ms                  |
| ProcessBack:UpsertPq      | 12.683 ms                 | 24.160 ms                 |
| ProcessOneStep            | 16.886 ms                 | 280.424 ms                |
| BlockToStepN              | 844.369 us                | 15.973 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:38.971091 29270 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
E20240205 19:52:39.287014 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=511
[proc 2] 300 steps, total: 4.948, sample: 0.423, forward: 0.507, backward: 0.536, update: 0.208
[proc 1] 300 steps, total: 4.948, sample: 0.395, forward: 0.512, backward: 0.560, update: 0.209
[proc 0] 300 steps, total: 4.948, sample: 0.451, forward: 0.499, backward: 0.493, update: 0.243
W20240205 19:52:40.091171 29270 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240205 19:52:40.242651 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=313, pq.top=313
E20240205 19:52:40.287011 29131 parallel_pq_v2.h:79] insert failed, size(hashtable)=412
E20240205 19:52:40.700136 28951 grad_async_v2.h:404] Stalled in ProcessBackward: rank=1, step_no=325, sample_step_cpp_seen_[rank]=324
W20240205 19:52:41.142750 29270 grad_async_v2.h:137] Detect new sample comes, old_end6, new_end2
E20240205 19:52:41.287025 29301 parallel_pq_v2.h:79] insert failed, size(hashtable)=1286
W20240205 19:52:41.578471 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=339, pq.top=339
W20240205 19:52:42.182312 29270 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end8
E20240205 19:52:42.287007 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=67
W20240205 19:52:42.599678 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=357, pq.top=357
E20240205 19:52:43.287020 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=314
W20240205 19:52:43.355392 29270 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.436 ms                  | 32.275 ms                 |
| Forward                   | 5.233 ms                  | 7.451 ms                  |
| Backward                  | 4.946 ms                  | 9.553 ms                  |
| Optimize                  | 2.480 ms                  | 4.917 ms                  |
| BarrierTimeBeforeRank0    | 34.853 us                 | 25.735 ms                 |
| AfterBackward             | 17.081 ms                 | 272.086 ms                |
| BlockToStepN              | 1.113 ms                  | 22.529 ms                 |
| OneStep                   | 36.197 ms                 | 297.353 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:43.608491 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=377, pq.top=377
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 567.936 us                | 8.007 ms                  |
| ProcessBack:Shuffle       | 1.733 ms                  | 2.740 ms                  |
| ProcessBack:UpdateCache   | 1.405 ms                  | 2.426 ms                  |
| ProcessBack:UpsertPq      | 12.835 ms                 | 24.072 ms                 |
| ProcessOneStep            | 17.044 ms                 | 271.996 ms                |
| BlockToStepN              | 1.083 ms                  | 22.473 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 19:52:44.287052 29296 parallel_pq_v2.h:79] insert failed, size(hashtable)=13501
W20240205 19:52:44.405854 29270 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end3
W20240205 19:52:44.648312 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=396, pq.top=396
[proc 2] 400 steps, total: 5.464, sample: 0.380, forward: 0.496, backward: 0.484, update: 0.203
[proc 1] 400 steps, total: 5.464, sample: 0.442, forward: 0.497, backward: 0.450, update: 0.208
[proc 0] 400 steps, total: 5.464, sample: 0.448, forward: 0.494, backward: 0.486, update: 0.243
E20240205 19:52:45.287006 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=811
W20240205 19:52:45.436218 29270 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240205 19:52:45.666796 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=416, pq.top=416
E20240205 19:52:46.287084 29274 parallel_pq_v2.h:79] insert failed, size(hashtable)=14338
W20240205 19:52:46.442196 29270 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240205 19:52:46.675812 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=436, pq.top=436
E20240205 19:52:47.287009 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=1883
W20240205 19:52:47.450579 29270 grad_async_v2.h:137] Detect new sample comes, old_end7, new_end1
W20240205 19:52:47.692613 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=455, pq.top=455
E20240205 19:52:48.287089 29270 parallel_pq_v2.h:79] insert failed, size(hashtable)=29
W20240205 19:52:48.456971 29270 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.510 ms                  | 32.843 ms                 |
| Forward                   | 5.147 ms                  | 7.171 ms                  |
| Backward                  | 4.926 ms                  | 8.546 ms                  |
| Optimize                  | 2.480 ms                  | 4.903 ms                  |
| BarrierTimeBeforeRank0    | 30.313 us                 | 28.129 ms                 |
| AfterBackward             | 18.508 ms                 | 270.493 ms                |
| BlockToStepN              | 1.405 ms                  | 16.104 ms                 |
| OneStep                   | 39.887 ms                 | 286.967 ms                |
+---------------------------+---------------------------+---------------------------+
W20240205 19:52:48.718905 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=474, pq.top=474
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 413.340 us                | 9.808 ms                  |
| ProcessBack:Shuffle       | 1.780 ms                  | 2.892 ms                  |
| ProcessBack:UpdateCache   | 1.392 ms                  | 2.081 ms                  |
| ProcessBack:UpsertPq      | 13.853 ms                 | 25.095 ms                 |
| ProcessOneStep            | 18.607 ms                 | 270.448 ms                |
| BlockToStepN              | 1.383 ms                  | 15.973 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240205 19:52:49.287006 28951 parallel_pq_v2.h:79] insert failed, size(hashtable)=1431
W20240205 19:52:49.468307 29270 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end9
W20240205 19:52:49.740954 28951 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=493, pq.top=493
[proc 1] 500 steps, total: 5.240, sample: 0.392, forward: 0.481, backward: 0.442, update: 0.200
[proc 0] 500 steps, total: 5.240, sample: 0.574, forward: 0.473, backward: 0.476, update: 0.242
[proc 2] 500 steps, total: 5.240, sample: 0.397, forward: 0.485, backward: 0.503, update: 0.204
Successfully xmh. training takes 25.93559718132019 seconds
before call kg_cache_controller.StopThreads()
W20240205 19:52:50.055181 28951 grad_async_v2.h:84] call StopThreads. PID = 28651
W20240205 19:52:50.055209 28951 grad_base.h:212] before processOneStepNegThread_.join();
W20240205 19:52:50.055480 28951 grad_base.h:214] after processOneStepNegThread_.join();
W20240205 19:52:50.055488 28951 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
W20240205 19:52:50.065057 28951 grad_async_v2.h:105] StopThreads done.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7f398841c790>
