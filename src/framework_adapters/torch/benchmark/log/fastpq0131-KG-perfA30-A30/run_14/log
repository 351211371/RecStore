WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240131 23:45:23.390448 3235197 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_FB15k_74', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [3235197 sampler.py:454] Start PreSampling
WARNING [3235197 sampler.py:532] Before construct renumbering_dict
WARNING [3235197 sampler.py:555] PreSampling done
W20240131 23:45:25.596944 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240131 23:45:25.597095 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240131 23:45:25.597118 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240131 23:45:25.597141 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240131 23:45:25.597163 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240131 23:45:25.597186 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240131 23:45:25.597203 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240131 23:45:25.597223 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240131 23:45:25.597239 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240131 23:45:25.597265 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240131 23:45:25.597291 3235197 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240131 23:45:25.597308 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240131 23:45:25.597328 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240131 23:45:25.597409 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240131 23:45:25.597433 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240131 23:45:25.597448 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240131 23:45:25.597483 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240131 23:45:25.597501 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240131 23:45:25.597518 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240131 23:45:25.597537 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240131 23:45:25.597553 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240131 23:45:25.597574 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240131 23:45:25.597590 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240131 23:45:25.597605 3235197 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240131 23:45:25.597618 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240131 23:45:25.597630 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240131 23:45:25.597662 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240131 23:45:25.597683 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240131 23:45:25.597698 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240131 23:45:25.597712 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240131 23:45:25.597728 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240131 23:45:25.597743 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240131 23:45:25.597764 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240131 23:45:25.597780 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240131 23:45:25.597798 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240131 23:45:25.597817 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240131 23:45:25.597832 3235197 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240131 23:45:25.597846 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240131 23:45:25.597859 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240131 23:45:25.597890 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240131 23:45:25.597908 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240131 23:45:25.597925 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240131 23:45:25.597942 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240131 23:45:25.597957 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240131 23:45:25.597972 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240131 23:45:25.597987 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240131 23:45:25.598001 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240131 23:45:25.598027 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240131 23:45:25.598045 3235197 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240131 23:45:25.598060 3235197 IPCTensor.h:369] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240131 23:45:25.598073 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240131 23:45:25.598091 3235197 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240131 23:45:25.749414 3235197 IPCTensor.h:369] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240131 23:45:25.777534 3235197 IPCTensor.h:369] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 186
Rank1: cached key size 186
Rank2: cached key size 186
Rank3: cached key size 186
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 858, 1033, 1109,  ..., 1710, 5775, 7539]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.417 seconds
[Rank1] pid = 3235409
[Rank2] pid = 3235474
INFO [3235197 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [3235409 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [3235538 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [3235474 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [3235538 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [3235474 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240131 23:45:29.017853 3235475 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_2 [747, 400]; dev=2; size=1.14 MB
W20240131 23:45:29.017875 3235540 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_3 [747, 400]; dev=3; size=1.14 MB
W20240131 23:45:29.018997 3235475 IPCTensor.h:369] NewIPCTensor: input_keys_2 [1000000]0x100014876000 7.629 MB
W20240131 23:45:29.019277 3235475 IPCTensor.h:369] NewIPCTensor: input_keys_neg_2 [1000000]0x100015019000 7.629 MB
W20240131 23:45:29.019424 3235475 IPCTensor.h:369] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000157bc000 1.49 GB
W20240131 23:45:29.019536 3235475 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x100074d9f000 1.49 GB
W20240131 23:45:29.019649 3235475 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
INFO [3235197 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [3235409 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240131 23:45:29.021960 3235539 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_0 [747, 400]; dev=0; size=1.14 MB
W20240131 23:45:29.022518 3235410 IPCTensor.h:409] NewIPCGPUTensor: embedding_cache_1 [747, 400]; dev=1; size=1.14 MB
W20240131 23:45:29.024071 3235540 IPCTensor.h:369] NewIPCTensor: input_keys_3 [1000000]0x1000d4384000 7.629 MB
W20240131 23:45:29.024217 3235540 IPCTensor.h:369] NewIPCTensor: input_keys_neg_3 [1000000]0x1000d4b27000 7.629 MB
W20240131 23:45:29.024281 3235540 IPCTensor.h:369] NewIPCTensor: backward_grads_3 [1000000, 400]0x1000d52ca000 1.49 GB
W20240131 23:45:29.024308 3235540 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001348ad000 1.49 GB
W20240131 23:45:29.024343 3235540 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240131 23:45:29.024623 3235539 IPCTensor.h:369] NewIPCTensor: input_keys_0 [1000000]0x100193e96000 7.629 MB
W20240131 23:45:29.024646 3235410 IPCTensor.h:369] NewIPCTensor: input_keys_1 [1000000]0x100194639000 7.629 MB
W20240131 23:45:29.024688 3235475 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240131 23:45:29.024803 3235410 IPCTensor.h:369] NewIPCTensor: input_keys_neg_1 [1000000]0x100194ddc000 7.629 MB
W20240131 23:45:29.024812 3235539 IPCTensor.h:369] NewIPCTensor: input_keys_neg_0 [1000000]0x10019557f000 7.629 MB
W20240131 23:45:29.024880 3235410 IPCTensor.h:369] NewIPCTensor: backward_grads_1 [1000000, 400]0x100195d22000 1.49 GB
W20240131 23:45:29.024899 3235539 IPCTensor.h:369] NewIPCTensor: backward_grads_0 [1000000, 400]0x1001f5305000 1.49 GB
W20240131 23:45:29.024933 3235410 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1002548e8000 1.49 GB
W20240131 23:45:29.024960 3235539 IPCTensor.h:369] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x1002b3ecb000 1.49 GB
W20240131 23:45:29.024986 3235410 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240131 23:45:29.025041 3235539 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240131 23:45:29.040475 3235410 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240131 23:45:29.040536 3235539 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240131 23:45:29.040637 3235540 IPCTensor.h:409] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [3235409 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [3235538 DistTensor.py:59] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [3235474 DistTensor.py:59] The tensor name already exists in the kvstore
[Rank3] pid = 3235538
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 747), (747, 1494), (1494, 2241), (2241, 2988)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [3235197 DistTensor.py:59] The tensor name already exists in the kvstore
I20240131 23:45:30.244810 3235539 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240131 23:45:30.245000 3235540 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240131 23:45:30.245153 3235475 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240131 23:45:30.245260 3235410 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240131 23:45:30.246253 3235539 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 0.01,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240131 23:45:30.246378 3235539 grad_base.h:184] Init GradProcessingBase done
I20240131 23:45:30.250733 3235539 grad_async_v2.h:42] Use main thread to update emb.
W20240131 23:45:30.250768 3235539 kg_controller.h:78] after init GradAsyncProcessingV2
I20240131 23:45:30.250774 3235539 kg_controller.h:84] Construct KGCacheController done
E20240131 23:45:31.611151 3235539 recstore.cc:66] init folly done
E20240131 23:45:31.611320 3235410 recstore.cc:66] init folly done
E20240131 23:45:31.611372 3235540 recstore.cc:66] init folly done
E20240131 23:45:31.611382 3235475 recstore.cc:66] init folly done
I20240131 23:45:31.612017 3235539 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240131 23:45:32.329381 3235919 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
E20240131 23:45:32.329739 3235919 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
I20240131 23:45:32.356981 3235539 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240131 23:45:32.358439 3235410 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240131 23:45:32.385334 3235475 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240131 23:45:32.386358 3235540 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240131 23:45:34.517757 3235539 parallel_pq_v2.h:79] insert failed, size(hashtable)=0
W20240131 23:45:34.528457 3235919 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
E20240131 23:45:34.542091 3235725 grad_async_v2.h:404] Stalled in ProcessBackward: rank=0, step_no=1, sample_step_cpp_seen_[rank]=0
W20240131 23:45:34.580621 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=3, pq.top=0
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.036 ms                  | 15.977 ms                 |
| Forward                   | 3.458 ms                  | 918.769 ms                |
| Backward                  | 2.903 ms                  | 251.620 ms                |
| Optimize                  | 1.291 ms                  | 57.385 ms                 |
| BarrierTimeBeforeRank0    | 829.274 us                | 2.869 ms                  |
| AfterBackward             | 14.203 ms                 | 910.805 ms                |
| BlockToStepN              | 264.053 us                | 4.889 ms                  |
| OneStep                   | 26.630 ms                 | 2.141 s                   |
+---------------------------+---------------------------+---------------------------+
E20240131 23:45:35.517007 3235725 parallel_pq_v2.h:79] insert failed, size(hashtable)=83
W20240131 23:45:35.535274 3235919 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end2
W20240131 23:45:35.589041 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=33, pq.top=33
E20240131 23:45:36.517006 3235539 parallel_pq_v2.h:79] insert failed, size(hashtable)=591
W20240131 23:45:36.539189 3235919 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 248.898 us                | 2.361 ms                  |
| ProcessBack:Shuffle       | 2.068 ms                  | 98.778 ms                 |
| ProcessBack:UpdateCache   | 1.810 ms                  | 178.132 ms                |
| ProcessBack:UpsertPq      | 10.850 ms                 | 16.791 ms                 |
| ProcessOneStep            | 16.546 ms                 | 150.399 ms                |
| BlockToStepN              | 302.930 us                | 1.360 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240131 23:45:36.612989 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=68, pq.top=68
E20240131 23:45:37.517068 3235946 parallel_pq_v2.h:79] insert failed, size(hashtable)=145
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 5.203, sample: 0.202, forward: 1.096, backward: 0.602, update: 0.148
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.204, sample: 0.186, forward: 1.085, backward: 0.690, update: 0.130
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.231, sample: 0.235, forward: 0.940, backward: 0.557, update: 0.157
train_sampler.Prefill()
-------Step 0-------
tensor([ 7440,  3958, 10271,  7709,  7682,  3813,   706,  4004, 11050, 12203]) tensor([ 1109,  7225, 10346,   693,  7304,  7065, 13387,  7343,  8225,  9710])
-------Step 1-------
tensor([ 7440,  3958, 10271,  7709,  7682,  3813,   706,  4004, 11050, 12203]) tensor([ 6126, 12696, 11642, 13812,  7210, 11067,  5058,  1611,  2035,  7728])
-------Step 2-------
tensor([ 9873,  2239,  4206,   178,  8171,  8801,  3991,  9786, 12495,  8142]) tensor([ 9192,  3443,  2891, 12080,  1607,  2292, 14156,  5597, 10929,  6098])
-------Step 3-------
tensor([ 9873,  2239,  4206,   178,  8171,  8801,  3991,  9786, 12495,  8142]) tensor([ 6034, 10747,  6425, 11345,  2109, 11429,  1652, 11640,  4580,   109])
-------Step 4-------
tensor([   26, 14785, 10978, 10822,  4567,  5643, 12419,  5857,  3284,  1290]) tensor([12584,  4605, 11148,  9436,  2920,  8733,  5592,   518,  8751, 13547])
-------Step 5-------
tensor([   26, 14785, 10978, 10822,  4567,  5643, 12419,  5857,  3284,  1290]) tensor([ 7517,  6890, 10255, 12902,  8071, 10348,  2817, 13517,  6542,  6700])
-------Step 6-------
tensor([12319,  3925,   391,   172, 11381,  9928, 14917, 10978,  8157,  6355]) tensor([ 2928, 10523,  8247, 10088, 11710, 14180,  1334,  2016, 10547, 13061])
-------Step 7-------
tensor([12319,  3925,   391,   172, 11381,  9928, 14917, 10978,  8157,  6355]) tensor([ 4669, 13021,  9666,  7418,  4557,   480,  7093,  6244,  9393, 13129])
-------Step 8-------
tensor([ 8906, 10229, 11921, 10946,  4549,  6548,  1062,  6652,  4706, 10727]) tensor([  391, 13473, 13421,   989,  9810, 11201,  1923,  9709,  9423,  8626])
-------Step 9-------
tensor([ 8906, 10229, 11921, 10946,  4549,  6548,  1062,  6652,  4706, 10727]) tensor([10375, 11577,   940,  3178,  1739, 13207,  5664,  2706,  2035, 13042])
before start barrier
start train
[proc 0] 100 steps, total: 5.232, sample: 0.276, forward: 1.262, backward: 0.553, update: 0.187
W20240131 23:45:37.614257 3235919 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end1
W20240131 23:45:37.614717 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=101, pq.top=101
E20240131 23:45:38.519246 3235919 parallel_pq_v2.h:79] insert failed, size(hashtable)=1
W20240131 23:45:38.618913 3235919 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end9
W20240131 23:45:38.874624 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=137, pq.top=137
E20240131 23:45:39.519019 3235948 parallel_pq_v2.h:79] insert failed, size(hashtable)=9055
W20240131 23:45:39.619470 3235919 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end0
E20240131 23:45:39.856731 3235539 grad_async_v2.h:404] Stalled in ProcessBackward: rank=3, step_no=168, sample_step_cpp_seen_[rank]=167
W20240131 23:45:39.928978 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=170, pq.top=170
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.093 ms                  | 16.391 ms                 |
| Forward                   | 3.360 ms                  | 5.869 ms                  |
| Backward                  | 2.635 ms                  | 5.818 ms                  |
| Optimize                  | 1.306 ms                  | 2.482 ms                  |
| BarrierTimeBeforeRank0    | 19.404 us                 | 2.869 ms                  |
| AfterBackward             | 15.090 ms                 | 159.254 ms                |
| BlockToStepN              | 413.963 us                | 2.640 ms                  |
| OneStep                   | 25.841 ms                 | 167.649 ms                |
+---------------------------+---------------------------+---------------------------+
E20240131 23:45:40.519016 3235539 parallel_pq_v2.h:79] insert failed, size(hashtable)=45
W20240131 23:45:40.635478 3235919 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
[proc 1] 200 steps, total: 3.239, sample: 0.193, forward: 0.276, backward: 0.283, update: 0.100
[proc 3] 200 steps, total: 3.239, sample: 0.214, forward: 0.268, backward: 0.242, update: 0.097
[proc 0] 200 steps, total: 3.239, sample: 0.290, forward: 0.315, backward: 0.253, update: 0.117
[proc 2] 200 steps, total: 3.239, sample: 0.244, forward: 0.273, backward: 0.243, update: 0.095
W20240131 23:45:40.967840 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=206, pq.top=206
E20240131 23:45:41.519013 3235942 parallel_pq_v2.h:79] insert failed, size(hashtable)=10513
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 231.653 us                | 3.032 ms                  |
| ProcessBack:Shuffle       | 2.103 ms                  | 2.548 ms                  |
| ProcessBack:UpdateCache   | 1.639 ms                  | 2.491 ms                  |
| ProcessBack:UpsertPq      | 9.589 ms                  | 16.058 ms                 |
| ProcessOneStep            | 15.075 ms                 | 159.222 ms                |
| BlockToStepN              | 365.942 us                | 4.239 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240131 23:45:41.635215 3235919 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240131 23:45:41.968048 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=243, pq.top=243
E20240131 23:45:42.519023 3235936 parallel_pq_v2.h:79] insert failed, size(hashtable)=1692
W20240131 23:45:42.639777 3235919 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240131 23:45:42.996098 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=275, pq.top=275
E20240131 23:45:43.519052 3235919 parallel_pq_v2.h:79] insert failed, size(hashtable)=2
W20240131 23:45:43.640923 3235919 grad_async_v2.h:137] Detect new sample comes, old_end2, new_end3
[proc 3] 300 steps, total: 3.094, sample: 0.217, forward: 0.276, backward: 0.234, update: 0.097
[proc 0] 300 steps, total: 3.094, sample: 0.223, forward: 0.287, backward: 0.258, update: 0.112
[proc 2] 300 steps, total: 3.094, sample: 0.227, forward: 0.278, backward: 0.239, update: 0.093
[proc 1] 300 steps, total: 3.095, sample: 0.224, forward: 0.307, backward: 0.282, update: 0.100
W20240131 23:45:44.012670 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=303, pq.top=303
E20240131 23:45:44.519052 3235919 parallel_pq_v2.h:79] insert failed, size(hashtable)=25
W20240131 23:45:44.641528 3235919 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240131 23:45:45.014885 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=331, pq.top=331
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.091 ms                  | 16.380 ms                 |
| Forward                   | 3.196 ms                  | 5.633 ms                  |
| Backward                  | 2.651 ms                  | 5.726 ms                  |
| Optimize                  | 1.222 ms                  | 2.390 ms                  |
| BarrierTimeBeforeRank0    | 22.338 us                 | 10.971 ms                 |
| AfterBackward             | 15.725 ms                 | 150.427 ms                |
| BlockToStepN              | 571.114 us                | 2.640 ms                  |
| OneStep                   | 26.127 ms                 | 160.838 ms                |
+---------------------------+---------------------------+---------------------------+
E20240131 23:45:45.519018 3235936 parallel_pq_v2.h:79] insert failed, size(hashtable)=7921
W20240131 23:45:45.645538 3235919 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end9
W20240131 23:45:46.049925 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=359, pq.top=359
E20240131 23:45:46.519007 3235539 parallel_pq_v2.h:79] insert failed, size(hashtable)=668
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 257.579 us                | 1.782 ms                  |
| ProcessBack:Shuffle       | 2.087 ms                  | 2.561 ms                  |
| ProcessBack:UpdateCache   | 1.619 ms                  | 2.460 ms                  |
| ProcessBack:UpsertPq      | 10.865 ms                 | 18.644 ms                 |
| ProcessOneStep            | 15.903 ms                 | 148.232 ms                |
| BlockToStepN              | 569.117 us                | 2.338 ms                  |
+---------------------------+---------------------------+---------------------------+
W20240131 23:45:46.657455 3235919 grad_async_v2.h:137] Detect new sample comes, old_end5, new_end6
W20240131 23:45:47.082211 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=387, pq.top=387
E20240131 23:45:47.519033 3235725 parallel_pq_v2.h:79] insert failed, size(hashtable)=211
[proc 3] 400 steps, total: 3.680, sample: 0.210, forward: 0.271, backward: 0.248, update: 0.097
[proc 2] 400 steps, total: 3.680, sample: 0.202, forward: 0.268, backward: 0.236, update: 0.091
[proc 0] 400 steps, total: 3.680, sample: 0.300, forward: 0.323, backward: 0.359, update: 0.124
[proc 1] 400 steps, total: 3.680, sample: 0.209, forward: 0.286, backward: 0.314, update: 0.098
W20240131 23:45:47.658054 3235919 grad_async_v2.h:137] Detect new sample comes, old_end1, new_end2
W20240131 23:45:48.092613 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=413, pq.top=413
E20240131 23:45:48.519088 3235919 parallel_pq_v2.h:79] insert failed, size(hashtable)=57
W20240131 23:45:48.665694 3235919 grad_async_v2.h:137] Detect new sample comes, old_end8, new_end9
W20240131 23:45:49.105639 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=440, pq.top=440
E20240131 23:45:49.519014 3235930 parallel_pq_v2.h:79] insert failed, size(hashtable)=9945
W20240131 23:45:49.665222 3235919 grad_async_v2.h:137] Detect new sample comes, old_end4, new_end5
W20240131 23:45:50.130048 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=467, pq.top=467
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.197 ms                  | 15.977 ms                 |
| Forward                   | 3.267 ms                  | 4.912 ms                  |
| Backward                  | 2.686 ms                  | 5.726 ms                  |
| Optimize                  | 1.265 ms                  | 2.411 ms                  |
| BarrierTimeBeforeRank0    | 23.538 us                 | 10.971 ms                 |
| AfterBackward             | 17.434 ms                 | 140.637 ms                |
| BlockToStepN              | 756.171 us                | 3.456 ms                  |
| OneStep                   | 31.875 ms                 | 150.260 ms                |
+---------------------------+---------------------------+---------------------------+
E20240131 23:45:50.519354 3235539 parallel_pq_v2.h:79] insert failed, size(hashtable)=60
W20240131 23:45:50.668074 3235919 grad_async_v2.h:137] Detect new sample comes, old_end0, new_end1
W20240131 23:45:51.162089 3235539 grad_async_v2.h:270] Sleep in <BlockToStepN>, step_no=493, pq.top=493
[proc 0] 500 steps, total: 3.831, sample: 0.317, forward: 0.319, backward: 0.287, update: 0.123
[proc 1] 500 steps, total: 3.831, sample: 0.214, forward: 0.305, backward: 0.283, update: 0.104
[proc 2] 500 steps, total: 3.831, sample: 0.240, forward: 0.273, backward: 0.231, update: 0.089
[proc 3] 500 steps, total: 3.831, sample: 0.158, forward: 0.243, backward: 0.313, update: 0.086
Successfully xmh. training takes 19.077462434768677 seconds
before call kg_cache_controller.StopThreads()
W20240131 23:45:51.434525 3235539 grad_async_v2.h:84] call StopThreads. PID = 3235197
W20240131 23:45:51.434552 3235539 grad_base.h:212] before processOneStepNegThread_.join();
W20240131 23:45:51.435057 3235539 grad_base.h:214] after processOneStepNegThread_.join();
W20240131 23:45:51.435068 3235539 grad_async_v2.h:86] call GradProcessingBase::StopThreads.
W20240131 23:45:51.436111 3235539 grad_async_v2.h:105] StopThreads done.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| clean                     | 311.128 us                | 2.781 ms                  |
| ProcessBack:Shuffle       | 2.111 ms                  | 2.570 ms                  |
| ProcessBack:UpdateCache   | 1.660 ms                  | 2.640 ms                  |
| ProcessBack:UpsertPq      | 12.451 ms                 | 19.456 ms                 |
| ProcessOneStep            | 18.574 ms                 | 140.604 ms                |
| BlockToStepN              | 755.072 us                | 3.428 ms                  |
+---------------------------+---------------------------+---------------------------+
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7efb8adf4390>
