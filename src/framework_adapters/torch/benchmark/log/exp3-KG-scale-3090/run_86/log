WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 20:57:45.829484 29415 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_33', no_save_emb=True, max_step=500, batch_size=1600, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [29415 sampler.py:454] Start PreSampling
WARNING [29415 sampler.py:532] Before construct renumbering_dict
WARNING [29415 sampler.py:555] PreSampling done
W20240123 21:09:58.958063 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000 781.2 kB
W20240123 21:09:58.958305 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000 781.2 kB
W20240123 21:09:58.958338 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000 781.2 kB
W20240123 21:09:58.958360 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000 781.2 kB
W20240123 21:09:58.958393 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000 781.2 kB
W20240123 21:09:58.958411 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000 781.2 kB
W20240123 21:09:58.958431 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000 781.2 kB
W20240123 21:09:58.958469 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000 781.2 kB
W20240123 21:09:58.958498 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000 781.2 kB
W20240123 21:09:58.958521 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000 781.2 kB
W20240123 21:09:58.958555 29415 IPCTensor.h:365] NewIPCTensor: step_r0 [10]0x1000007b4000 80 B 
W20240123 21:09:58.958573 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000 8 B 
W20240123 21:09:58.958597 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000 8 B 
W20240123 21:09:58.958750 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000 781.2 kB
W20240123 21:09:58.958798 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000 781.2 kB
W20240123 21:09:58.958818 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000 781.2 kB
W20240123 21:09:58.958838 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000 781.2 kB
W20240123 21:09:58.958880 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000 781.2 kB
W20240123 21:09:58.958901 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000 781.2 kB
W20240123 21:09:58.958922 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000 781.2 kB
W20240123 21:09:58.958940 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000 781.2 kB
W20240123 21:09:58.958961 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000 781.2 kB
W20240123 21:09:58.958987 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000 781.2 kB
W20240123 21:09:58.959007 29415 IPCTensor.h:365] NewIPCTensor: step_r1 [10]0x100000f6c000 80 B 
W20240123 21:09:58.959020 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000 8 B 
W20240123 21:09:58.959034 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000 8 B 
W20240123 21:09:58.959079 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_0 [100000]0x100000f72000 781.2 kB
W20240123 21:09:58.959115 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_1 [100000]0x100001037000 781.2 kB
W20240123 21:09:58.959136 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_2 [100000]0x1000010fc000 781.2 kB
W20240123 21:09:58.959151 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_3 [100000]0x1000011c1000 781.2 kB
W20240123 21:09:58.959173 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_4 [100000]0x100001286000 781.2 kB
W20240123 21:09:58.959194 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_5 [100000]0x10000134b000 781.2 kB
W20240123 21:09:58.959219 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_6 [100000]0x100001410000 781.2 kB
W20240123 21:09:58.959241 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_7 [100000]0x1000014d5000 781.2 kB
W20240123 21:09:58.959261 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_8 [100000]0x10000159a000 781.2 kB
W20240123 21:09:58.959287 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_9 [100000]0x10000165f000 781.2 kB
W20240123 21:09:58.959314 29415 IPCTensor.h:365] NewIPCTensor: step_r2 [10]0x100001724000 80 B 
W20240123 21:09:58.959327 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r2 [1]0x100001726000 8 B 
W20240123 21:09:58.959347 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x100001728000 8 B 
W20240123 21:09:58.959385 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_0 [100000]0x10000172a000 781.2 kB
W20240123 21:09:58.959409 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_1 [100000]0x1000017ef000 781.2 kB
W20240123 21:09:58.959429 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_2 [100000]0x1000018b4000 781.2 kB
W20240123 21:09:58.959446 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_3 [100000]0x100001979000 781.2 kB
W20240123 21:09:58.959467 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_4 [100000]0x100001a3e000 781.2 kB
W20240123 21:09:58.959487 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_5 [100000]0x100001b03000 781.2 kB
W20240123 21:09:58.959518 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_6 [100000]0x100001bc8000 781.2 kB
W20240123 21:09:58.959548 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_7 [100000]0x100001c8d000 781.2 kB
W20240123 21:09:58.959578 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_8 [100000]0x100001d52000 781.2 kB
W20240123 21:09:58.959597 29415 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_9 [100000]0x100001e17000 781.2 kB
W20240123 21:09:58.959625 29415 IPCTensor.h:365] NewIPCTensor: step_r3 [10]0x100001edc000 80 B 
W20240123 21:09:58.959637 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r3 [1]0x100001ede000 8 B 
W20240123 21:09:58.959663 29415 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100001ee0000 8 B 
{0: Graph(num_nodes=27256011, num_edges=100992629,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=23779591, num_edges=94535774,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=26463902, num_edges=75890617,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=25398646, num_edges=93789131,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 27256011 N 100992629 E
MertisPartition: part 1 has 23779591 N 94535774 E
MertisPartition: part 2 has 26463902 N 75890617 E
MertisPartition: part 3 has 25398646 N 93789131 E
Rank0: cached key size 1075676
Rank1: cached key size 1075676
Rank2: cached key size 1075676
Rank3: cached key size 1075676
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 82487883, 64859130, 64482679]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 3, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 4302704,  4302707,   312234,  ...,  3593921, 12116725, 80516615]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 3, 3, 3])}
part_g: DGLGraph(num_nodes=27256011, num_edges=100992629,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=27256011, num_edges=100992629,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 987.643 seconds
[Rank1] pid = 54660
[Rank2] pid = 54842
INFO [29415 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [54660 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [54842 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [55009 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [54842 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [55009 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [29415 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [54660 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
I20240123 21:14:28.986024 54843 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240123 21:14:31.623484 55010 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 21:14:33.489008 54664 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 21:14:34.348748 55042 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.482 ms                  | 67.107 ms                 |
| Forward                   | 8.874 ms                  | 26.182 ms                 |
| Backward                  | 4.162 ms                  | 4.575 ms                  |
| Optimize                  | 6.834 ms                  | 10.559 ms                 |
| OneStep                   | 33.588 ms                 | 118.924 ms                |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 9.934, sample: 0.683, forward: 2.041, backward: 0.539, update: 0.769
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 7.296, sample: 0.693, forward: 2.149, backward: 0.564, update: 0.810
[Rank3] pid = 55009
train_sampler.Prefill()
-------Step 0-------
tensor([  791026,  4637394,   791067,   791109,   791157,   791205, 55671935,
          201275,  4310804,   791241]) tensor([ 5143070, 32882953, 18041630, 40820696, 69181525, 26192260, 71922807,
        56120498, 67288856, 38080860])
-------Step 1-------
tensor([  791026,  4637394,   791067,   791109,   791157,   791205, 55671935,
          201275,  4310804,   791241]) tensor([17575640, 31178134, 19509366, 67032158, 78841401, 39016456, 59608094,
        28397928, 19969131, 58421726])
-------Step 2-------
tensor([  872678,   872704,   872737,   872764,   872780, 30054488,   410152,
          993263,   872803,   872824]) tensor([ 9308494, 41445327, 53154269, 68487278, 55438363,  6696696,  7170073,
        33891664, 73608324, 59641090])
-------Step 3-------
tensor([  872678,   872704,   872737,   872764,   872780, 30054488,   410152,
          993263,   872803,   872824]) tensor([41026092, 44087437, 61730593, 40798101, 11817411, 19346952, 55434371,
         2097428, 50412399, 14587064])
-------Step 4-------
tensor([910861, 910881, 910899, 910915, 910931, 910947, 910962, 910424, 910979,
        998751]) tensor([84441138, 44849697, 79647818, 52689878, 59534057, 19561474, 21611337,
         5413651, 56352369,  4989818])
-------Step 5-------
tensor([910861, 910881, 910899, 910915, 910931, 910947, 910962, 910424, 910979,
        998751]) tensor([28714893, 55473502, 14921932, 33066435, 31917967, 17659251, 56441071,
        55491108,   694920, 82580037])
-------Step 6-------
tensor([  947308,   947330,   947346, 72859131,   417221,   947364,   947382,
          947402,   947423,   947436]) tensor([ 9540817, 82531558, 82011777, 45666979, 70445669, 32659604, 70243284,
          831189, 71155298, 55504264])
-------Step 7-------
tensor([  947308,   947330,   947346, 72859131,   417221,   947364,   947382,
          947402,   947423,   947436]) tensor([15542837, 81887581, 85583847, 83789849, 72897162, 35790140, 82834288,
        78416888, 80390151, 73415287])
-------Step 8-------
tensor([  983960,   983981,   983992,   984006, 47099092,  1009246,   984021,
         1009265,   912149,   984039]) tensor([  276276, 30412153, 47025059, 49739176, 12476905,  2089255, 48229352,
        32885757, 35780146, 58770615])
-------Step 9-------
tensor([  983960,   983981,   983992,   984006, 47099092,  1009246,   984021,
         1009265,   912149,   984039]) tensor([73175807, 80635559,  4599842, 14733006, 51212427, 35388838, 42452157,
        14404996,  8366422, 12478416])
before start barrier
start train
[proc 0] 100 steps, total: 4.571, sample: 0.802, forward: 1.474, backward: 0.568, update: 0.693
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.431, sample: 0.730, forward: 1.984, backward: 0.563, update: 0.827
[proc 1] 200 steps, total: 3.311, sample: 0.527, forward: 1.274, backward: 0.390, update: 0.764
[proc 0] 200 steps, total: 3.311, sample: 0.583, forward: 0.854, backward: 0.410, update: 0.700
[proc 3] 200 steps, total: 3.311, sample: 0.533, forward: 1.333, backward: 0.390, update: 0.764
[proc 2] 200 steps, total: 3.311, sample: 0.493, forward: 1.292, backward: 0.301, update: 0.705
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 2.405 ms                  | 65.511 ms                 |
| Forward                   | 8.459 ms                  | 25.870 ms                 |
| Backward                  | 4.147 ms                  | 5.281 ms                  |
| Optimize                  | 6.798 ms                  | 10.559 ms                 |
| OneStep                   | 28.871 ms                 | 96.403 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 2] 300 steps, total: 3.326, sample: 0.426, forward: 1.246, backward: 0.353, update: 0.715
[proc 1] 300 steps, total: 3.326, sample: 0.457, forward: 1.291, backward: 0.396, update: 0.776
[proc 3] 300 steps, total: 3.326, sample: 0.511, forward: 1.305, backward: 0.415, update: 0.745
[proc 0] 300 steps, total: 3.326, sample: 0.490, forward: 0.874, backward: 0.417, update: 0.714
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 2.020 ms                  | 55.287 ms                 |
| Forward                   | 8.381 ms                  | 25.111 ms                 |
| Backward                  | 4.114 ms                  | 5.172 ms                  |
| Optimize                  | 6.804 ms                  | 10.750 ms                 |
| OneStep                   | 28.224 ms                 | 86.696 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 0] 400 steps, total: 3.214, sample: 0.488, forward: 0.829, backward: 0.393, update: 0.705
[proc 3] 400 steps, total: 3.214, sample: 0.539, forward: 1.255, backward: 0.390, update: 0.768
[proc 1] 400 steps, total: 3.214, sample: 0.446, forward: 1.196, backward: 0.411, update: 0.756
[proc 2] 400 steps, total: 3.214, sample: 0.445, forward: 1.224, backward: 0.389, update: 0.735
[proc 1] 500 steps, total: 3.358, sample: 0.522, forward: 1.190, backward: 0.390, update: 0.778
[proc 2] 500 steps, total: 3.358, sample: 0.475, forward: 1.210, backward: 0.400, update: 0.704
[proc 3] 500 steps, total: 3.358, sample: 0.589, forward: 1.211, backward: 0.391, update: 0.754
[proc 0] 500 steps, total: 3.358, sample: 0.635, forward: 0.865, backward: 0.424, update: 0.716
Successfully xmh. training takes 17.78037691116333 seconds
before call kg_cache_controller.StopThreads()
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 2.080 ms                  | 55.287 ms                 |
| Forward                   | 8.348 ms                  | 25.111 ms                 |
| Backward                  | 4.087 ms                  | 5.172 ms                  |
| Optimize                  | 6.830 ms                  | 12.133 ms                 |
| OneStep                   | 28.115 ms                 | 85.564 ms                 |
+---------------------------+---------------------------+---------------------------+
