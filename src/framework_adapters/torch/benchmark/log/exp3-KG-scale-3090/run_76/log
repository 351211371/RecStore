WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 17:36:40.355614  8631 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_23', no_save_emb=True, max_step=500, batch_size=2000, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [8631 sampler.py:454] Start PreSampling
WARNING [8631 sampler.py:532] Before construct renumbering_dict
WARNING [8631 sampler.py:555] PreSampling done
W20240123 17:49:01.989907  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000 781.2 kB
W20240123 17:49:01.990149  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000 781.2 kB
W20240123 17:49:01.990178  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000 781.2 kB
W20240123 17:49:01.990196  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000 781.2 kB
W20240123 17:49:01.990217  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000 781.2 kB
W20240123 17:49:01.990237  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000 781.2 kB
W20240123 17:49:01.990258  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000 781.2 kB
W20240123 17:49:01.990285  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000 781.2 kB
W20240123 17:49:01.990316  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000 781.2 kB
W20240123 17:49:01.990345  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000 781.2 kB
W20240123 17:49:01.990372  8631 IPCTensor.h:365] NewIPCTensor: step_r0 [10]0x1000007b4000 80 B 
W20240123 17:49:01.990391  8631 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000 8 B 
W20240123 17:49:01.990407  8631 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000 8 B 
W20240123 17:49:01.990545  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000 781.2 kB
W20240123 17:49:01.990576  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000 781.2 kB
W20240123 17:49:01.990600  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000 781.2 kB
W20240123 17:49:01.990617  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000 781.2 kB
W20240123 17:49:01.990656  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000 781.2 kB
W20240123 17:49:01.990674  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000 781.2 kB
W20240123 17:49:01.990697  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000 781.2 kB
W20240123 17:49:01.990723  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000 781.2 kB
W20240123 17:49:01.990742  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000 781.2 kB
W20240123 17:49:01.990767  8631 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000 781.2 kB
W20240123 17:49:01.990784  8631 IPCTensor.h:365] NewIPCTensor: step_r1 [10]0x100000f6c000 80 B 
W20240123 17:49:01.990799  8631 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000 8 B 
W20240123 17:49:01.990814  8631 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000 8 B 
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2151353
Rank1: cached key size 2151353
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4302756,  4302783,   750449,  ..., 23169280, 30355089, 63250226]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1006.768 seconds
INFO [8631 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [8631 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [34570 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [34570 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
I20240123 17:53:55.850570 34581 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
I20240123 17:53:57.079520 34571 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.457 ms                  | 89.150 ms                 |
| Forward                   | 8.846 ms                  | 646.628 ms                |
| Backward                  | 4.109 ms                  | 194.394 ms                |
| Optimize                  | 8.560 ms                  | 25.020 ms                 |
| OneStep                   | 39.488 ms                 | 866.014 ms                |
+---------------------------+---------------------------+---------------------------+
[Rank1] pid = 34570
train_sampler.Prefill()
-------Step 0-------
tensor([1548105, 1548131, 1548150,  953579, 1548176, 1548200, 1548228,   24369,
        1548254, 1548280]) tensor([  128011,  4571955, 15459935, 47093501, 33910475, 15711987, 71630488,
         9503819, 42803302, 58584434])
-------Step 1-------
tensor([1548105, 1548131, 1548150,  953579, 1548176, 1548200, 1548228,   24369,
        1548254, 1548280]) tensor([63240641, 67253508, 65969599, 38217538, 42598442,   198086, 29158237,
        52319287, 74184676, 83171004])
-------Step 2-------
tensor([1620464, 1620487, 1620510, 1620538, 1620558, 1620582, 1620608, 1620630,
         959635, 1620661]) tensor([17911983, 16336250, 41068755, 78747094, 33250227,  1273997, 38793155,
        50325545, 58818616, 13981276])
-------Step 3-------
tensor([1620464, 1620487, 1620510, 1620538, 1620558, 1620582, 1620608, 1620630,
         959635, 1620661]) tensor([47541308, 85196553,  2282808, 28409879, 53340571, 39969334, 31365236,
        46291675, 57275154, 22851946])
-------Step 4-------
tensor([ 1691127,  1691154,   435173,  1691174,   435214, 49894952,  1071057,
         1691195,  1691213,  1691235]) tensor([  587199, 76704387, 26089659, 35258961, 76159046, 53758118, 50406654,
        29948457, 25707615, 36801736])
-------Step 5-------
tensor([ 1691127,  1691154,   435173,  1691174,   435214, 49894952,  1071057,
         1691195,  1691213,  1691235]) tensor([49889476, 36009081, 52070204, 18035114, 22629445, 67447151, 53363729,
        11218720, 63147180, 81849681])
-------Step 6-------
tensor([ 1758308,  1758334,  1758356,   618667,  1758380,  1758391,  1758418,
        15852625,  1758441,  4327900]) tensor([16094915, 30703723,  6638689,  1586809, 16906199, 16538652,  2663604,
         1756394, 79109099, 22953781])
-------Step 7-------
tensor([ 1758308,  1758334,  1758356,   618667,  1758380,  1758391,  1758418,
        15852625,  1758441,  4327900]) tensor([63111869, 65504996, 68583843,  1331832, 10459288, 36759006, 71693377,
        82368159, 61254556, 10903076])
-------Step 8-------
tensor([1823615, 1823632, 1823649,  620645, 1823663, 1823680, 1823693,  438903,
        1823717, 1823739]) tensor([83051903, 83080801,   624076,  4343407, 43261188, 29221178, 75287127,
        71927582, 36864824, 23192158])
-------Step 9-------
tensor([1823615, 1823632, 1823649,  620645, 1823663, 1823680, 1823693,  438903,
        1823717, 1823739]) tensor([  645761, 36697807, 17890359, 61505463, 35941985,  1278954, 20199137,
        36350118, 27660322, 68603443])
before start barrier
start train
[proc 0] 100 steps, total: 6.265, sample: 1.111, forward: 1.513, backward: 0.608, update: 0.911
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.037, sample: 1.006, forward: 2.296, backward: 0.574, update: 0.971
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.195 ms                  | 82.297 ms                 |
| Forward                   | 8.323 ms                  | 20.203 ms                 |
| Backward                  | 4.062 ms                  | 4.651 ms                  |
| Optimize                  | 8.378 ms                  | 20.876 ms                 |
| OneStep                   | 32.884 ms                 | 114.807 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 200 steps, total: 3.711, sample: 0.807, forward: 0.893, backward: 0.397, update: 0.838
[proc 1] 200 steps, total: 3.711, sample: 0.852, forward: 1.463, backward: 0.393, update: 0.897
[proc 0] 300 steps, total: 3.438, sample: 0.674, forward: 0.820, backward: 0.431, update: 0.859
[proc 1] 300 steps, total: 3.438, sample: 0.582, forward: 1.428, backward: 0.394, update: 0.923
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.009 ms                  | 73.188 ms                 |
| Forward                   | 8.243 ms                  | 23.624 ms                 |
| Backward                  | 4.061 ms                  | 19.534 ms                 |
| Optimize                  | 8.370 ms                  | 20.876 ms                 |
| OneStep                   | 31.196 ms                 | 111.187 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 3.492, sample: 0.681, forward: 1.294, backward: 0.463, update: 0.916
[proc 0] 400 steps, total: 3.492, sample: 0.689, forward: 0.862, backward: 0.424, update: 0.836
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.019 ms                  | 70.662 ms                 |
| Forward                   | 8.112 ms                  | 23.624 ms                 |
| Backward                  | 4.060 ms                  | 4.651 ms                  |
| Optimize                  | 8.334 ms                  | 13.121 ms                 |
| OneStep                   | 29.633 ms                 | 108.224 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 500 steps, total: 3.225, sample: 0.653, forward: 0.800, backward: 0.398, update: 0.833
[proc 1] 500 steps, total: 3.225, sample: 0.625, forward: 1.223, backward: 0.374, update: 0.835
Successfully xmh. training takes 20.13176703453064 seconds
before call kg_cache_controller.StopThreads()
