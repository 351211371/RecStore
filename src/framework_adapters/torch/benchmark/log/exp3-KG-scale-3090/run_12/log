WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 01:40:35.828217   473 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_27', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KGExternelEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='PySync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [473 sampler.py:454] Start PreSampling
WARNING [473 sampler.py:532] Before construct renumbering_dict
WARNING [473 sampler.py:555] PreSampling done
W20240123 01:40:38.550065   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000
W20240123 01:40:38.550376   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000
W20240123 01:40:38.550412   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000
W20240123 01:40:38.550446   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000
W20240123 01:40:38.550468   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000
W20240123 01:40:38.550516   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000
W20240123 01:40:38.550549   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000
W20240123 01:40:38.550586   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000
W20240123 01:40:38.550616   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000
W20240123 01:40:38.550643   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000
W20240123 01:40:38.550683   473 IPCTensor.h:367] NewIPCTensor: step_r0 [10]0x1000007b4000
W20240123 01:40:38.550704   473 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000
W20240123 01:40:38.550724   473 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000
W20240123 01:40:38.550850   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000
W20240123 01:40:38.550882   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000
W20240123 01:40:38.550904   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000
W20240123 01:40:38.550923   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000
W20240123 01:40:38.550964   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000
W20240123 01:40:38.551007   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000
W20240123 01:40:38.551029   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000
W20240123 01:40:38.551095   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000
W20240123 01:40:38.551142   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000
W20240123 01:40:38.551164   473 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000
W20240123 01:40:38.551184   473 IPCTensor.h:367] NewIPCTensor: step_r1 [10]0x100000f6c000
W20240123 01:40:38.551201   473 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000
W20240123 01:40:38.551221   473 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000
W20240123 01:40:38.743968   473 IPCTensor.h:367] NewIPCTensor: full_emb [14951, 400]0x100000f72000
W20240123 01:40:38.744110   473 IPCTensor.h:367] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100002644000
{0: Graph(num_nodes=13500, num_edges=273181,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=12803, num_edges=385691,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 13500 N 273181 E
MertisPartition: part 1 has 12803 N 385691 E
Rank0: cached key size 373
Rank1: cached key size 373
Before renumbering graph:  {'_ID': tensor([    0,     2,     6,  ..., 11079,  2237, 14365]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([  765,   819,   924,  ..., 11643, 12608, 11177]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=13500, num_edges=273181,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=13500, num_edges=273181,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.953 seconds
INFO [1054 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [473 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [473 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [1054 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
WARNING [473 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [1054 DistTensor.py:56] The tensor name already exists in the kvstore
I20240123 01:40:40.414623  1056 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 2
I20240123 01:40:40.414716  1055 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 2
I20240123 01:40:40.708062  1056 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
I20240123 01:40:40.715566  1055 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.752 ms                  | 25.420 ms                 |
| Forward                   | 8.945 ms                  | 11.176 ms                 |
| Backward                  | 52.416 ms                 | 63.015 ms                 |
| Optimize                  | 2.148 ms                  | 4.126 ms                  |
| BarrierTimeBeforeRank0    | 910.986 us                | 9.509 ms                  |
| BlockToStepN              | 22.394 us                 | 32.686 us                 |
| OneStep                   | 68.543 ms                 | 86.419 ms                 |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 7.546, sample: 0.409, forward: 1.323, backward: 5.440, update: 0.213
[Rank1] pid = 1054
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KGExternelEmbedding
fixed cache_range is [(0, 747), (747, 1494)]
train_sampler.Prefill()
-------Step 0-------
tensor([  950, 11738,  5142,  9484,    62,  8843, 12494,     5,  4356, 14543]) tensor([  957,  4491,  7102,  3494, 12617,  5943, 13226,  7414,  9012, 12564])
-------Step 1-------
tensor([  950, 11738,  5142,  9484,    62,  8843, 12494,     5,  4356, 14543]) tensor([13485,  9666, 11403, 14736,  5293,  4226,  7459,  1484, 11338,  4692])
-------Step 2-------
tensor([ 4970,    23,  5076,  9835,  2199,  8701,  3735, 11080,  3372,  4583]) tensor([ 9249,  6367,  5274,  4545, 14551,  3032,   384,  6248, 14223,  3671])
-------Step 3-------
tensor([ 4970,    23,  5076,  9835,  2199,  8701,  3735, 11080,  3372,  4583]) tensor([ 9901, 12258, 14162, 12633,  1574,  7959,  8266,  8051,  7019,  6569])
-------Step 4-------
tensor([  108,  3884,   910, 11816,  7186,   104,   139,  5469,   236,    26]) tensor([12652,  7162,  5152,  4202,  1906, 13225, 14225,  8293,  6377,  2913])
-------Step 5-------
tensor([  108,  3884,   910, 11816,  7186,   104,   139,  5469,   236,    26]) tensor([ 3742,  1767,  3038, 12001, 10725,   844,  9246,  4073, 14756,  1585])
-------Step 6-------
tensor([13239,  9219, 11774, 12226,  6583,   121,  3325,  6731,  4831,  2095]) tensor([ 8038,  6588,  1082, 14771, 14309, 14041, 13979,  6662, 14950,  3011])
-------Step 7-------
tensor([13239,  9219, 11774, 12226,  6583,   121,  3325,  6731,  4831,  2095]) tensor([ 5980,   288,  7862,  4230,  2944,  5726,  9846, 14011, 14647,  9415])
-------Step 8-------
tensor([ 2890,  2148, 10893, 14500, 10704,  8346, 10339,  6423,   187,  4240]) tensor([ 3365,  9866, 13217,  6189,  4163,  8592, 13519,  7370, 11029,  2241])
-------Step 9-------
tensor([ 2890,  2148, 10893, 14500, 10704,  8346, 10339,  6423,   187,  4240]) tensor([14897,  6404,  9571,  1100, 10590,  1314,  7459,  4818, 13176, 12747])
before start barrier
start train
[proc 0] 100 steps, total: 7.553, sample: 0.437, forward: 1.326, backward: 5.324, update: 0.211
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.767 ms                  | 26.157 ms                 |
| Forward                   | 8.799 ms                  | 12.376 ms                 |
| Backward                  | 51.990 ms                 | 92.121 ms                 |
| Optimize                  | 2.217 ms                  | 4.495 ms                  |
| BarrierTimeBeforeRank0    | 508.551 us                | 9.509 ms                  |
| BlockToStepN              | 22.367 us                 | 40.601 us                 |
| OneStep                   | 68.044 ms                 | 103.173 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.784 ms                  | 25.830 ms                 |
| Forward                   | 8.760 ms                  | 12.376 ms                 |
| Backward                  | 52.614 ms                 | 99.957 ms                 |
| Optimize                  | 2.226 ms                  | 4.834 ms                  |
| BarrierTimeBeforeRank0    | 208.099 us                | 19.640 ms                 |
| BlockToStepN              | 22.499 us                 | 45.139 us                 |
| OneStep                   | 69.750 ms                 | 129.392 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 200 steps, total: 8.892, sample: 0.469, forward: 0.839, backward: 6.938, update: 0.246
[proc 1] 200 steps, total: 8.892, sample: 0.313, forward: 0.680, backward: 5.861, update: 0.176
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.784 ms                  | 25.830 ms                 |
| Forward                   | 8.748 ms                  | 12.567 ms                 |
| Backward                  | 54.359 ms                 | 101.456 ms                |
| Optimize                  | 2.219 ms                  | 4.834 ms                  |
| BarrierTimeBeforeRank0    | 93.208 us                 | 19.640 ms                 |
| BlockToStepN              | 25.042 us                 | 55.143 us                 |
| OneStep                   | 74.736 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.784 ms                  | 25.420 ms                 |
| Forward                   | 8.756 ms                  | 12.376 ms                 |
| Backward                  | 61.600 ms                 | 101.456 ms                |
| Optimize                  | 2.222 ms                  | 4.834 ms                  |
| BarrierTimeBeforeRank0    | 80.546 us                 | 18.750 ms                 |
| BlockToStepN              | 28.059 us                 | 66.737 us                 |
| OneStep                   | 85.174 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 300 steps, total: 9.808, sample: 0.201, forward: 0.526, backward: 5.297, update: 0.144
[proc 0] 300 steps, total: 9.808, sample: 0.433, forward: 0.831, backward: 8.236, update: 0.226
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.784 ms                  | 25.420 ms                 |
| Forward                   | 8.819 ms                  | 12.376 ms                 |
| Backward                  | 74.770 ms                 | 102.134 ms                |
| Optimize                  | 2.217 ms                  | 4.834 ms                  |
| BarrierTimeBeforeRank0    | 70.537 us                 | 18.750 ms                 |
| BlockToStepN              | 29.351 us                 | 83.122 us                 |
| OneStep                   | 88.236 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.779 ms                  | 25.608 ms                 |
| Forward                   | 8.823 ms                  | 12.376 ms                 |
| Backward                  | 75.984 ms                 | 102.134 ms                |
| Optimize                  | 2.213 ms                  | 4.819 ms                  |
| BarrierTimeBeforeRank0    | 64.294 us                 | 18.498 ms                 |
| BlockToStepN              | 27.958 us                 | 95.263 us                 |
| OneStep                   | 88.808 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 9.880, sample: 0.214, forward: 0.505, backward: 5.387, update: 0.159
[proc 0] 400 steps, total: 9.880, sample: 0.438, forward: 0.851, backward: 8.303, update: 0.210
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.778 ms                  | 25.608 ms                 |
| Forward                   | 8.826 ms                  | 12.567 ms                 |
| Backward                  | 76.527 ms                 | 102.134 ms                |
| Optimize                  | 2.204 ms                  | 4.819 ms                  |
| BarrierTimeBeforeRank0    | 60.966 us                 | 18.498 ms                 |
| BlockToStepN              | 24.521 us                 | 95.263 us                 |
| OneStep                   | 89.790 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.773 ms                  | 25.830 ms                 |
| Forward                   | 8.826 ms                  | 12.376 ms                 |
| Backward                  | 76.754 ms                 | 101.456 ms                |
| Optimize                  | 2.202 ms                  | 4.818 ms                  |
| BarrierTimeBeforeRank0    | 58.452 us                 | 13.173 ms                 |
| BlockToStepN              | 22.394 us                 | 83.122 us                 |
| OneStep                   | 90.030 ms                 | 130.470 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 500 steps, total: 9.560, sample: 0.217, forward: 0.501, backward: 5.537, update: 0.195
[proc 0] 500 steps, total: 9.559, sample: 0.452, forward: 0.839, backward: 7.981, update: 0.212
Successfully xmh. training takes 45.69288516044617 seconds
before call kg_cache_controller.StopThreads()
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
INFO [473 controller_process.py:380] call rank0 to StopThreads
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
