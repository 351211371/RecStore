WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 03:58:17.433729 21969 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_1', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [21969 sampler.py:454] Start PreSampling
WARNING [21969 sampler.py:532] Before construct renumbering_dict
WARNING [21969 sampler.py:555] PreSampling done
W20240123 04:10:24.438472 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000
W20240123 04:10:24.438691 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000
W20240123 04:10:24.438724 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000
W20240123 04:10:24.438752 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000
W20240123 04:10:24.438776 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000
W20240123 04:10:24.438802 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000
W20240123 04:10:24.438829 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000
W20240123 04:10:24.438860 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000
W20240123 04:10:24.438889 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000
W20240123 04:10:24.438921 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000
W20240123 04:10:24.438957 21969 IPCTensor.h:367] NewIPCTensor: step_r0 [10]0x1000007b4000
W20240123 04:10:24.438977 21969 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000
W20240123 04:10:24.438995 21969 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000
W20240123 04:10:24.439149 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000
W20240123 04:10:24.439178 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000
W20240123 04:10:24.439203 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000
W20240123 04:10:24.439224 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000
W20240123 04:10:24.439244 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000
W20240123 04:10:24.439288 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000
W20240123 04:10:24.439308 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000
W20240123 04:10:24.439332 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000
W20240123 04:10:24.439354 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000
W20240123 04:10:24.439378 21969 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000
W20240123 04:10:24.439399 21969 IPCTensor.h:367] NewIPCTensor: step_r1 [10]0x100000f6c000
W20240123 04:10:24.439414 21969 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000
W20240123 04:10:24.439435 21969 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2147078
Rank1: cached key size 2004385
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4151526,  4151547,   378777,  ..., 27665539, 26105539, 76991056]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 981.625 seconds
INFO [21969 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [46808 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [21969 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [46808 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
I20240123 04:15:05.142297 46809 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
I20240123 04:15:06.595005 46826 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.110, sample: 0.697, forward: 1.624, backward: 0.548, update: 0.609
[Rank1] pid = 46808
train_sampler.Prefill()
-------Step 0-------
tensor([347398, 347443, 347477, 347506, 347547, 347580, 347624,  31039, 347653,
        347687]) tensor([   71197,  4625747, 18004311, 55069251, 29217226, 16145239, 60677414,
         9669641, 51823619, 55950921])
-------Step 1-------
tensor([347398, 347443, 347477, 347506, 347547, 347580, 347624,  31039, 347653,
        347687]) tensor([ 5325074, 64568329, 24286701,  6591200, 18495434,  1278133,  1946634,
        29346364, 23152084, 41585709])
-------Step 2-------
tensor([413183, 413216, 413250, 413286, 413321, 413363, 413394, 413427, 413462,
        413503]) tensor([26660763, 77759483, 81110681, 24497837, 17758841, 21731286, 17009527,
        29605159, 14214984, 33033462])
-------Step 3-------
tensor([413183, 413216, 413250, 413286, 413321, 413363, 413394, 413427, 413462,
        413503]) tensor([65907059, 74253858, 74159695, 18700303, 71819880, 74527795, 81967415,
        59305469, 40651757, 30724638])
-------Step 4-------
tensor([ 479271,  479305, 1018574,  479338,  479372, 8315384,  520495,  479405,
        1018592,  479440]) tensor([42007387, 84936962, 45387082, 70815247, 65950442, 34655320, 29619576,
         6728287, 69131152, 52199660])
-------Step 5-------
tensor([ 479271,  479305, 1018574,  479338,  479372, 8315384,  520495,  479405,
        1018592,  479440]) tensor([63700734, 77275797, 17968532, 17270187, 52787620, 34614697, 40427251,
        66918610, 23528864, 31292690])
-------Step 6-------
tensor([ 546077,  546121,  546161, 1020025,  546191,  546235,  546267,  546291,
         546321,  546354]) tensor([53574983, 82481585, 78714199, 19296747,  4530661,  4645650, 83268246,
        13650790, 11557883, 85842710])
-------Step 7-------
tensor([ 546077,  546121,  546161, 1020025,  546191,  546235,  546267,  546291,
         546321,  546354]) tensor([84165849, 37958369, 58578461, 25106721, 42755634, 13477372, 71855937,
         4754080, 35736993, 49151800])
-------Step 8-------
tensor([610943, 610967, 532077, 611007, 611030, 611053, 611079, 611104, 611134,
        611162]) tensor([13537501, 17409831, 39888589,  6371098, 85321321, 17029839, 61813878,
        51374793, 59448103, 53346919])
-------Step 9-------
tensor([610943, 610967, 532077, 611007, 611030, 611053, 611079, 611104, 611134,
        611162]) tensor([44336472, 82069827, 38733924, 32873458, 35727062, 41569679, 37921664,
        27379679, 52946523, 73372697])
before start barrier
start train
[proc 0] 100 steps, total: 3.657, sample: 0.859, forward: 1.177, backward: 0.574, update: 0.549
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 3.505 ms                  | 72.216 ms                 |
| Forward                   | 6.423 ms                  | 13.947 ms                 |
| Backward                  | 4.044 ms                  | 26.876 ms                 |
| Optimize                  | 5.228 ms                  | 17.243 ms                 |
| OneStep                   | 23.808 ms                 | 89.012 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 0] 200 steps, total: 2.649, sample: 0.634, forward: 0.652, backward: 0.391, update: 0.546
[proc 1] 200 steps, total: 2.649, sample: 0.520, forward: 0.991, backward: 0.395, update: 0.586
[proc 1] 300 steps, total: 2.474, sample: 0.426, forward: 0.924, backward: 0.413, update: 0.591
[proc 0] 300 steps, total: 2.474, sample: 0.461, forward: 0.681, backward: 0.413, update: 0.556
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 2.261 ms                  | 48.617 ms                 |
| Forward                   | 6.340 ms                  | 13.947 ms                 |
| Backward                  | 4.019 ms                  | 5.214 ms                  |
| Optimize                  | 5.304 ms                  | 9.103 ms                  |
| OneStep                   | 22.303 ms                 | 73.397 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 2.433, sample: 0.442, forward: 0.915, backward: 0.388, update: 0.577
[proc 0] 400 steps, total: 2.433, sample: 0.451, forward: 0.668, backward: 0.389, update: 0.562
[proc 1] 500 steps, total: 2.432, sample: 0.411, forward: 0.906, backward: 0.390, update: 0.581
[proc 0] 500 steps, total: 2.432, sample: 0.441, forward: 0.625, backward: 0.418, update: 0.546
Successfully xmh. training takes 13.645536184310913 seconds
before call kg_cache_controller.StopThreads()
