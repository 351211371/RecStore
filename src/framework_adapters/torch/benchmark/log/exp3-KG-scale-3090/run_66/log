WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 08:16:46.757519 34052 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_6', no_save_emb=True, max_step=500, batch_size=1600, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=2, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=2, gpu=[0, 1], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [34052 sampler.py:454] Start PreSampling
WARNING [34052 sampler.py:532] Before construct renumbering_dict
WARNING [34052 sampler.py:555] PreSampling done
W20240123 08:29:28.678601 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000
W20240123 08:29:28.678830 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000
W20240123 08:29:28.678862 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000
W20240123 08:29:28.678894 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000
W20240123 08:29:28.678916 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000
W20240123 08:29:28.678943 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000
W20240123 08:29:28.678966 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000
W20240123 08:29:28.678992 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000
W20240123 08:29:28.679015 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000
W20240123 08:29:28.679046 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000
W20240123 08:29:28.679085 34052 IPCTensor.h:367] NewIPCTensor: step_r0 [10]0x1000007b4000
W20240123 08:29:28.679107 34052 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000
W20240123 08:29:28.679129 34052 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000
W20240123 08:29:28.679288 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000
W20240123 08:29:28.679320 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000
W20240123 08:29:28.679342 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000
W20240123 08:29:28.679368 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000
W20240123 08:29:28.679394 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000
W20240123 08:29:28.679435 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000
W20240123 08:29:28.679461 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000
W20240123 08:29:28.679488 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000
W20240123 08:29:28.679515 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000
W20240123 08:29:28.679538 34052 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000
W20240123 08:29:28.679558 34052 IPCTensor.h:367] NewIPCTensor: step_r1 [10]0x100000f6c000
W20240123 08:29:28.679574 34052 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000
W20240123 08:29:28.679597 34052 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000
{0: Graph(num_nodes=43196088, num_edges=182879791,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=47371617, num_edges=163853044,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 43196088 N 182879791 E
MertisPartition: part 1 has 47371617 N 163853044 E
Rank0: cached key size 2151353
Rank1: cached key size 2151353
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 24862891, 27748820, 20932263]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
After renumbering graph:  {'_ID': tensor([ 4302737,  4302769,   450103,  ..., 24464719, 30813462, 67854383]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 1])}
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=43196088, num_edges=182879791,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 1014.557 seconds
INFO [59545 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [34052 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [59545 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
INFO [34052 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 2 nodes.
I20240123 08:34:10.643604 59547 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 2
I20240123 08:34:11.827836 59610 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 2
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 8.177 ms                  | 172.098 ms                |
| Forward                   | 7.358 ms                  | 502.791 ms                |
| Backward                  | 4.048 ms                  | 167.192 ms                |
| Optimize                  | 6.198 ms                  | 11.141 ms                 |
| OneStep                   | 35.474 ms                 | 782.801 ms                |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 6.214, sample: 1.414, forward: 1.855, backward: 0.563, update: 0.754
[Rank1] pid = 59545
train_sampler.Prefill()
-------Step 0-------
tensor([1853196, 1853216, 1853237, 1853267, 1853290, 1853329, 1853352,   28871,
        1853377, 1853410]) tensor([ 1092584,  4589072, 16863756, 47181905, 33917134, 15622171, 70845207,
         8045454, 46415706, 61666760])
-------Step 1-------
tensor([1853196, 1853216, 1853237, 1853267, 1853290, 1853329, 1853352,   28871,
        1853377, 1853410]) tensor([83554440, 75853634, 48502097, 48992593, 76426675, 69665817, 28322783,
        61060540, 60977484, 54333044])
-------Step 2-------
tensor([6049078, 1912173,  125627, 1912197,  623212, 1912218, 1912240,  529444,
        1912262, 1912278]) tensor([51806720,  1452916, 50113157,  1842305, 72928922, 66367213, 39226706,
        16846331, 66004298, 14358315])
-------Step 3-------
tensor([6049078, 1912173,  125627, 1912197,  623212, 1912218, 1912240,  529444,
        1912262, 1912278]) tensor([37382073, 81872063, 44050708, 39898927, 42705511, 37560996,  1444715,
        31566936, 58543929, 80965903])
-------Step 4-------
tensor([   37992, 25691937,   174023,  1952931,  1952954,  1952975,   628450,
         1952993,  1953010,  1953025]) tensor([52611933, 28508030, 18205546, 38311668, 14936659, 10928745, 72614169,
        69730801, 20667805, 69341685])
-------Step 5-------
tensor([   37992, 25691937,   174023,  1952931,  1952954,  1952975,   628450,
         1952993,  1953010,  1953025]) tensor([69228115, 59997499, 65367217, 39094100, 40524072,   934839, 28609922,
        51697483, 71245398, 82378065])
-------Step 6-------
tensor([1993493, 1993508,  336155, 1993525, 1993544, 1993555, 1993570, 1993584,
        1993601, 1993617]) tensor([14575830, 18533320, 43104135,  6033516, 83394974, 15997950, 50911050,
        45952919, 72626771, 45880374])
-------Step 7-------
tensor([1993493, 1993508,  336155, 1993525, 1993544, 1993555, 1993570, 1993584,
        1993601, 1993617]) tensor([78801555,  8473746, 48232749, 72406684,  2115151, 36118510, 10499410,
        63022835, 58492592, 56809184])
-------Step 8-------
tensor([2026133, 2026153, 2026164, 2026178,  640788,  640818, 2026195, 2026208,
        2026222, 2026239]) tensor([69454228, 84150011,  1627754, 52681811, 15438166,  6651490, 71885438,
        82957806,  6344761, 48113799])
-------Step 9-------
tensor([2026133, 2026153, 2026164, 2026178,  640788,  640818, 2026195, 2026208,
        2026222, 2026239]) tensor([20508327, 17268269, 46119706, 10039039,  9230883, 20809727, 39217448,
        40572607, 25511769, 72377674])
before start barrier
start train
[proc 0] 100 steps, total: 5.029, sample: 1.741, forward: 1.312, backward: 0.563, update: 0.656
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.047 ms                  | 153.404 ms                |
| Forward                   | 7.780 ms                  | 11.896 ms                 |
| Backward                  | 4.098 ms                  | 5.755 ms                  |
| Optimize                  | 6.407 ms                  | 11.141 ms                 |
| OneStep                   | 30.319 ms                 | 185.949 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 200 steps, total: 3.866, sample: 1.418, forward: 0.849, backward: 0.417, update: 0.668
[proc 1] 200 steps, total: 3.866, sample: 1.092, forward: 1.151, backward: 0.391, update: 0.706
[proc 0] 300 steps, total: 3.350, sample: 1.036, forward: 0.839, backward: 0.409, update: 0.663
[proc 1] 300 steps, total: 3.350, sample: 0.702, forward: 1.067, backward: 0.409, update: 0.690
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.317 ms                  | 146.580 ms                |
| Forward                   | 7.780 ms                  | 13.956 ms                 |
| Backward                  | 4.109 ms                  | 5.900 ms                  |
| Optimize                  | 6.328 ms                  | 12.181 ms                 |
| OneStep                   | 28.292 ms                 | 172.527 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 3.303, sample: 0.595, forward: 1.122, backward: 0.405, update: 0.714
[proc 0] 400 steps, total: 3.303, sample: 0.912, forward: 0.822, backward: 0.429, update: 0.633
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.452 ms                  | 138.427 ms                |
| Forward                   | 7.652 ms                  | 13.956 ms                 |
| Backward                  | 4.102 ms                  | 5.900 ms                  |
| Optimize                  | 6.305 ms                  | 10.421 ms                 |
| OneStep                   | 28.183 ms                 | 162.243 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 500 steps, total: 2.859, sample: 0.490, forward: 1.019, backward: 0.406, update: 0.659
[proc 0] 500 steps, total: 2.859, sample: 0.729, forward: 0.754, backward: 0.397, update: 0.612
Successfully xmh. training takes 18.408145904541016 seconds
before call kg_cache_controller.StopThreads()
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.290 ms                  | 138.427 ms                |
| Forward                   | 7.592 ms                  | 15.083 ms                 |
| Backward                  | 4.097 ms                  | 5.900 ms                  |
| Optimize                  | 6.278 ms                  | 10.421 ms                 |
| OneStep                   | 27.816 ms                 | 162.243 ms                |
+---------------------------+---------------------------+---------------------------+
