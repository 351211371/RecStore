WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 20:22:23.199492 34711 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 304727650 train triples.
Reading valid triples....
Finished. Read 16929318 valid triples.
Reading test triples....
Finished. Read 16929308 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='Freebase', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_Freebase_31', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=86054151, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownShardedCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='PySync', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 304727650
original graph:  DGLGraph(num_nodes=86054151, num_edges=338586276,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [34711 sampler.py:454] Start PreSampling
WARNING [34711 sampler.py:532] Before construct renumbering_dict
WARNING [34711 sampler.py:555] PreSampling done
W20240123 20:34:20.329999 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000 781.2 kB
W20240123 20:34:20.330214 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000 781.2 kB
W20240123 20:34:20.330246 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000 781.2 kB
W20240123 20:34:20.330276 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000 781.2 kB
W20240123 20:34:20.330298 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000 781.2 kB
W20240123 20:34:20.330327 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000 781.2 kB
W20240123 20:34:20.330350 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000 781.2 kB
W20240123 20:34:20.330384 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000 781.2 kB
W20240123 20:34:20.330404 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000 781.2 kB
W20240123 20:34:20.330427 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000 781.2 kB
W20240123 20:34:20.330456 34711 IPCTensor.h:365] NewIPCTensor: step_r0 [10]0x1000007b4000 80 B 
W20240123 20:34:20.330476 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000 8 B 
W20240123 20:34:20.330497 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000 8 B 
W20240123 20:34:20.330646 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000 781.2 kB
W20240123 20:34:20.330667 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000 781.2 kB
W20240123 20:34:20.330682 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000 781.2 kB
W20240123 20:34:20.330710 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000 781.2 kB
W20240123 20:34:20.330734 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000 781.2 kB
W20240123 20:34:20.330750 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000 781.2 kB
W20240123 20:34:20.330773 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000 781.2 kB
W20240123 20:34:20.330802 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000 781.2 kB
W20240123 20:34:20.330822 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000 781.2 kB
W20240123 20:34:20.330840 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000 781.2 kB
W20240123 20:34:20.330857 34711 IPCTensor.h:365] NewIPCTensor: step_r1 [10]0x100000f6c000 80 B 
W20240123 20:34:20.330873 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000 8 B 
W20240123 20:34:20.330891 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000 8 B 
W20240123 20:34:20.330929 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_0 [100000]0x100000f72000 781.2 kB
W20240123 20:34:20.330952 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_1 [100000]0x100001037000 781.2 kB
W20240123 20:34:20.330967 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_2 [100000]0x1000010fc000 781.2 kB
W20240123 20:34:20.330986 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_3 [100000]0x1000011c1000 781.2 kB
W20240123 20:34:20.331004 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_4 [100000]0x100001286000 781.2 kB
W20240123 20:34:20.331020 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_5 [100000]0x10000134b000 781.2 kB
W20240123 20:34:20.331038 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_6 [100000]0x100001410000 781.2 kB
W20240123 20:34:20.331058 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_7 [100000]0x1000014d5000 781.2 kB
W20240123 20:34:20.331085 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_8 [100000]0x10000159a000 781.2 kB
W20240123 20:34:20.331115 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r2_9 [100000]0x10000165f000 781.2 kB
W20240123 20:34:20.331130 34711 IPCTensor.h:365] NewIPCTensor: step_r2 [10]0x100001724000 80 B 
W20240123 20:34:20.331146 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r2 [1]0x100001726000 8 B 
W20240123 20:34:20.331161 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x100001728000 8 B 
W20240123 20:34:20.331197 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_0 [100000]0x10000172a000 781.2 kB
W20240123 20:34:20.331220 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_1 [100000]0x1000017ef000 781.2 kB
W20240123 20:34:20.331238 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_2 [100000]0x1000018b4000 781.2 kB
W20240123 20:34:20.331254 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_3 [100000]0x100001979000 781.2 kB
W20240123 20:34:20.331270 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_4 [100000]0x100001a3e000 781.2 kB
W20240123 20:34:20.331286 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_5 [100000]0x100001b03000 781.2 kB
W20240123 20:34:20.331313 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_6 [100000]0x100001bc8000 781.2 kB
W20240123 20:34:20.331331 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_7 [100000]0x100001c8d000 781.2 kB
W20240123 20:34:20.331347 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_8 [100000]0x100001d52000 781.2 kB
W20240123 20:34:20.331365 34711 IPCTensor.h:365] NewIPCTensor: cached_sampler_r3_9 [100000]0x100001e17000 781.2 kB
W20240123 20:34:20.331382 34711 IPCTensor.h:365] NewIPCTensor: step_r3 [10]0x100001edc000 80 B 
W20240123 20:34:20.331395 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_r3 [1]0x100001ede000 8 B 
W20240123 20:34:20.331408 34711 IPCTensor.h:365] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100001ee0000 8 B 
W20240123 20:34:20.683426 34711 IPCTensor.h:365] NewIPCTensor: full_emb [86054151, 400]0x100001ee2000 128.2 GB
W20240123 20:34:20.683607 34711 IPCTensor.h:365] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [86054151]0x102010b1a000 328.3 MB
{0: Graph(num_nodes=27256011, num_edges=100992629,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=23779591, num_edges=94535774,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=26463902, num_edges=75890617,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=25398646, num_edges=93789131,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 27256011 N 100992629 E
MertisPartition: part 1 has 23779591 N 94535774 E
MertisPartition: part 2 has 26463902 N 75890617 E
MertisPartition: part 3 has 25398646 N 93789131 E
Rank0: cached key size 1075676
Rank1: cached key size 1075676
Rank2: cached key size 1075676
Rank3: cached key size 1075676
Before renumbering graph:  {'_ID': tensor([       0,        1,        2,  ..., 82487883, 64859130, 64482679]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 3, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 4302709,  4302743,   353279,  ...,  4297694, 18104907, 82702490]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 3, 3, 3])}
part_g: DGLGraph(num_nodes=27256011, num_edges=100992629,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=27256011, num_edges=100992629,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 893.311 seconds
[Rank1] pid = 57468
[Rank2] pid = 57568
INFO [34711 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [57468 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [57641 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [57568 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [57468 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [57641 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [57568 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [34711 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
WARNING [57568 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [57641 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [57468 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [34711 DistTensor.py:56] The tensor name already exists in the kvstore
I20240123 20:37:31.348990 57642 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240123 20:37:31.349656 57705 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240123 20:37:31.349874 57469 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240123 20:37:31.350050 57569 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240123 20:37:42.938880 57569 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240123 20:37:45.374652 57469 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 20:37:46.053030 57705 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 20:37:47.013183 57642 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.822 ms                  | 51.036 ms                 |
| bucket keys               | 1.074 ms                  | 144.245 ms                |
| forward: a2a keys         | 1.313 ms                  | 657.634 ms                |
| forward: search cache     | 205.439 us                | 18.288 ms                 |
| forward: a2a values       | 3.385 ms                  | 10.918 ms                 |
| forward: join             | 1.110 ms                  | 1.653 ms                  |
| Forward                   | 21.270 ms                 | 1.331 s                   |
| back: aggr dram keys      | 33.203 ms                 | 397.906 ms                |
| back: set dram grad       | 1.984 ms                  | 3.299 ms                  |
| back: a2a grad            | 4.209 ms                  | 13.354 ms                 |
| back: grad sum & grad cache  | 1.432 ms                  | 30.834 ms                 |
| Backward                  | 87.541 ms                 | 617.581 ms                |
| Optimize                  | 11.782 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 66.789 us                 | 109.290 us                |
| BlockToStepN              | 16.283 us                 | 8.041 ms                  |
| OneStep                   | 127.763 ms                | 1.967 s                   |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.453 ms                  | 48.803 ms                 |
| bucket keys               | 1.083 ms                  | 2.309 ms                  |
| forward: a2a keys         | 1.291 ms                  | 13.075 ms                 |
| forward: search cache     | 206.047 us                | 342.749 us                |
| forward: a2a values       | 5.065 ms                  | 16.647 ms                 |
| forward: join             | 1.110 ms                  | 1.689 ms                  |
| Forward                   | 21.479 ms                 | 47.631 ms                 |
| back: aggr dram keys      | 31.395 ms                 | 48.935 ms                 |
| back: set dram grad       | 1.959 ms                  | 3.299 ms                  |
| back: a2a grad            | 6.703 ms                  | 18.420 ms                 |
| back: grad sum & grad cache  | 1.432 ms                  | 27.887 ms                 |
| Backward                  | 86.883 ms                 | 121.464 ms                |
| Optimize                  | 11.957 ms                 | 16.992 ms                 |
| BarrierTimeBeforeRank0    | 58.707 us                 | 97.320 us                 |
| BlockToStepN              | 16.280 us                 | 8.041 ms                  |
| OneStep                   | 127.939 ms                | 174.701 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.417 ms                  | 51.036 ms                 |
| bucket keys               | 1.076 ms                  | 2.224 ms                  |
| forward: a2a keys         | 1.154 ms                  | 17.360 ms                 |
| forward: search cache     | 188.518 us                | 330.480 us                |
| forward: a2a values       | 5.065 ms                  | 10.918 ms                 |
| forward: join             | 1.110 ms                  | 1.692 ms                  |
| Forward                   | 21.069 ms                 | 47.631 ms                 |
| back: aggr dram keys      | 31.397 ms                 | 47.808 ms                 |
| back: set dram grad       | 1.977 ms                  | 3.168 ms                  |
| back: a2a grad            | 6.444 ms                  | 24.495 ms                 |
| back: grad sum & grad cache  | 1.565 ms                  | 25.532 ms                 |
| Backward                  | 87.187 ms                 | 121.464 ms                |
| Optimize                  | 11.946 ms                 | 16.992 ms                 |
| BarrierTimeBeforeRank0    | 57.674 us                 | 97.320 us                 |
| BlockToStepN              | 16.496 us                 | 9.653 ms                  |
| OneStep                   | 129.247 ms                | 178.270 ms                |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 16.314, sample: 0.699, forward: 4.183, backward: 7.615, update: 0.216
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 19.429, sample: 0.677, forward: 4.189, backward: 7.624, update: 0.211
[Rank3] pid = 57641
New CachedEmbedding, name=full_emb, shape=(86054151, 400), cache_type=KnownShardedCachedEmbedding
fixed cache_range is [(0, 4302707), (4302707, 8605414), (8605414, 12908121), (12908121, 17210828)]
train_sampler.Prefill()
-------Step 0-------
tensor([  955026,  4596831,   955047,   955069,   955096,   955127, 58269611,
          175436,  4309999,   955155]) tensor([ 5045413, 26789515, 19464782, 32354574, 38784936, 35581324, 68808565,
        76695640, 53758113, 53381454])
-------Step 1-------
tensor([  955026,  4596831,   955047,   955069,   955096,   955127, 58269611,
          175436,  4309999,   955155]) tensor([34099498, 50546163, 49869928, 48306377, 49382950, 84628928, 24800158,
        78330461, 60685157,  4373343])
-------Step 2-------
tensor([ 177292, 1007234, 1007265, 1007298, 1007322, 1007349, 1007373, 1007401,
         842248, 1007429]) tensor([78588026, 33002779, 63397814,   750520, 30324512, 22546144, 70962987,
        63915121, 27814176,  2080465])
-------Step 3-------
tensor([ 177292, 1007234, 1007265, 1007298, 1007322, 1007349, 1007373, 1007401,
         842248, 1007429]) tensor([63051056, 71874949, 10040138, 33975059,  4755717, 14564779, 83283176,
         9462216,  7794660, 38201704])
-------Step 4-------
tensor([ 1059115,  1059137,  1059164, 12379875,  1059183,  1059208,  1059234,
        28171092,  1059261,  4309999]) tensor([29367311, 34265960, 11933833, 42294438, 45053415, 20022571, 56556449,
        74505906, 10759000, 11791713])
-------Step 5-------
tensor([ 1059115,  1059137,  1059164, 12379875,  1059183,  1059208,  1059234,
        28171092,  1059261,  4309999]) tensor([39185079, 70890240, 77068481, 11387465, 30494507, 26821118, 65449673,
        75463314,   427680, 70221682])
-------Step 6-------
tensor([   46012,    46049,  5347116,    46090,    46123,    46165, 10139057,
           46199,    46235,    46268]) tensor([35192267,  4547354,  8602891, 19578043, 81351799, 46868360, 79394770,
        23813749, 55525804, 74237314])
-------Step 7-------
tensor([   46012,    46049,  5347116,    46090,    46123,    46165, 10139057,
           46199,    46235,    46268]) tensor([17305686, 58472878, 37913570, 32347158, 15321537, 80155961,  1146859,
        84677048, 67173210, 19662133])
-------Step 8-------
tensor([  104673,   104704,   104737, 74320029,   104763,   104797, 60468194,
          104831,   104872,   104897]) tensor([13079016, 85128388, 80482521, 65350124, 84374069, 51818679, 65061263,
         1054356, 68241429, 31605191])
-------Step 9-------
tensor([  104673,   104704,   104737, 74320029,   104763,   104797, 60468194,
          104831,   104872,   104897]) tensor([60157803, 66894786, 79676559, 42309033, 12936434, 30382847, 44561688,
        37360772, 40717453, 22285260])
before start barrier
start train
[proc 0] 100 steps, total: 15.354, sample: 0.996, forward: 3.513, backward: 9.564, update: 1.145
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 16.993, sample: 0.749, forward: 4.146, backward: 7.773, update: 0.140
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.342 ms                  | 55.530 ms                 |
| bucket keys               | 1.073 ms                  | 2.161 ms                  |
| forward: a2a keys         | 1.179 ms                  | 13.075 ms                 |
| forward: search cache     | 187.590 us                | 323.420 us                |
| forward: a2a values       | 5.065 ms                  | 7.765 ms                  |
| forward: join             | 1.110 ms                  | 1.703 ms                  |
| Forward                   | 20.957 ms                 | 47.631 ms                 |
| back: aggr dram keys      | 31.397 ms                 | 42.298 ms                 |
| back: set dram grad       | 1.977 ms                  | 3.155 ms                  |
| back: a2a grad            | 6.444 ms                  | 18.420 ms                 |
| back: grad sum & grad cache  | 1.565 ms                  | 25.532 ms                 |
| Backward                  | 87.720 ms                 | 121.464 ms                |
| Optimize                  | 11.829 ms                 | 16.992 ms                 |
| BarrierTimeBeforeRank0    | 56.169 us                 | 97.320 us                 |
| BlockToStepN              | 16.392 us                 | 9.653 ms                  |
| OneStep                   | 127.078 ms                | 192.698 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.696 ms                  | 52.542 ms                 |
| bucket keys               | 1.074 ms                  | 2.178 ms                  |
| forward: a2a keys         | 1.169 ms                  | 13.075 ms                 |
| forward: search cache     | 191.966 us                | 330.480 us                |
| forward: a2a values       | 5.033 ms                  | 9.779 ms                  |
| forward: join             | 1.110 ms                  | 1.703 ms                  |
| Forward                   | 21.033 ms                 | 46.225 ms                 |
| back: aggr dram keys      | 31.934 ms                 | 47.808 ms                 |
| back: set dram grad       | 1.986 ms                  | 3.168 ms                  |
| back: a2a grad            | 6.523 ms                  | 24.495 ms                 |
| back: grad sum & grad cache  | 1.565 ms                  | 27.887 ms                 |
| Backward                  | 87.828 ms                 | 121.464 ms                |
| Optimize                  | 11.801 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 55.496 us                 | 96.692 us                 |
| BlockToStepN              | 16.316 us                 | 8.385 ms                  |
| OneStep                   | 127.702 ms                | 183.040 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 13.413, sample: 0.565, forward: 2.820, backward: 7.288, update: 0.130
[proc 2] 200 steps, total: 13.413, sample: 0.654, forward: 2.724, backward: 7.041, update: 0.248
[proc 3] 200 steps, total: 13.413, sample: 0.584, forward: 2.794, backward: 7.056, update: 0.223
[proc 0] 200 steps, total: 13.413, sample: 0.964, forward: 2.108, backward: 9.068, update: 1.166
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.783 ms                  | 54.220 ms                 |
| bucket keys               | 1.075 ms                  | 2.161 ms                  |
| forward: a2a keys         | 1.154 ms                  | 14.503 ms                 |
| forward: search cache     | 196.655 us                | 323.502 us                |
| forward: a2a values       | 5.033 ms                  | 7.765 ms                  |
| forward: join             | 1.110 ms                  | 1.703 ms                  |
| Forward                   | 21.039 ms                 | 46.225 ms                 |
| back: aggr dram keys      | 31.934 ms                 | 48.935 ms                 |
| back: set dram grad       | 1.988 ms                  | 3.155 ms                  |
| back: a2a grad            | 6.530 ms                  | 18.420 ms                 |
| back: grad sum & grad cache  | 1.636 ms                  | 28.354 ms                 |
| Backward                  | 87.748 ms                 | 121.464 ms                |
| Optimize                  | 11.833 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 56.218 us                 | 97.320 us                 |
| BlockToStepN              | 16.349 us                 | 9.653 ms                  |
| OneStep                   | 127.866 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.874 ms                  | 54.220 ms                 |
| bucket keys               | 1.074 ms                  | 2.289 ms                  |
| forward: a2a keys         | 1.154 ms                  | 14.503 ms                 |
| forward: search cache     | 197.923 us                | 323.420 us                |
| forward: a2a values       | 5.033 ms                  | 6.885 ms                  |
| forward: join             | 1.110 ms                  | 1.703 ms                  |
| Forward                   | 20.960 ms                 | 46.225 ms                 |
| back: aggr dram keys      | 31.931 ms                 | 48.935 ms                 |
| back: set dram grad       | 1.990 ms                  | 2.912 ms                  |
| back: a2a grad            | 6.591 ms                  | 17.087 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.887 ms                 |
| Backward                  | 87.583 ms                 | 121.464 ms                |
| Optimize                  | 11.834 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 56.134 us                 | 97.320 us                 |
| BlockToStepN              | 16.316 us                 | 9.653 ms                  |
| OneStep                   | 127.849 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.970 ms                  | 54.220 ms                 |
| bucket keys               | 1.074 ms                  | 2.309 ms                  |
| forward: a2a keys         | 1.153 ms                  | 13.075 ms                 |
| forward: search cache     | 200.810 us                | 342.749 us                |
| forward: a2a values       | 5.009 ms                  | 7.119 ms                  |
| forward: join             | 1.110 ms                  | 1.703 ms                  |
| Forward                   | 20.957 ms                 | 40.077 ms                 |
| back: aggr dram keys      | 31.934 ms                 | 47.808 ms                 |
| back: set dram grad       | 1.990 ms                  | 2.912 ms                  |
| back: a2a grad            | 6.591 ms                  | 16.788 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.887 ms                 |
| Backward                  | 87.541 ms                 | 117.471 ms                |
| Optimize                  | 11.843 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 55.529 us                 | 96.692 us                 |
| BlockToStepN              | 16.466 us                 | 8.784 ms                  |
| OneStep                   | 127.702 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 0] 300 steps, total: 13.205, sample: 0.933, forward: 2.119, backward: 8.907, update: 1.127
[proc 1] 300 steps, total: 13.205, sample: 0.547, forward: 2.782, backward: 7.235, update: 0.160
[proc 3] 300 steps, total: 13.205, sample: 0.562, forward: 2.771, backward: 7.008, update: 0.223
[proc 2] 300 steps, total: 13.205, sample: 0.592, forward: 2.726, backward: 7.007, update: 0.232
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.897 ms                  | 55.530 ms                 |
| bucket keys               | 1.071 ms                  | 2.312 ms                  |
| forward: a2a keys         | 1.145 ms                  | 13.075 ms                 |
| forward: search cache     | 193.587 us                | 342.749 us                |
| forward: a2a values       | 4.944 ms                  | 8.063 ms                  |
| forward: join             | 1.110 ms                  | 1.731 ms                  |
| Forward                   | 20.860 ms                 | 40.077 ms                 |
| back: aggr dram keys      | 31.931 ms                 | 47.889 ms                 |
| back: set dram grad       | 1.990 ms                  | 3.155 ms                  |
| back: a2a grad            | 6.591 ms                  | 16.788 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.887 ms                 |
| Backward                  | 87.520 ms                 | 117.471 ms                |
| Optimize                  | 11.802 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 53.551 us                 | 96.692 us                 |
| BlockToStepN              | 16.725 us                 | 9.653 ms                  |
| OneStep                   | 127.078 ms                | 189.551 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.989 ms                  | 54.220 ms                 |
| bucket keys               | 1.068 ms                  | 2.309 ms                  |
| forward: a2a keys         | 1.154 ms                  | 13.075 ms                 |
| forward: search cache     | 188.726 us                | 330.480 us                |
| forward: a2a values       | 4.866 ms                  | 7.937 ms                  |
| forward: join             | 1.110 ms                  | 1.705 ms                  |
| Forward                   | 20.636 ms                 | 40.032 ms                 |
| back: aggr dram keys      | 31.471 ms                 | 47.808 ms                 |
| back: set dram grad       | 1.994 ms                  | 2.912 ms                  |
| back: a2a grad            | 6.591 ms                  | 15.903 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.679 ms                 |
| Backward                  | 87.433 ms                 | 113.919 ms                |
| Optimize                  | 11.751 ms                 | 20.582 ms                 |
| BarrierTimeBeforeRank0    | 52.179 us                 | 96.595 us                 |
| BlockToStepN              | 16.920 us                 | 8.784 ms                  |
| OneStep                   | 126.247 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 4.989 ms                  | 54.220 ms                 |
| bucket keys               | 1.066 ms                  | 2.309 ms                  |
| forward: a2a keys         | 1.154 ms                  | 12.866 ms                 |
| forward: search cache     | 188.261 us                | 342.749 us                |
| forward: a2a values       | 4.800 ms                  | 7.937 ms                  |
| forward: join             | 1.206 ms                  | 1.731 ms                  |
| Forward                   | 20.497 ms                 | 40.032 ms                 |
| back: aggr dram keys      | 31.397 ms                 | 47.889 ms                 |
| back: set dram grad       | 1.997 ms                  | 2.794 ms                  |
| back: a2a grad            | 6.583 ms                  | 15.903 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.679 ms                 |
| Backward                  | 87.374 ms                 | 113.919 ms                |
| Optimize                  | 11.730 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 51.737 us                 | 96.595 us                 |
| BlockToStepN              | 17.136 us                 | 9.653 ms                  |
| OneStep                   | 126.070 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 3] 400 steps, total: 12.737, sample: 0.509, forward: 2.584, backward: 7.021, update: 0.243
[proc 0] 400 steps, total: 12.737, sample: 0.847, forward: 1.982, backward: 8.843, update: 0.974
[proc 1] 400 steps, total: 12.737, sample: 0.628, forward: 2.451, backward: 7.214, update: 0.212
[proc 2] 400 steps, total: 12.737, sample: 0.606, forward: 2.482, backward: 7.005, update: 0.230
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.053 ms                  | 54.220 ms                 |
| bucket keys               | 1.070 ms                  | 2.312 ms                  |
| forward: a2a keys         | 1.145 ms                  | 12.866 ms                 |
| forward: search cache     | 189.955 us                | 332.245 us                |
| forward: a2a values       | 4.757 ms                  | 7.886 ms                  |
| forward: join             | 1.206 ms                  | 1.705 ms                  |
| Forward                   | 20.501 ms                 | 40.077 ms                 |
| back: aggr dram keys      | 31.397 ms                 | 47.889 ms                 |
| back: set dram grad       | 1.992 ms                  | 2.778 ms                  |
| back: a2a grad            | 6.585 ms                  | 15.903 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.679 ms                 |
| Backward                  | 87.315 ms                 | 113.919 ms                |
| Optimize                  | 11.730 ms                 | 24.546 ms                 |
| BarrierTimeBeforeRank0    | 51.399 us                 | 96.595 us                 |
| BlockToStepN              | 17.189 us                 | 9.653 ms                  |
| OneStep                   | 126.014 ms                | 187.298 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 5.206 ms                  | 53.783 ms                 |
| bucket keys               | 1.070 ms                  | 2.317 ms                  |
| forward: a2a keys         | 1.139 ms                  | 13.075 ms                 |
| forward: search cache     | 189.997 us                | 332.245 us                |
| forward: a2a values       | 4.757 ms                  | 7.886 ms                  |
| forward: join             | 1.206 ms                  | 1.705 ms                  |
| Forward                   | 20.468 ms                 | 40.032 ms                 |
| back: aggr dram keys      | 31.395 ms                 | 48.712 ms                 |
| back: set dram grad       | 1.990 ms                  | 2.778 ms                  |
| back: a2a grad            | 6.591 ms                  | 16.788 ms                 |
| back: grad sum & grad cache  | 2.399 ms                  | 27.679 ms                 |
| Backward                  | 87.336 ms                 | 113.537 ms                |
| Optimize                  | 11.739 ms                 | 20.582 ms                 |
| BarrierTimeBeforeRank0    | 51.580 us                 | 91.079 us                 |
| BlockToStepN              | 17.342 us                 | 8.784 ms                  |
| OneStep                   | 126.033 ms                | 183.040 ms                |
+---------------------------+---------------------------+---------------------------+
[proc 2] 500 steps, total: 13.178, sample: 0.514, forward: 2.747, backward: 7.084, update: 0.201
[proc 1] 500 steps, total: 13.178, sample: 0.486, forward: 2.787, backward: 7.267, update: 0.195
[proc 3] 500 steps, total: 13.179, sample: 0.558, forward: 2.706, backward: 7.104, update: 0.224
[proc 0] 500 steps, total: 13.178, sample: 0.892, forward: 2.145, backward: 8.904, update: 1.148
Successfully xmh. training takes 67.8887722492218 seconds
before call kg_cache_controller.StopThreads()
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
INFO [34711 controller_process.py:380] call rank0 to StopThreads
