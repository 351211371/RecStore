WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240123 01:53:35.230526 62306 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_35', no_save_emb=True, max_step=500, batch_size=800, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.05, shuffle=False, backwardMode='CppAsyncV2', L=10, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [62306 sampler.py:454] Start PreSampling
WARNING [62306 sampler.py:532] Before construct renumbering_dict
WARNING [62306 sampler.py:555] PreSampling done
W20240123 01:53:38.791019 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_0 [100000]0x100000002000
W20240123 01:53:38.791195 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_1 [100000]0x1000000c7000
W20240123 01:53:38.791219 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_2 [100000]0x10000018c000
W20240123 01:53:38.791242 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_3 [100000]0x100000251000
W20240123 01:53:38.791260 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_4 [100000]0x100000316000
W20240123 01:53:38.791282 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_5 [100000]0x1000003db000
W20240123 01:53:38.791304 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_6 [100000]0x1000004a0000
W20240123 01:53:38.791332 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_7 [100000]0x100000565000
W20240123 01:53:38.791352 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_8 [100000]0x10000062a000
W20240123 01:53:38.791380 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r0_9 [100000]0x1000006ef000
W20240123 01:53:38.791405 62306 IPCTensor.h:367] NewIPCTensor: step_r0 [10]0x1000007b4000
W20240123 01:53:38.791422 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r0 [1]0x1000007b6000
W20240123 01:53:38.791442 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x1000007b8000
W20240123 01:53:38.791533 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_0 [100000]0x1000007ba000
W20240123 01:53:38.791560 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_1 [100000]0x10000087f000
W20240123 01:53:38.791579 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_2 [100000]0x100000944000
W20240123 01:53:38.791595 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_3 [100000]0x100000a09000
W20240123 01:53:38.791611 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_4 [100000]0x100000ace000
W20240123 01:53:38.791649 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_5 [100000]0x100000b93000
W20240123 01:53:38.791671 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_6 [100000]0x100000c58000
W20240123 01:53:38.791693 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_7 [100000]0x100000d1d000
W20240123 01:53:38.791716 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_8 [100000]0x100000de2000
W20240123 01:53:38.791741 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r1_9 [100000]0x100000ea7000
W20240123 01:53:38.791761 62306 IPCTensor.h:367] NewIPCTensor: step_r1 [10]0x100000f6c000
W20240123 01:53:38.791775 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r1 [1]0x100000f6e000
W20240123 01:53:38.791788 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x100000f70000
W20240123 01:53:38.791821 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_0 [100000]0x100000f72000
W20240123 01:53:38.791844 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_1 [100000]0x100001037000
W20240123 01:53:38.791860 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_2 [100000]0x1000010fc000
W20240123 01:53:38.791877 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_3 [100000]0x1000011c1000
W20240123 01:53:38.791896 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_4 [100000]0x100001286000
W20240123 01:53:38.791913 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_5 [100000]0x10000134b000
W20240123 01:53:38.791929 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_6 [100000]0x100001410000
W20240123 01:53:38.791949 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_7 [100000]0x1000014d5000
W20240123 01:53:38.791965 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_8 [100000]0x10000159a000
W20240123 01:53:38.791983 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r2_9 [100000]0x10000165f000
W20240123 01:53:38.791999 62306 IPCTensor.h:367] NewIPCTensor: step_r2 [10]0x100001724000
W20240123 01:53:38.792012 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r2 [1]0x100001726000
W20240123 01:53:38.792025 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x100001728000
W20240123 01:53:38.792057 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_0 [100000]0x10000172a000
W20240123 01:53:38.792078 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_1 [100000]0x1000017ef000
W20240123 01:53:38.792095 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_2 [100000]0x1000018b4000
W20240123 01:53:38.792111 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_3 [100000]0x100001979000
W20240123 01:53:38.792132 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_4 [100000]0x100001a3e000
W20240123 01:53:38.792155 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_5 [100000]0x100001b03000
W20240123 01:53:38.792176 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_6 [100000]0x100001bc8000
W20240123 01:53:38.792196 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_7 [100000]0x100001c8d000
W20240123 01:53:38.792214 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_8 [100000]0x100001d52000
W20240123 01:53:38.792235 62306 IPCTensor.h:367] NewIPCTensor: cached_sampler_r3_9 [100000]0x100001e17000
W20240123 01:53:38.792250 62306 IPCTensor.h:367] NewIPCTensor: step_r3 [10]0x100001edc000
W20240123 01:53:38.792263 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_r3 [1]0x100001ede000
W20240123 01:53:38.792279 62306 IPCTensor.h:367] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100001ee0000
W20240123 01:53:38.998344 62306 IPCTensor.h:367] NewIPCTensor: full_emb [14951, 400]0x100001ee2000
W20240123 01:53:38.998553 62306 IPCTensor.h:367] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x1000035b4000
{0: Graph(num_nodes=9703, num_edges=161860,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=11374, num_edges=168961,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=10715, num_edges=190828,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=11184, num_edges=240046,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 9703 N 161860 E
MertisPartition: part 1 has 11374 N 168961 E
MertisPartition: part 2 has 10715 N 190828 E
MertisPartition: part 3 has 11184 N 240046 E
Rank0: cached key size 186
Rank1: cached key size 186
Rank2: cached key size 186
Rank3: cached key size 186
Before renumbering graph:  {'_ID': tensor([   6,   10,   11,  ..., 5824, 6189, 2559]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
After renumbering graph:  {'_ID': tensor([ 812,  852,  868,  ..., 7846, 4726, 8088]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 3.821 seconds
[Rank1] pid = 62709
[Rank2] pid = 62743
INFO [62306 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [62709 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [62743 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [62776 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [62743 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [62709 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [62776 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [62306 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240123 01:53:41.657572 62777 IPCTensor.h:406] NewIPCGPUTensor: embedding_cache_0 [747, 400]; dev=0; size=1.14 MB
W20240123 01:53:41.658265 62711 IPCTensor.h:406] NewIPCGPUTensor: embedding_cache_1 [747, 400]; dev=1; size=1.14 MB
W20240123 01:53:41.658350 62905 IPCTensor.h:406] NewIPCGPUTensor: embedding_cache_3 [747, 400]; dev=3; size=1.14 MB
W20240123 01:53:41.658349 62775 IPCTensor.h:406] NewIPCGPUTensor: embedding_cache_2 [747, 400]; dev=2; size=1.14 MB
W20240123 01:53:41.689735 62777 IPCTensor.h:367] NewIPCTensor: input_keys_0 [100000]0x1000035cc000
W20240123 01:53:41.689741 62905 IPCTensor.h:367] NewIPCTensor: input_keys_3 [100000]0x100003691000
W20240123 01:53:41.689746 62711 IPCTensor.h:367] NewIPCTensor: input_keys_1 [100000]0x100003756000
W20240123 01:53:41.689752 62775 IPCTensor.h:367] NewIPCTensor: input_keys_2 [100000]0x10000381b000
W20240123 01:53:41.689878 62777 IPCTensor.h:367] NewIPCTensor: input_keys_neg_0 [100000]0x1000038e0000
W20240123 01:53:41.689889 62775 IPCTensor.h:367] NewIPCTensor: input_keys_neg_2 [100000]0x1000039a5000
W20240123 01:53:41.689903 62905 IPCTensor.h:367] NewIPCTensor: input_keys_neg_3 [100000]0x100003a6a000
W20240123 01:53:41.689908 62711 IPCTensor.h:367] NewIPCTensor: input_keys_neg_1 [100000]0x100003b2f000
W20240123 01:53:41.689929 62777 IPCTensor.h:367] NewIPCTensor: backward_grads_0 [100000, 400]0x100003bf4000
W20240123 01:53:41.689956 62905 IPCTensor.h:367] NewIPCTensor: backward_grads_3 [100000, 400]0x10000d48c000
W20240123 01:53:41.689963 62711 IPCTensor.h:367] NewIPCTensor: backward_grads_1 [100000, 400]0x100016d24000
W20240123 01:53:41.689965 62777 IPCTensor.h:367] NewIPCTensor: backward_grads_neg_0 [100000, 400]0x1000205bc000
W20240123 01:53:41.689982 62775 IPCTensor.h:367] NewIPCTensor: backward_grads_2 [100000, 400]0x100029e54000
W20240123 01:53:41.690001 62905 IPCTensor.h:367] NewIPCTensor: backward_grads_neg_3 [100000, 400]0x1000336ec000
W20240123 01:53:41.689991 62777 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_0_gpu [100000, 400]; dev=0; size=152.6 MB
W20240123 01:53:41.690019 62775 IPCTensor.h:367] NewIPCTensor: backward_grads_neg_2 [100000, 400]0x10003cf84000
W20240123 01:53:41.690026 62711 IPCTensor.h:367] NewIPCTensor: backward_grads_neg_1 [100000, 400]0x10004681c000
W20240123 01:53:41.690042 62905 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_3_gpu [100000, 400]; dev=3; size=152.6 MB
W20240123 01:53:41.690052 62775 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_2_gpu [100000, 400]; dev=2; size=152.6 MB
W20240123 01:53:41.690057 62711 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_1_gpu [100000, 400]; dev=1; size=152.6 MB
W20240123 01:53:41.691372 62777 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_neg_0_gpu [100000, 400]; dev=0; size=152.6 MB
W20240123 01:53:41.691386 62905 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_neg_3_gpu [100000, 400]; dev=3; size=152.6 MB
W20240123 01:53:41.691388 62775 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_neg_2_gpu [100000, 400]; dev=2; size=152.6 MB
W20240123 01:53:41.691393 62711 IPCTensor.h:406] NewIPCGPUTensor: backward_grads_neg_1_gpu [100000, 400]; dev=1; size=152.6 MB
cudaHostRegister 0x100001ee2000
2: KnownLocalCachedEmbedding init done
cudaHostRegister 0x100001ee2000
3: KnownLocalCachedEmbedding init done
[Rank3] pid = 62776
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 747), (747, 1494), (1494, 2241), (2241, 2988)]
cudaHostRegister 0x100001ee2000
0: KnownLocalCachedEmbedding init done
cudaHostRegister 0x100001ee2000
1: KnownLocalCachedEmbedding init done
WARNING [62743 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [62776 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [62709 DistTensor.py:56] The tensor name already exists in the kvstore
WARNING [62306 DistTensor.py:56] The tensor name already exists in the kvstore
I20240123 01:53:41.852109 62905 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240123 01:53:41.852147 62775 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240123 01:53:41.852169 62711 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240123 01:53:41.852188 62777 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240123 01:53:41.853502 62777 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 1,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.05
        }
W20240123 01:53:41.853605 62777 grad_base.h:172] Init GradProcessingBase done
I20240123 01:53:41.856756 62777 grad_async_v2.h:32] Use background thread to update emb. nr_background_threads=32
W20240123 01:53:41.856854 62777 kg_controller.h:78] after init GradAsyncProcessingV2
I20240123 01:53:41.856863 62777 kg_controller.h:84] Construct KGCacheController done
I20240123 01:53:42.277716 62777 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240123 01:53:42.645696 63287 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240123 01:53:42.646168 63287 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
I20240123 01:53:42.671733 62777 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240123 01:53:42.689249 62775 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 01:53:42.690824 62711 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240123 01:53:42.694505 62905 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240123 01:53:44.147313 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=0
W20240123 01:53:44.161608 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=1, pq.top=1
W20240123 01:53:44.170418 63287 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240123 01:53:45.147018 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=1012
W20240123 01:53:45.176221 63287 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
W20240123 01:53:45.217612 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=27, pq.top=27
E20240123 01:53:46.147006 63287 parallel_pq_v2.h:76] insert failed, size(hashtable)=612
W20240123 01:53:46.185163 63287 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240123 01:53:46.217022 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=53, pq.top=53
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.252 ms                  | 18.195 ms                 |
| Forward                   | 4.163 ms                  | 8.154 ms                  |
| Backward                  | 3.819 ms                  | 7.885 ms                  |
| Optimize                  | 1.491 ms                  | 2.164 ms                  |
| BarrierTimeBeforeRank0    | 47.108 us                 | 7.640 ms                  |
| AfterBackward             | 19.580 ms                 | 27.967 ms                 |
| BlockToStepN              | 3.427 ms                  | 15.805 ms                 |
| OneStep                   | 35.674 ms                 | 96.346 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240123 01:53:47.147162 63055 parallel_pq_v2.h:76] insert failed, size(hashtable)=287
W20240123 01:53:47.191068 63287 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
W20240123 01:53:47.217955 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=81, pq.top=81
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.320 ms                  | 2.832 ms                  |
| ProcessBack:UpdateCache   | 2.800 ms                  | 3.694 ms                  |
| ProcessBack:UpsertPq      | 11.743 ms                 | 19.186 ms                 |
| ProcessOneStep            | 18.791 ms                 | 27.932 ms                 |
| BlockToStepN              | 3.589 ms                  | 19.405 ms                 |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.198, sample: 0.259, forward: 1.060, backward: 0.591, update: 0.121
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 5.192, sample: 0.296, forward: 1.066, backward: 0.684, update: 0.121
train_sampler.Prefill()
-------Step 0-------
tensor([ 4764,  8169, 13364,  5380,    33,  5734,  9500,    12,   143,  8415]) tensor([  868, 10495,  2857, 13738,  2921,  3361,  4025,  6664,  4662, 13920])
-------Step 1-------
tensor([ 4764,  8169, 13364,  5380,    33,  5734,  9500,    12,   143,  8415]) tensor([ 5153, 14687,  5185, 11243,  4844, 12868,  2198, 11138,  5287,  5371])
-------Step 2-------
tensor([2134, 3046, 2576, 5400, 4285,  173, 4456, 1583, 9812, 1378]) tensor([7921, 6483, 2129, 5327, 8946, 4041, 4806, 8146,  469, 6838])
-------Step 3-------
tensor([2134, 3046, 2576, 5400, 4285,  173, 4456, 1583, 9812, 1378]) tensor([11631,  9603,  6176,  9672, 13990,  2836,  8700,  8702,  7081,  2450])
-------Step 4-------
tensor([ 4425,    51, 13793,  6039, 13247,  3832,  8378,  7665,  3035,  7684]) tensor([ 6309,  9507, 13154, 14723, 10589, 11861,  1867, 13720,  1242,  2730])
-------Step 5-------
tensor([ 4425,    51, 13793,  6039, 13247,  3832,  8378,  7665,  3035,  7684]) tensor([ 2472,  8559,  9960,   556,  6552, 13048,  2525,  8034, 10431, 12466])
-------Step 6-------
tensor([13170,  8057,  7103,  2423,  6208, 11651,  9002, 14463,    42, 10550]) tensor([  672,  5410, 11779,  9324,  4455,    49,  2840,  4295, 11194,  7997])
-------Step 7-------
tensor([13170,  8057,  7103,  2423,  6208, 11651,  9002, 14463,    42, 10550]) tensor([12357,  3084,  7298, 14113,  4289,  4540,  2106, 10204, 14508,   576])
-------Step 8-------
tensor([11105, 14346, 12243,  8900,   274,  4506,  9819,  7674,  5918,   113]) tensor([  966, 13977, 10277,  2125,  3781,   245,  7207, 11842, 13758,  5246])
-------Step 9-------
tensor([11105, 14346, 12243,  8900,   274,  4506,  9819,  7674,  5918,   113]) tensor([ 3749,  8790, 10440,  8422,   294, 11413, 10625,  2799,  6006,  9954])
before start barrier
start train
[proc 0] 100 steps, total: 5.215, sample: 0.318, forward: 1.204, backward: 0.599, update: 0.141
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.196, sample: 0.272, forward: 1.174, backward: 0.644, update: 0.121
E20240123 01:53:48.147267 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=8848
W20240123 01:53:48.195413 63287 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
W20240123 01:53:48.218855 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=109, pq.top=109
E20240123 01:53:49.147018 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=8266
W20240123 01:53:49.197129 63287 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
W20240123 01:53:49.224645 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=135, pq.top=135
E20240123 01:53:50.147008 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=508
W20240123 01:53:50.201686 63287 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end0
W20240123 01:53:50.233451 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=160, pq.top=160
E20240123 01:53:51.147006 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=1940
W20240123 01:53:51.210852 63287 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240123 01:53:51.239450 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=183, pq.top=183
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.307 ms                  | 18.195 ms                 |
| Forward                   | 4.139 ms                  | 7.459 ms                  |
| Backward                  | 3.851 ms                  | 7.885 ms                  |
| Optimize                  | 1.441 ms                  | 2.092 ms                  |
| BarrierTimeBeforeRank0    | 29.755 us                 | 5.641 ms                  |
| AfterBackward             | 17.381 ms                 | 26.286 ms                 |
| BlockToStepN              | 6.370 ms                  | 19.472 ms                 |
| OneStep                   | 36.386 ms                 | 69.911 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 4.064, sample: 0.325, forward: 0.422, backward: 0.375, update: 0.132
[proc 3] 200 steps, total: 4.064, sample: 0.300, forward: 0.371, backward: 0.388, update: 0.122
[proc 0] 200 steps, total: 4.064, sample: 0.336, forward: 0.404, backward: 0.394, update: 0.135
[proc 2] 200 steps, total: 4.064, sample: 0.319, forward: 0.382, backward: 0.386, update: 0.125
E20240123 01:53:52.147008 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=7573
W20240123 01:53:52.223938 63287 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
W20240123 01:53:52.251680 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=208, pq.top=208
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.298 ms                  | 2.828 ms                  |
| ProcessBack:UpdateCache   | 2.757 ms                  | 3.694 ms                  |
| ProcessBack:UpsertPq      | 11.648 ms                 | 18.589 ms                 |
| ProcessOneStep            | 17.350 ms                 | 26.253 ms                 |
| BlockToStepN              | 6.347 ms                  | 19.405 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240123 01:53:53.147091 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=141
W20240123 01:53:53.228430 63287 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240123 01:53:53.251844 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=233, pq.top=233
E20240123 01:53:54.147007 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=11269
W20240123 01:53:54.248561 63287 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
W20240123 01:53:54.278815 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=259, pq.top=259
E20240123 01:53:55.147017 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=12167
W20240123 01:53:55.276494 63287 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240123 01:53:55.303663 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=282, pq.top=282
[proc 0] 300 steps, total: 4.036, sample: 0.295, forward: 0.398, backward: 0.373, update: 0.134
[proc 3] 300 steps, total: 4.036, sample: 0.270, forward: 0.369, backward: 0.377, update: 0.125
[proc 2] 300 steps, total: 4.036, sample: 0.279, forward: 0.390, backward: 0.393, update: 0.123
[proc 1] 300 steps, total: 4.036, sample: 0.276, forward: 0.398, backward: 0.386, update: 0.123
E20240123 01:53:56.147006 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=9117
W20240123 01:53:56.281090 63287 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
W20240123 01:53:56.303333 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=308, pq.top=308
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.342 ms                  | 18.195 ms                 |
| Forward                   | 4.082 ms                  | 6.993 ms                  |
| Backward                  | 3.850 ms                  | 7.243 ms                  |
| Optimize                  | 1.426 ms                  | 2.164 ms                  |
| BarrierTimeBeforeRank0    | 29.908 us                 | 5.641 ms                  |
| AfterBackward             | 17.774 ms                 | 30.330 ms                 |
| BlockToStepN              | 7.035 ms                  | 21.910 ms                 |
| OneStep                   | 37.490 ms                 | 79.561 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240123 01:53:57.147006 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=10630
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.292 ms                  | 2.810 ms                  |
| ProcessBack:UpdateCache   | 2.754 ms                  | 3.667 ms                  |
| ProcessBack:UpsertPq      | 11.847 ms                 | 18.589 ms                 |
| ProcessOneStep            | 17.754 ms                 | 30.293 ms                 |
| BlockToStepN              | 7.014 ms                  | 21.837 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240123 01:53:57.282348 63287 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240123 01:53:57.304121 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=332, pq.top=332
E20240123 01:53:58.147008 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=8439
W20240123 01:53:58.289419 63287 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
W20240123 01:53:58.304191 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=357, pq.top=357
E20240123 01:53:59.147014 62777 parallel_pq_v2.h:76] insert failed, size(hashtable)=766
W20240123 01:53:59.290856 63287 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end0
W20240123 01:53:59.321699 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=380, pq.top=380
E20240123 01:54:00.147007 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=6065
[proc 1] 400 steps, total: 4.277, sample: 0.272, forward: 0.389, backward: 0.495, update: 0.123
[proc 3] 400 steps, total: 4.277, sample: 0.251, forward: 0.346, backward: 0.424, update: 0.121
[proc 0] 400 steps, total: 4.277, sample: 0.350, forward: 0.395, backward: 0.374, update: 0.135
[proc 2] 400 steps, total: 4.277, sample: 0.280, forward: 0.384, backward: 0.463, update: 0.127
W20240123 01:54:00.305961 63287 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240123 01:54:00.334165 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=402, pq.top=402
E20240123 01:54:01.147008 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=8066
W20240123 01:54:01.318691 63287 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
W20240123 01:54:01.346570 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=425, pq.top=425
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.396 ms                  | 18.993 ms                 |
| Forward                   | 4.047 ms                  | 6.993 ms                  |
| Backward                  | 3.826 ms                  | 6.102 ms                  |
| Optimize                  | 1.423 ms                  | 2.092 ms                  |
| BarrierTimeBeforeRank0    | 29.755 us                 | 13.283 ms                 |
| AfterBackward             | 17.921 ms                 | 27.967 ms                 |
| BlockToStepN              | 7.655 ms                  | 22.466 ms                 |
| OneStep                   | 39.047 ms                 | 69.911 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240123 01:54:02.147953 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=11744
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.293 ms                  | 2.822 ms                  |
| ProcessBack:UpdateCache   | 2.752 ms                  | 3.631 ms                  |
| ProcessBack:UpsertPq      | 11.942 ms                 | 18.548 ms                 |
| ProcessOneStep            | 17.906 ms                 | 27.932 ms                 |
| BlockToStepN              | 7.632 ms                  | 22.362 ms                 |
+---------------------------+---------------------------+---------------------------+
W20240123 01:54:02.336583 63287 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
W20240123 01:54:02.366066 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=447, pq.top=447
E20240123 01:54:03.147007 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=7847
W20240123 01:54:03.357537 63287 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
W20240123 01:54:03.392022 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=469, pq.top=469
E20240123 01:54:04.147009 63286 parallel_pq_v2.h:76] insert failed, size(hashtable)=11609
W20240123 01:54:04.392199 62777 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=491, pq.top=491
W20240123 01:54:04.394033 63287 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
[proc 1] 500 steps, total: 4.552, sample: 0.294, forward: 0.389, backward: 0.365, update: 0.121
[proc 3] 500 steps, total: 4.552, sample: 0.232, forward: 0.338, backward: 0.355, update: 0.111
[proc 2] 500 steps, total: 4.552, sample: 0.318, forward: 0.387, backward: 0.378, update: 0.122
[proc 0] 500 steps, total: 4.552, sample: 0.323, forward: 0.395, backward: 0.400, update: 0.126
Successfully xmh. training takes 22.144472122192383 seconds
before call kg_cache_controller.StopThreads()
W20240123 01:54:04.816257 62777 grad_async_v2.h:71] call StopThreads. PID = 62306
W20240123 01:54:04.816288 62777 grad_base.h:210] before processOneStepNegThread_.join();
W20240123 01:54:04.816607 62777 grad_base.h:212] after processOneStepNegThread_.join();
W20240123 01:54:04.816622 62777 grad_async_v2.h:73] call GradProcessingBase::StopThreads.
W20240123 01:54:04.823285 62777 grad_async_v2.h:91] StopThreads done.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7fc8cd91ee50>
