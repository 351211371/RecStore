WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 10:55:37.905836 4166556 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_46', no_save_emb=True, max_step=500, batch_size=1800, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.01, shuffle=False, backwardMode='CppSync', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [4166556 sampler.py:454] Start PreSampling
WARNING [4166556 sampler.py:532] Before construct renumbering_dict
WARNING [4166556 sampler.py:555] PreSampling done
W20240128 10:55:40.049774 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 10:55:40.049922 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 10:55:40.049944 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 10:55:40.049968 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 10:55:40.049989 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 10:55:40.050010 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 10:55:40.050033 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 10:55:40.050055 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 10:55:40.050073 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 10:55:40.050091 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 10:55:40.050117 4166556 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 10:55:40.050137 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 10:55:40.050153 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 10:55:40.050244 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 10:55:40.050269 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 10:55:40.050287 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 10:55:40.050323 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 10:55:40.050341 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 10:55:40.050360 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 10:55:40.050376 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 10:55:40.050398 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 10:55:40.050415 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 10:55:40.050434 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 10:55:40.050451 4166556 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 10:55:40.050467 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 10:55:40.050480 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 10:55:40.050518 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 10:55:40.050540 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 10:55:40.050557 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 10:55:40.050575 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 10:55:40.050592 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 10:55:40.050616 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 10:55:40.050635 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 10:55:40.050652 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 10:55:40.050673 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 10:55:40.050698 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 10:55:40.050715 4166556 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 10:55:40.050730 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 10:55:40.050748 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 10:55:40.050783 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 10:55:40.050804 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 10:55:40.050822 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 10:55:40.050844 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 10:55:40.050863 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 10:55:40.050882 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 10:55:40.050899 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 10:55:40.050916 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 10:55:40.050932 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 10:55:40.050957 4166556 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 10:55:40.050978 4166556 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 10:55:40.050993 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 10:55:40.051007 4166556 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 37
Rank1: cached key size 37
Rank2: cached key size 37
Rank3: cached key size 37
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 259,  463,  532,  ..., 1345, 5527, 6213]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.325 seconds
[Rank1] pid = 4166877
[Rank2] pid = 4166942
INFO [4166556 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [4166877 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [4166942 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [4167006 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [4166942 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [4167006 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [4166556 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [4166877 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
I20240128 10:55:43.585999 4166943 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 10:55:43.586939 4167008 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 10:55:43.624817 4167007 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 10:55:43.626498 4166878 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
[Rank3] pid = 4167006
train_sampler.Prefill()
-------Step 0-------
tensor([   24,  3329,  9413,  8280,  7868,  3403, 10285,  3710, 11493,  9683]) tensor([  532,  7294,  9509,  3385,  7206,  6868, 13746,  7220,  6804,  7183])
-------Step 1-------
tensor([   24,  3329,  9413,  8280,  7868,  3403, 10285,  3710, 11493,  9683]) tensor([11226, 12801,   404,  2780,  1193, 10929,  5444,  1871,  1757, 14055])
-------Step 2-------
tensor([ 9911,  6366,  5309,  6292,   829,  6936,  7541,  1872, 13895,  6468]) tensor([ 7240,  4516,  2648, 10794,  7210,  2820,  3155, 11625, 11843,  2832])
-------Step 3-------
tensor([ 9911,  6366,  5309,  6292,   829,  6936,  7541,  1872, 13895,  6468]) tensor([ 8975,  4733,  4409,  9685, 12310,  9791, 12777,  9341, 13843,  5200])
-------Step 4-------
tensor([10945,  3680,  6622,  1812, 11283, 11484, 14561, 10122,  8133,  5711]) tensor([ 2722,  8178,  6192, 10654,  8799, 12244,   816,  1512, 12097, 14587])
-------Step 5-------
tensor([10945,  3680,  6622,  1812, 11283, 11484, 14561, 10122,  8133,  5711]) tensor([10923,  7979, 13029, 13968,   972,  9121,  5542, 13154, 11393, 14474])
-------Step 6-------
tensor([ 9949,  9463,  2440, 10221, 12587,  8293,  9212,  2089,  1954,  8297]) tensor([ 5176, 11943,  7391, 11536,  6137,  1077,  8601, 12248, 13718, 12813])
-------Step 7-------
tensor([ 9949,  9463,  2440, 10221, 12587,  8293,  9212,  2089,  1954,  8297]) tensor([11319, 14121,  7029, 11060,  7842, 11776, 10669, 13435, 14499,  8635])
-------Step 8-------
tensor([ 4521,  7012, 12445, 10934,    17, 11471,  7972,  9585,  4417,  6366]) tensor([ 9025, 11318, 13017,   110, 11480, 11289,  5180,  1150,  6307, 11268])
-------Step 9-------
tensor([ 4521,  7012, 12445, 10934,    17, 11471,  7972,  9585,  4417,  6366]) tensor([ 8238, 14555,  5549,  6331,  3543,  6367,    27,  6853,  6410, 13574])
before start barrier
start train
[proc 0] 100 steps, total: 4.769, sample: 0.249, forward: 1.571, backward: 2.248, update: 0.499
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 4.807, sample: 0.242, forward: 1.528, backward: 2.117, update: 0.477
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 4.768, sample: 0.251, forward: 1.471, backward: 2.084, update: 0.513
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 4.808, sample: 0.241, forward: 1.520, backward: 2.073, update: 0.482
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 897.501 us                | 18.813 ms                 |
| Forward                   | 6.025 ms                  | 18.181 ms                 |
| Backward                  | 3.172 ms                  | 332.870 ms                |
| Optimize                  | 4.637 ms                  | 9.265 ms                  |
| OneStep                   | 16.202 ms                 | 1.271 s                   |
+---------------------------+---------------------------+---------------------------+
[proc 1] 200 steps, total: 1.874, sample: 0.272, forward: 0.525, backward: 0.305, update: 0.450
[proc 2] 200 steps, total: 1.874, sample: 0.248, forward: 0.499, backward: 0.310, update: 0.392
[proc 3] 200 steps, total: 1.874, sample: 0.242, forward: 0.508, backward: 0.304, update: 0.398
[proc 0] 200 steps, total: 1.874, sample: 0.247, forward: 0.547, backward: 0.305, update: 0.420
[proc 0] 300 steps, total: 2.833, sample: 0.329, forward: 0.746, backward: 0.320, update: 0.562
[proc 3] 300 steps, total: 2.833, sample: 0.457, forward: 0.684, backward: 0.317, update: 0.541
[proc 1] 300 steps, total: 2.833, sample: 0.380, forward: 0.704, backward: 0.324, update: 0.563
[proc 2] 300 steps, total: 2.833, sample: 0.374, forward: 0.715, backward: 0.325, update: 0.554
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 957.848 us                | 20.413 ms                 |
| Forward                   | 6.076 ms                  | 13.646 ms                 |
| Backward                  | 3.214 ms                  | 3.988 ms                  |
| Optimize                  | 4.670 ms                  | 8.742 ms                  |
| OneStep                   | 19.096 ms                 | 48.945 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 2] 400 steps, total: 3.034, sample: 0.397, forward: 0.755, backward: 0.332, update: 0.604
[proc 1] 400 steps, total: 3.034, sample: 0.407, forward: 0.752, backward: 0.323, update: 0.609
[proc 3] 400 steps, total: 3.034, sample: 0.418, forward: 0.732, backward: 0.324, update: 0.582
[proc 0] 400 steps, total: 3.034, sample: 0.356, forward: 0.814, backward: 0.298, update: 0.614
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.110 ms                  | 19.603 ms                 |
| Forward                   | 6.582 ms                  | 12.925 ms                 |
| Backward                  | 3.204 ms                  | 3.701 ms                  |
| Optimize                  | 5.043 ms                  | 8.742 ms                  |
| OneStep                   | 21.334 ms                 | 47.519 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 0] 500 steps, total: 2.497, sample: 0.308, forward: 0.679, backward: 0.294, update: 0.510
Successfully xmh. training takes 15.00781536102295 seconds
before call kg_cache_controller.StopThreads()
[proc 3] 500 steps, total: 2.498, sample: 0.347, forward: 0.640, backward: 0.295, update: 0.502
[proc 2] 500 steps, total: 2.498, sample: 0.360, forward: 0.642, backward: 0.325, update: 0.504
[proc 1] 500 steps, total: 2.498, sample: 0.334, forward: 0.652, backward: 0.323, update: 0.518
