WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 18:24:24.360272 634087 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='SimplE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/SimplE_FB15k_31', no_save_emb=True, max_step=500, batch_size=1800, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [634087 sampler.py:454] Start PreSampling
WARNING [634087 sampler.py:532] Before construct renumbering_dict
WARNING [634087 sampler.py:555] PreSampling done
W20240128 18:24:26.295730 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 18:24:26.295859 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 18:24:26.295884 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 18:24:26.295900 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 18:24:26.295918 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 18:24:26.295933 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 18:24:26.295953 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 18:24:26.295972 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 18:24:26.295996 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 18:24:26.296012 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 18:24:26.296032 634087 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 18:24:26.296049 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 18:24:26.296067 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 18:24:26.296144 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 18:24:26.296167 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 18:24:26.296182 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 18:24:26.296213 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 18:24:26.296228 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 18:24:26.296243 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 18:24:26.296260 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 18:24:26.296276 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 18:24:26.296294 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 18:24:26.296311 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 18:24:26.296326 634087 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 18:24:26.296340 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 18:24:26.296353 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 18:24:26.296386 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 18:24:26.296403 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 18:24:26.296418 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 18:24:26.296432 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 18:24:26.296445 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 18:24:26.296464 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 18:24:26.296479 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 18:24:26.296496 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 18:24:26.296511 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 18:24:26.296525 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 18:24:26.296540 634087 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 18:24:26.296552 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 18:24:26.296566 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 18:24:26.296597 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 18:24:26.296618 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 18:24:26.296634 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 18:24:26.296650 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 18:24:26.296669 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 18:24:26.296686 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 18:24:26.296703 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 18:24:26.296717 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 18:24:26.296733 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 18:24:26.296751 634087 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 18:24:26.296768 634087 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 18:24:26.296782 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 18:24:26.296798 634087 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 186
Rank1: cached key size 186
Rank2: cached key size 186
Rank3: cached key size 186
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 871, 1098, 1164,  ..., 1631, 5812, 6716]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.093 seconds
[Rank1] pid = 634297
[Rank2] pid = 634362
INFO [634087 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [634297 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [634297 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [634362 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [634426 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [634362 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [634426 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [634087 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
E20240128 18:24:29.674582 634298 recstore.cc:66] init folly done
E20240128 18:24:29.674650 634427 recstore.cc:66] init folly done
E20240128 18:24:29.674705 634363 recstore.cc:66] init folly done
E20240128 18:24:29.674849 634428 recstore.cc:66] init folly done
I20240128 18:24:29.717267 634427 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 18:24:29.727599 634298 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 18:24:29.736519 634363 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 18:24:29.751358 634428 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 887.592 us                | 17.921 ms                 |
| Forward                   | 7.891 ms                  | 19.363 ms                 |
| Backward                  | 3.662 ms                  | 362.028 ms                |
| Optimize                  | 6.526 ms                  | 15.040 ms                 |
| OneStep                   | 20.659 ms                 | 1.398 s                   |
+---------------------------+---------------------------+---------------------------+
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 5.036, sample: 0.251, forward: 1.705, backward: 1.959, update: 0.750
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 5.013, sample: 0.256, forward: 1.349, backward: 1.244, update: 0.732
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 5.027, sample: 0.251, forward: 1.689, backward: 1.956, update: 0.715
[Rank3] pid = 634426
train_sampler.Prefill()
-------Step 0-------
tensor([ 8702,  4205,  9625,  7145,  7461,  4431,   628,  4266, 11777, 11528]) tensor([ 1164,  7685,  9700,   660,  7382,  8219, 13230,  8561,  7316,  8025])
-------Step 1-------
tensor([ 8702,  4205,  9625,  7145,  7461,  4431,   628,  4266, 11777, 11528]) tensor([ 9167, 10708,   928,  3160,  1695, 12363,  6006,  2638,  1895, 12932])
-------Step 2-------
tensor([ 9938,  8191,  5563,  7577,  1309,  5722,  7504,  2644, 13396,   177]) tensor([ 7410,  4975,  2823, 12968,  6726,   653,  4151, 11839, 12620,  3601])
-------Step 3-------
tensor([ 9938,  8191,  5563,  7577,  1309,  5722,  7504,  2644, 13396,   177]) tensor([10925,   269,  4250,   178, 14345, 10665, 14322,  9237, 14421,  5278])
-------Step 4-------
tensor([11107,  4215,   557,    39, 11264, 11018, 14893, 12182,  9583,  6390]) tensor([ 2698,  9819,  7603, 11345,  9645, 14304,  1245,  2212, 11615, 13493])
-------Step 5-------
tensor([11107,  4215,   557,    39, 11264, 11018, 14893, 12182,  9583,  6390]) tensor([11178,  9363, 10775,   584,  1413, 11043,  7155, 14663, 11234, 13353])
-------Step 6-------
tensor([  175,   114,  2791, 11844, 14468,   105,  7499,    58,  2952,   121]) tensor([ 6055, 11945,  7531, 11391,  7398,  1490,  8939, 14314, 11499, 11590])
-------Step 7-------
tensor([  175,   114,  2791, 11844, 14468,   105,  7499,    58,  2952,   121]) tensor([10264, 13080,  6894, 12525,  9546, 11602, 10500, 13760, 14466,  8971])
-------Step 8-------
tensor([ 4702,  8358, 13335,  9931,  3078, 11459,  7405,  9512,  4948,  8191]) tensor([11440, 10864, 13068,   433, 12316,  9469,  6300,  1834,  7150,  9277])
-------Step 9-------
tensor([ 4702,  8358, 13335,  9931,  3078, 11459,  7405,  9512,  4948,  8191]) tensor([ 9114, 13273,  6086,  6825,  3663,  5966, 12947,  6996,  7918, 12334])
before start barrier
start train
[proc 0] 100 steps, total: 5.047, sample: 0.251, forward: 1.735, backward: 2.004, update: 0.729
[proc 3] 200 steps, total: 2.344, sample: 0.243, forward: 0.731, backward: 0.381, update: 0.647
[proc 2] 200 steps, total: 2.344, sample: 0.262, forward: 0.719, backward: 0.381, update: 0.611
[proc 1] 200 steps, total: 2.345, sample: 0.262, forward: 0.737, backward: 0.365, update: 0.660
[proc 0] 200 steps, total: 2.345, sample: 0.252, forward: 0.763, backward: 0.361, update: 0.635
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 929.474 us                | 18.108 ms                 |
| Forward                   | 7.882 ms                  | 18.639 ms                 |
| Backward                  | 3.727 ms                  | 5.236 ms                  |
| Optimize                  | 6.542 ms                  | 9.168 ms                  |
| OneStep                   | 21.484 ms                 | 47.335 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 3] 300 steps, total: 2.774, sample: 0.398, forward: 0.717, backward: 0.371, update: 0.591
[proc 0] 300 steps, total: 2.774, sample: 0.296, forward: 0.780, backward: 0.370, update: 0.601
[proc 2] 300 steps, total: 2.774, sample: 0.321, forward: 0.729, backward: 0.357, update: 0.607
[proc 1] 300 steps, total: 2.774, sample: 0.326, forward: 0.722, backward: 0.360, update: 0.624
[proc 1] 400 steps, total: 2.899, sample: 0.365, forward: 0.729, backward: 0.367, update: 0.626
[proc 2] 400 steps, total: 2.899, sample: 0.351, forward: 0.739, backward: 0.367, update: 0.601
[proc 0] 400 steps, total: 2.900, sample: 0.332, forward: 0.792, backward: 0.370, update: 0.605
[proc 3] 400 steps, total: 2.900, sample: 0.383, forward: 0.729, backward: 0.370, update: 0.600
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.004 ms                  | 18.489 ms                 |
| Forward                   | 7.820 ms                  | 12.707 ms                 |
| Backward                  | 3.753 ms                  | 5.088 ms                  |
| Optimize                  | 6.510 ms                  | 9.265 ms                  |
| OneStep                   | 22.256 ms                 | 43.703 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 1] 500 steps, total: 2.462, sample: 0.265, forward: 0.700, backward: 0.366, update: 0.631
[proc 2] 500 steps, total: 2.462, sample: 0.289, forward: 0.696, backward: 0.365, update: 0.588
[proc 3] 500 steps, total: 2.462, sample: 0.257, forward: 0.708, backward: 0.365, update: 0.622
[proc 0] 500 steps, total: 2.462, sample: 0.253, forward: 0.738, backward: 0.362, update: 0.622
Successfully xmh. training takes 15.526655673980713 seconds
before call kg_cache_controller.StopThreads()
