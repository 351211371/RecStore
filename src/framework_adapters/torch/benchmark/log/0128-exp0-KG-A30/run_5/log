WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 10:46:54.644670 4149544 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_40', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.01, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [4149544 sampler.py:454] Start PreSampling
WARNING [4149544 sampler.py:532] Before construct renumbering_dict
WARNING [4149544 sampler.py:555] PreSampling done
W20240128 10:46:57.041193 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 10:46:57.041358 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 10:46:57.041396 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 10:46:57.041420 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 10:46:57.041450 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 10:46:57.041472 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 10:46:57.041497 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 10:46:57.041520 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 10:46:57.041541 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 10:46:57.041560 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 10:46:57.041585 4149544 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 10:46:57.041611 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 10:46:57.041627 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 10:46:57.041725 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 10:46:57.041750 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 10:46:57.041771 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 10:46:57.041806 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 10:46:57.041828 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 10:46:57.041849 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 10:46:57.041872 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 10:46:57.041888 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 10:46:57.041908 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 10:46:57.041926 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 10:46:57.041945 4149544 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 10:46:57.041961 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 10:46:57.041976 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 10:46:57.042018 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 10:46:57.042042 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 10:46:57.042059 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 10:46:57.042078 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 10:46:57.042104 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 10:46:57.042126 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 10:46:57.042145 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 10:46:57.042165 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 10:46:57.042181 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 10:46:57.042208 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 10:46:57.042225 4149544 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 10:46:57.042240 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 10:46:57.042258 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 10:46:57.042299 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 10:46:57.042323 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 10:46:57.042351 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 10:46:57.042376 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 10:46:57.042392 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 10:46:57.042415 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 10:46:57.042439 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 10:46:57.042457 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 10:46:57.042479 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 10:46:57.042500 4149544 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 10:46:57.042516 4149544 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 10:46:57.042531 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 10:46:57.042553 4149544 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240128 10:46:57.220445 4149544 IPCTensor.h:368] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240128 10:46:57.220577 4149544 IPCTensor.h:368] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 37
Rank1: cached key size 37
Rank2: cached key size 37
Rank3: cached key size 37
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 337,  658,  752,  ..., 1063, 5461, 6708]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.608 seconds
[Rank1] pid = 4149866
[Rank2] pid = 4149931
INFO [4149544 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [4149866 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [4149995 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [4149931 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [4149931 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [4149544 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 10:47:00.623355 4149996 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_0 [149, 400]; dev=0; size=232.8 kB
W20240128 10:47:00.623620 4149932 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_2 [149, 400]; dev=2; size=232.8 kB
W20240128 10:47:00.624025 4149996 IPCTensor.h:368] NewIPCTensor: input_keys_0 [1000000]0x100014876000 7.629 MB
W20240128 10:47:00.624208 4149996 IPCTensor.h:368] NewIPCTensor: input_keys_neg_0 [1000000]0x100015019000 7.629 MB
W20240128 10:47:00.624306 4149996 IPCTensor.h:368] NewIPCTensor: backward_grads_0 [1000000, 400]0x1000157bc000 1.49 GB
W20240128 10:47:00.624370 4149996 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x100074d9f000 1.49 GB
W20240128 10:47:00.624464 4149996 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 10:47:00.624594 4149932 IPCTensor.h:368] NewIPCTensor: input_keys_2 [1000000]0x1000d4384000 7.629 MB
W20240128 10:47:00.624801 4149932 IPCTensor.h:368] NewIPCTensor: input_keys_neg_2 [1000000]0x1000d4b27000 7.629 MB
W20240128 10:47:00.624898 4149932 IPCTensor.h:368] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000d52ca000 1.49 GB
W20240128 10:47:00.624974 4149932 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x1001348ad000 1.49 GB
W20240128 10:47:00.625032 4149932 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
INFO [4149995 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 10:47:00.628232 4149997 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_3 [149, 400]; dev=3; size=232.8 kB
INFO [4149866 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 10:47:00.629622 4149867 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_1 [149, 400]; dev=1; size=232.8 kB
W20240128 10:47:00.632889 4149997 IPCTensor.h:368] NewIPCTensor: input_keys_3 [1000000]0x100193e98000 7.629 MB
W20240128 10:47:00.632895 4149996 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 10:47:00.632920 4149932 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 10:47:00.632938 4149867 IPCTensor.h:368] NewIPCTensor: input_keys_1 [1000000]0x10019463b000 7.629 MB
W20240128 10:47:00.633000 4149997 IPCTensor.h:368] NewIPCTensor: input_keys_neg_3 [1000000]0x100194dde000 7.629 MB
W20240128 10:47:00.633030 4149867 IPCTensor.h:368] NewIPCTensor: input_keys_neg_1 [1000000]0x100195581000 7.629 MB
W20240128 10:47:00.633059 4149997 IPCTensor.h:368] NewIPCTensor: backward_grads_3 [1000000, 400]0x100195d24000 1.49 GB
W20240128 10:47:00.633086 4149997 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001f5307000 1.49 GB
W20240128 10:47:00.633091 4149867 IPCTensor.h:368] NewIPCTensor: backward_grads_1 [1000000, 400]0x1002548ea000 1.49 GB
W20240128 10:47:00.633121 4149997 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240128 10:47:00.633136 4149867 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1002b3ecd000 1.49 GB
W20240128 10:47:00.633174 4149867 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 10:47:00.644551 4149997 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240128 10:47:00.644555 4149867 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [4149866 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [4149931 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [4149995 DistTensor.py:56] The tensor name already exists in the kvstore
[Rank3] pid = 4149995
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 149), (149, 298), (298, 447), (447, 596)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [4149544 DistTensor.py:56] The tensor name already exists in the kvstore
I20240128 10:47:02.028542 4149996 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240128 10:47:02.028599 4149932 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 10:47:02.028852 4149867 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 10:47:02.028918 4149997 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240128 10:47:02.030159 4149996 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 1,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.01,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240128 10:47:02.030303 4149996 grad_base.h:184] Init GradProcessingBase done
I20240128 10:47:02.034330 4149996 grad_async_v2.h:32] Use background thread to update emb. nr_background_threads=32
W20240128 10:47:02.034427 4149996 kg_controller.h:78] after init GradAsyncProcessingV2
I20240128 10:47:02.034432 4149996 kg_controller.h:84] Construct KGCacheController done
I20240128 10:47:02.387995 4149996 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240128 10:47:03.024714 4150409 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240128 10:47:03.024940 4150409 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
I20240128 10:47:03.047223 4149996 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 10:47:03.066792 4149997 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 10:47:03.069988 4149867 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 10:47:03.078685 4149932 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240128 10:47:05.683977 4150184 parallel_pq_v2.h:76] insert failed, size(hashtable)=2
W20240128 10:47:05.695405 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=1, pq.top=0
W20240128 10:47:05.701884 4150409 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 10:47:06.683009 4150184 parallel_pq_v2.h:76] insert failed, size(hashtable)=1274
W20240128 10:47:06.695039 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=29, pq.top=29
W20240128 10:47:06.716897 4150409 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end0
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 978.492 us                | 9.725 ms                  |
| Forward                   | 2.863 ms                  | 1.083 s                   |
| Backward                  | 2.862 ms                  | 222.047 ms                |
| Optimize                  | 1.237 ms                  | 2.982 ms                  |
| BarrierTimeBeforeRank0    | 33.977 us                 | 532.844 ms                |
| AfterBackward             | 15.906 ms                 | 774.412 ms                |
| BlockToStepN              | 7.509 ms                  | 39.822 ms                 |
| OneStep                   | 36.658 ms                 | 2.622 s                   |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 1.818 ms                  | 66.546 ms                 |
| ProcessBack:UpdateCache   | 1.554 ms                  | 207.303 ms                |
| ProcessBack:UpsertPq      | 12.572 ms                 | 17.598 ms                 |
| ProcessOneStep            | 16.628 ms                 | 774.079 ms                |
| BlockToStepN              | 7.136 ms                  | 39.776 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 10:47:07.683080 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=1480
W20240128 10:47:07.695003 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=55, pq.top=55
W20240128 10:47:07.720296 4150409 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
E20240128 10:47:08.683009 4150184 parallel_pq_v2.h:76] insert failed, size(hashtable)=1363
W20240128 10:47:08.700995 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=82, pq.top=82
W20240128 10:47:08.741075 4150409 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 6.297, sample: 0.195, forward: 1.216, backward: 0.644, update: 0.099
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 6.305, sample: 0.216, forward: 1.799, backward: 0.611, update: 0.106
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 6.309, sample: 0.227, forward: 1.680, backward: 0.544, update: 0.103
train_sampler.Prefill()
-------Step 0-------
tensor([   28,  3585,  9035,  7340,  7032,  5048,  9165,  3840, 11290,  9978]) tensor([  752,  7190,  9136,  2996,  7131, 10152, 14195, 10643,  7313,  7380])
-------Step 1-------
tensor([   28,  3585,  9035,  7340,  7032,  5048,  9165,  3840, 11290,  9978]) tensor([ 6643, 12691, 11884, 14579,  7147,  8506,  5347,  1000,  1417,  7899])
-------Step 2-------
tensor([10018,  1498,  2923,  2292,  9096,  8616,  3961,  9781, 10568,  7928]) tensor([ 9724,  3000,  2677, 12752,   998,  1534, 11742,  5095, 10705,  8703])
-------Step 3-------
tensor([10018,  1498,  2923,  2292,  9096,  8616,  3961,  9781, 10568,  7928]) tensor([ 4327, 11134,  6270, 12376,  1766,  9346,  1122, 11824,  4422, 11421])
-------Step 4-------
tensor([ 2977, 14874, 10863,    30,  4343,  5468, 12240,  6351,  3154,   789]) tensor([13098,  4344, 10183,  9997,  2772,  8961,  5444,  4651,  8723, 11841])
-------Step 5-------
tensor([ 2977, 14874, 10863,    30,  4343,  5468, 12240,  6351,  3154,   789]) tensor([ 7558,  6033,  7854, 14299,  8224, 10713,  1920, 13828,  6847,  6674])
-------Step 6-------
tensor([11639,  3718,  5889,  1683, 11325, 10326, 14747, 10863, 11915,  6060]) tensor([ 2375,  8357,  6290, 11380,  9049, 12464,   725,  1529, 10908, 13792])
-------Step 7-------
tensor([11639,  3718,  5889,  1683, 11325, 10326, 14747, 10863, 11915,  6060]) tensor([ 4194, 13444,  8341,  6584,  4396, 12408,  5627,  6318,  9949, 13353])
-------Step 8-------
tensor([ 8872,  9310, 13502, 11079,  3986,  6277,   431,  5030,  4358, 14871]) tensor([ 5889, 11441, 14053,   411, 10185, 10377,  1074,  8368,  7660,  7771])
-------Step 9-------
tensor([ 8872,  9310, 13502, 11079,  3986,  6277,   431,  5030,  4358, 14871]) tensor([ 8946, 11562,   388,  2962,  1141, 13390,  5693,  2394,  1417, 13323])
before start barrier
start train
[proc 0] 100 steps, total: 6.328, sample: 0.237, forward: 1.399, backward: 0.558, update: 0.122
E20240128 10:47:09.683099 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=5724
W20240128 10:47:09.712901 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=108, pq.top=108
W20240128 10:47:09.758342 4150409 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end0
E20240128 10:47:10.683007 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=3807
W20240128 10:47:10.720608 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=134, pq.top=134
W20240128 10:47:10.788475 4150409 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
E20240128 10:47:11.683014 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=647
W20240128 10:47:11.737385 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=157, pq.top=157
W20240128 10:47:11.792480 4150409 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.123 ms                  | 14.604 ms                 |
| Forward                   | 3.350 ms                  | 6.164 ms                  |
| Backward                  | 2.831 ms                  | 6.573 ms                  |
| Optimize                  | 1.227 ms                  | 2.833 ms                  |
| BarrierTimeBeforeRank0    | 21.316 us                 | 3.280 ms                  |
| AfterBackward             | 21.046 ms                 | 26.356 ms                 |
| BlockToStepN              | 5.877 ms                  | 32.068 ms                 |
| OneStep                   | 37.837 ms                 | 75.764 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.029 ms                  | 6.006 ms                  |
| ProcessBack:UpdateCache   | 1.622 ms                  | 2.663 ms                  |
| ProcessBack:UpsertPq      | 15.580 ms                 | 21.022 ms                 |
| ProcessOneStep            | 21.149 ms                 | 26.327 ms                 |
| BlockToStepN              | 6.120 ms                  | 32.015 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 10:47:12.683013 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=7083
W20240128 10:47:12.746479 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=181, pq.top=181
W20240128 10:47:12.810123 4150409 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
[proc 2] 200 steps, total: 4.176, sample: 0.243, forward: 0.295, backward: 0.251, update: 0.098
[proc 3] 200 steps, total: 4.176, sample: 0.258, forward: 0.301, backward: 0.259, update: 0.105
[proc 1] 200 steps, total: 4.176, sample: 0.234, forward: 0.298, backward: 0.353, update: 0.095
[proc 0] 200 steps, total: 4.176, sample: 0.300, forward: 0.331, backward: 0.280, update: 0.126
E20240128 10:47:13.683008 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=6945
W20240128 10:47:13.746192 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=205, pq.top=205
W20240128 10:47:13.810748 4150409 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
E20240128 10:47:14.683010 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=5063
W20240128 10:47:14.774176 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=230, pq.top=230
W20240128 10:47:14.832525 4150409 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 10:47:15.683009 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=4936
W20240128 10:47:15.797710 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=254, pq.top=254
W20240128 10:47:15.840718 4150409 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
E20240128 10:47:16.683007 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=1600
W20240128 10:47:16.812760 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=277, pq.top=277
W20240128 10:47:16.842389 4150409 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.163 ms                  | 14.604 ms                 |
| Forward                   | 3.332 ms                  | 6.164 ms                  |
| Backward                  | 2.816 ms                  | 6.510 ms                  |
| Optimize                  | 1.156 ms                  | 2.758 ms                  |
| BarrierTimeBeforeRank0    | 31.757 us                 | 7.490 ms                  |
| AfterBackward             | 19.177 ms                 | 26.343 ms                 |
| BlockToStepN              | 8.418 ms                  | 28.908 ms                 |
| OneStep                   | 39.069 ms                 | 72.616 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.047 ms                  | 2.490 ms                  |
| ProcessBack:UpdateCache   | 1.793 ms                  | 2.644 ms                  |
| ProcessBack:UpsertPq      | 13.359 ms                 | 20.603 ms                 |
| ProcessOneStep            | 18.815 ms                 | 26.319 ms                 |
| BlockToStepN              | 8.438 ms                  | 28.847 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 10:47:17.683013 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=5722
W20240128 10:47:17.812028 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=299, pq.top=299
[proc 3] 300 steps, total: 4.307, sample: 0.235, forward: 0.312, backward: 0.280, update: 0.105
[proc 1] 300 steps, total: 4.307, sample: 0.243, forward: 0.328, backward: 0.317, update: 0.104
[proc 0] 300 steps, total: 4.307, sample: 0.271, forward: 0.322, backward: 0.273, update: 0.110
[proc 2] 300 steps, total: 4.307, sample: 0.201, forward: 0.303, backward: 0.326, update: 0.097
W20240128 10:47:17.859948 4150409 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240128 10:47:18.683013 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=1555
W20240128 10:47:18.812400 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=321, pq.top=321
W20240128 10:47:18.860332 4150409 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
E20240128 10:47:19.683012 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=4152
W20240128 10:47:19.842617 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=347, pq.top=347
W20240128 10:47:19.864130 4150409 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
E20240128 10:47:20.683007 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=4625
W20240128 10:47:20.863577 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=372, pq.top=372
W20240128 10:47:20.871910 4150409 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
E20240128 10:47:21.683007 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=2498
W20240128 10:47:21.882301 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=395, pq.top=395
W20240128 10:47:21.893505 4150409 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.180 ms                  | 15.087 ms                 |
| Forward                   | 3.300 ms                  | 5.884 ms                  |
| Backward                  | 2.797 ms                  | 6.477 ms                  |
| Optimize                  | 1.146 ms                  | 2.656 ms                  |
| BarrierTimeBeforeRank0    | 64.891 us                 | 12.747 ms                 |
| AfterBackward             | 17.285 ms                 | 25.866 ms                 |
| BlockToStepN              | 9.201 ms                  | 39.822 ms                 |
| OneStep                   | 39.441 ms                 | 81.034 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 3] 400 steps, total: 4.345, sample: 0.218, forward: 0.306, backward: 0.313, update: 0.107
[proc 0] 400 steps, total: 4.345, sample: 0.255, forward: 0.316, backward: 0.286, update: 0.108
[proc 2] 400 steps, total: 4.345, sample: 0.236, forward: 0.315, backward: 0.346, update: 0.094
[proc 1] 400 steps, total: 4.345, sample: 0.243, forward: 0.320, backward: 0.305, update: 0.101
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.034 ms                  | 2.407 ms                  |
| ProcessBack:UpdateCache   | 1.556 ms                  | 2.602 ms                  |
| ProcessBack:UpsertPq      | 12.709 ms                 | 20.380 ms                 |
| ProcessOneStep            | 17.238 ms                 | 25.841 ms                 |
| BlockToStepN              | 9.177 ms                  | 43.494 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 10:47:22.683008 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=6442
W20240128 10:47:22.895252 4150409 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
W20240128 10:47:22.909168 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=417, pq.top=417
E20240128 10:47:23.683008 4149996 parallel_pq_v2.h:76] insert failed, size(hashtable)=2634
W20240128 10:47:23.898183 4150409 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end0
W20240128 10:47:23.923427 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=440, pq.top=440
E20240128 10:47:24.683007 4150184 parallel_pq_v2.h:76] insert failed, size(hashtable)=190
W20240128 10:47:24.902032 4150409 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
W20240128 10:47:24.923542 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=465, pq.top=465
E20240128 10:47:25.683012 4150408 parallel_pq_v2.h:76] insert failed, size(hashtable)=8495
W20240128 10:47:25.911936 4150409 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
W20240128 10:47:25.937845 4149996 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=489, pq.top=489
[proc 1] 500 steps, total: 4.223, sample: 0.218, forward: 0.320, backward: 0.286, update: 0.104
[proc 0] 500 steps, total: 4.223, sample: 0.240, forward: 0.309, backward: 0.276, update: 0.113
[proc 2] 500 steps, total: 4.223, sample: 0.264, forward: 0.315, backward: 0.294, update: 0.099
[proc 3] 500 steps, total: 4.223, sample: 0.236, forward: 0.320, backward: 0.271, update: 0.110
Successfully xmh. training takes 23.380159616470337 seconds
before call kg_cache_controller.StopThreads()
W20240128 10:47:26.427392 4149996 grad_async_v2.h:71] call StopThreads. PID = 4149544
W20240128 10:47:26.427418 4149996 grad_base.h:212] before processOneStepNegThread_.join();
W20240128 10:47:26.427604 4149996 grad_base.h:214] after processOneStepNegThread_.join();
W20240128 10:47:26.427609 4149996 grad_async_v2.h:73] call GradProcessingBase::StopThreads.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
W20240128 10:47:26.436571 4149996 grad_async_v2.h:91] StopThreads done.
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.199 ms                  | 14.604 ms                 |
| Forward                   | 3.286 ms                  | 4.822 ms                  |
| Backward                  | 2.796 ms                  | 6.464 ms                  |
| Optimize                  | 1.140 ms                  | 2.656 ms                  |
| BarrierTimeBeforeRank0    | 130.956 us                | 12.983 ms                 |
| AfterBackward             | 16.962 ms                 | 25.763 ms                 |
| BlockToStepN              | 9.853 ms                  | 42.332 ms                 |
| OneStep                   | 40.001 ms                 | 78.618 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.017 ms                  | 2.407 ms                  |
| ProcessBack:UpdateCache   | 1.504 ms                  | 2.593 ms                  |
| ProcessBack:UpsertPq      | 12.350 ms                 | 20.339 ms                 |
| ProcessOneStep            | 16.934 ms                 | 25.739 ms                 |
| BlockToStepN              | 9.793 ms                  | 42.258 ms                 |
+---------------------------+---------------------------+---------------------------+
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7f69b0f7c690>
