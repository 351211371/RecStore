WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 15:38:10.386456 414644 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='ComplEx', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/ComplEx_FB15k_10', no_save_emb=True, max_step=500, batch_size=1800, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.01, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [414644 sampler.py:454] Start PreSampling
WARNING [414644 sampler.py:532] Before construct renumbering_dict
WARNING [414644 sampler.py:555] PreSampling done
W20240128 15:38:12.791664 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 15:38:12.791852 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 15:38:12.791884 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 15:38:12.791909 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 15:38:12.791930 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 15:38:12.791951 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 15:38:12.791972 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 15:38:12.792007 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 15:38:12.792032 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 15:38:12.792050 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 15:38:12.792078 414644 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 15:38:12.792098 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 15:38:12.792115 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 15:38:12.792213 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 15:38:12.792243 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 15:38:12.792264 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 15:38:12.792297 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 15:38:12.792317 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 15:38:12.792340 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 15:38:12.792356 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 15:38:12.792376 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 15:38:12.792400 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 15:38:12.792423 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 15:38:12.792441 414644 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 15:38:12.792455 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 15:38:12.792474 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 15:38:12.792518 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 15:38:12.792546 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 15:38:12.792570 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 15:38:12.792591 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 15:38:12.792611 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 15:38:12.792639 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 15:38:12.792672 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 15:38:12.792696 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 15:38:12.792721 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 15:38:12.792740 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 15:38:12.792757 414644 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 15:38:12.792773 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 15:38:12.792786 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 15:38:12.792824 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 15:38:12.792843 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 15:38:12.792867 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 15:38:12.792888 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 15:38:12.792922 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 15:38:12.792945 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 15:38:12.792963 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 15:38:12.792994 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 15:38:12.793021 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 15:38:12.793040 414644 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 15:38:12.793057 414644 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 15:38:12.793072 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 15:38:12.793089 414644 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240128 15:38:12.941766 414644 IPCTensor.h:368] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240128 15:38:12.941900 414644 IPCTensor.h:368] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 37
Rank1: cached key size 37
Rank2: cached key size 37
Rank3: cached key size 37
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 344,  642,  749,  ...,  987, 4613, 6731]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.587 seconds
[Rank1] pid = 414854
[Rank2] pid = 414918
INFO [414644 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [414854 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [414918 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [414644 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [414919 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [414919 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 15:38:15.395360 414920 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_0 [149, 400]; dev=0; size=232.8 kB
W20240128 15:38:15.395702 414920 IPCTensor.h:368] NewIPCTensor: input_keys_0 [1000000]0x100014876000 7.629 MB
W20240128 15:38:15.395800 414920 IPCTensor.h:368] NewIPCTensor: input_keys_neg_0 [1000000]0x100015019000 7.629 MB
W20240128 15:38:15.395839 414920 IPCTensor.h:368] NewIPCTensor: backward_grads_0 [1000000, 400]0x1000157bc000 1.49 GB
W20240128 15:38:15.395869 414920 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x100074d9f000 1.49 GB
W20240128 15:38:15.395905 414920 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 15:38:15.396323 414940 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_3 [149, 400]; dev=3; size=232.8 kB
W20240128 15:38:15.397828 414920 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 15:38:15.399652 414940 IPCTensor.h:368] NewIPCTensor: input_keys_3 [1000000]0x1000d4388000 7.629 MB
W20240128 15:38:15.399796 414940 IPCTensor.h:368] NewIPCTensor: input_keys_neg_3 [1000000]0x1000d4b2b000 7.629 MB
W20240128 15:38:15.399858 414940 IPCTensor.h:368] NewIPCTensor: backward_grads_3 [1000000, 400]0x1000d52ce000 1.49 GB
W20240128 15:38:15.399899 414940 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001348b1000 1.49 GB
W20240128 15:38:15.399935 414940 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
INFO [414854 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 15:38:15.403371 414940 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
INFO [414918 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 15:38:15.404037 414855 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_1 [149, 400]; dev=1; size=232.8 kB
W20240128 15:38:15.406248 414855 IPCTensor.h:368] NewIPCTensor: input_keys_1 [1000000]0x100193e9a000 7.629 MB
W20240128 15:38:15.406366 414855 IPCTensor.h:368] NewIPCTensor: input_keys_neg_1 [1000000]0x10019463d000 7.629 MB
W20240128 15:38:15.406417 414855 IPCTensor.h:368] NewIPCTensor: backward_grads_1 [1000000, 400]0x100194de0000 1.49 GB
W20240128 15:38:15.406450 414855 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1001f43c3000 1.49 GB
W20240128 15:38:15.406481 414855 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 15:38:15.406683 414930 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_2 [149, 400]; dev=2; size=232.8 kB
W20240128 15:38:15.408732 414855 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 15:38:15.408843 414930 IPCTensor.h:368] NewIPCTensor: input_keys_2 [1000000]0x1002539aa000 7.629 MB
W20240128 15:38:15.408986 414930 IPCTensor.h:368] NewIPCTensor: input_keys_neg_2 [1000000]0x10025414d000 7.629 MB
W20240128 15:38:15.409056 414930 IPCTensor.h:368] NewIPCTensor: backward_grads_2 [1000000, 400]0x1002548f0000 1.49 GB
W20240128 15:38:15.409096 414930 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x1002b3ed3000 1.49 GB
W20240128 15:38:15.409129 414930 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 15:38:15.414309 414930 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [414918 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [414919 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [414854 DistTensor.py:56] The tensor name already exists in the kvstore
[Rank3] pid = 414919
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 149), (149, 298), (298, 447), (447, 596)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [414644 DistTensor.py:56] The tensor name already exists in the kvstore
I20240128 15:38:16.675474 414920 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240128 15:38:16.675541 414930 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 15:38:16.675766 414940 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 15:38:16.675840 414855 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240128 15:38:16.677006 414920 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 1,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.01,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240128 15:38:16.677104 414920 grad_base.h:184] Init GradProcessingBase done
I20240128 15:38:16.681201 414920 grad_async_v2.h:32] Use background thread to update emb. nr_background_threads=32
W20240128 15:38:16.681299 414920 kg_controller.h:78] after init GradAsyncProcessingV2
I20240128 15:38:16.681305 414920 kg_controller.h:84] Construct KGCacheController done
E20240128 15:38:17.054724 414855 recstore.cc:66] init folly done
E20240128 15:38:17.054726 414930 recstore.cc:66] init folly done
E20240128 15:38:17.054730 414940 recstore.cc:66] init folly done
E20240128 15:38:17.054772 414920 recstore.cc:66] init folly done
I20240128 15:38:17.055619 414920 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240128 15:38:17.785429 415545 grad_async_v2.h:121] Detect new sample comes, old_end0, new_end1
E20240128 15:38:17.785746 415545 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
I20240128 15:38:17.814229 414940 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 15:38:17.819922 414855 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 15:38:17.829079 414920 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 15:38:17.836984 414930 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240128 15:38:20.116621 415278 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
W20240128 15:38:20.131757 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=1, pq.top=0
W20240128 15:38:20.133744 415545 grad_async_v2.h:121] Detect new sample comes, old_end1, new_end2
E20240128 15:38:21.116009 415545 parallel_pq_v2.h:76] insert failed, size(hashtable)=2
W20240128 15:38:21.134377 415545 grad_async_v2.h:121] Detect new sample comes, old_end5, new_end6
W20240128 15:38:21.142284 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=26, pq.top=26
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.016 ms                  | 12.326 ms                 |
| Forward                   | 3.738 ms                  | 779.864 ms                |
| Backward                  | 3.034 ms                  | 212.331 ms                |
| Optimize                  | 1.995 ms                  | 34.676 ms                 |
| BarrierTimeBeforeRank0    | 228.743 us                | 419.905 ms                |
| AfterBackward             | 17.667 ms                 | 845.961 ms                |
| BlockToStepN              | 8.994 ms                  | 64.894 ms                 |
| OneStep                   | 42.296 ms                 | 2.295 s                   |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 1.800 ms                  | 82.803 ms                 |
| ProcessBack:UpdateCache   | 1.348 ms                  | 210.247 ms                |
| ProcessBack:UpsertPq      | 12.602 ms                 | 17.015 ms                 |
| ProcessOneStep            | 18.354 ms                 | 845.650 ms                |
| BlockToStepN              | 10.102 ms                 | 64.802 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:22.116077 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=5429
W20240128 15:38:22.135761 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:22.142037 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=47, pq.top=47
E20240128 15:38:23.116014 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=4291
W20240128 15:38:23.139551 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:23.142011 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=67, pq.top=67
E20240128 15:38:24.116015 415545 parallel_pq_v2.h:76] insert failed, size(hashtable)=111
W20240128 15:38:24.142014 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=87, pq.top=87
W20240128 15:38:24.153597 415545 grad_async_v2.h:121] Detect new sample comes, old_end7, new_end8
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 6.979, sample: 0.190, forward: 1.171, backward: 0.557, update: 0.240
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 6.956, sample: 0.258, forward: 1.065, backward: 0.476, update: 0.215
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 6.973, sample: 0.271, forward: 1.499, backward: 0.600, update: 0.231
train_sampler.Prefill()
-------Step 0-------
tensor([   27,  3429,  8250,  6904,  8034,  5041, 11119,  4259, 13043,  9873]) tensor([  749,  8302,  8332,  3343,  5973, 10029, 14844, 10531,  7370,  7838])
-------Step 1-------
tensor([   27,  3429,  8250,  6904,  8034,  5041, 11119,  4259, 13043,  9873]) tensor([ 8150, 10852,   424,  2342,  1164, 12164,  6363,  2157,  1283, 14357])
-------Step 2-------
tensor([ 8484, 10287,  4536,  9198,   755,  4904,  9104,  1912, 14865,  9425]) tensor([ 6002,  4066,  2763,  9303,  7138,  2905,  4681, 10785, 10893,  3137])
-------Step 3-------
tensor([ 8484, 10287,  4536,  9198,   755,  4904,  9104,  1912, 14865,  9425]) tensor([ 7731,  4705,  3404,  8057, 10600, 10689, 13878, 11378, 14619,  5633])
-------Step 4-------
tensor([10126,  4190,  6769,  1901,  9679, 12462, 13071,  9811, 11904,  5647]) tensor([ 2282,  8297,  6317,  9709,  9606, 10673,   706,  1736, 13156, 14830])
-------Step 5-------
tensor([10126,  4190,  6769,  1901,  9679, 12462, 13071,  9811, 11904,  5647]) tensor([11690,  8389,  9554, 13716,   781,  8854,  8934, 11583, 13635, 14275])
-------Step 6-------
tensor([ 9042,  8655,  2330, 10750, 10837,  8213,  6592,  1839,  3160,  9376]) tensor([ 5741, 10289,  6278, 13770,  8950,   868,  9224, 10543, 11648, 12905])
-------Step 7-------
tensor([ 9042,  8655,  2330, 10750, 10837,  8213,  6592,  1839,  3160,  9376]) tensor([11389, 13277,  7557, 12330,  6645, 13949, 12945, 12602, 13212,  9247])
-------Step 8-------
tensor([ 4880, 10239, 11503, 10978,    21,  9855,  7875,  9580,  4790, 10287]) tensor([14076, 12277, 11149,   110, 11163,  9450,  7522,  1336,  6867,  8122])
-------Step 9-------
tensor([ 4880, 10239, 11503, 10978,    21,  9855,  7875,  9580,  4790, 10287]) tensor([ 9027, 11805,  4996,  7378,  3602,  5885,     8,  8454,  5476, 13549])
before start barrier
start train
[proc 0] 100 steps, total: 6.964, sample: 0.268, forward: 1.173, backward: 0.612, update: 0.206
E20240128 15:38:25.116019 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2382
W20240128 15:38:25.162824 415545 grad_async_v2.h:121] Detect new sample comes, old_end7, new_end8
W20240128 15:38:25.169996 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=108, pq.top=108
E20240128 15:38:26.116009 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2572
W20240128 15:38:26.180241 415545 grad_async_v2.h:121] Detect new sample comes, old_end7, new_end0
W20240128 15:38:26.197583 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=130, pq.top=130
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.158 ms                  | 19.386 ms                 |
| Forward                   | 4.167 ms                  | 7.132 ms                  |
| Backward                  | 4.300 ms                  | 6.376 ms                  |
| Optimize                  | 1.618 ms                  | 3.737 ms                  |
| BarrierTimeBeforeRank0    | 24.972 us                 | 5.059 ms                  |
| AfterBackward             | 17.466 ms                 | 21.827 ms                 |
| BlockToStepN              | 16.115 ms                 | 50.034 ms                 |
| OneStep                   | 47.134 ms                 | 98.112 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 1.992 ms                  | 2.318 ms                  |
| ProcessBack:UpdateCache   | 1.328 ms                  | 1.971 ms                  |
| ProcessBack:UpsertPq      | 11.941 ms                 | 16.492 ms                 |
| ProcessOneStep            | 17.288 ms                 | 21.807 ms                 |
| BlockToStepN              | 16.689 ms                 | 49.966 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:27.116032 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=5355
W20240128 15:38:27.198791 415545 grad_async_v2.h:121] Detect new sample comes, old_end9, new_end0
W20240128 15:38:27.235663 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=151, pq.top=151
E20240128 15:38:28.116020 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=3363
W20240128 15:38:28.199704 415545 grad_async_v2.h:121] Detect new sample comes, old_end0, new_end1
W20240128 15:38:28.252482 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=172, pq.top=172
E20240128 15:38:29.116007 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=4571
W20240128 15:38:29.210850 415545 grad_async_v2.h:121] Detect new sample comes, old_end9, new_end0
W20240128 15:38:29.255975 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=191, pq.top=191
[proc 2] 200 steps, total: 4.983, sample: 0.293, forward: 0.296, backward: 0.254, update: 0.141
[proc 0] 200 steps, total: 4.983, sample: 0.349, forward: 0.410, backward: 0.343, update: 0.185
[proc 1] 200 steps, total: 4.983, sample: 0.316, forward: 0.424, backward: 0.330, update: 0.184
[proc 3] 200 steps, total: 4.983, sample: 0.271, forward: 0.395, backward: 0.361, update: 0.178
E20240128 15:38:30.116010 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=4333
W20240128 15:38:30.224648 415545 grad_async_v2.h:121] Detect new sample comes, old_end8, new_end9
W20240128 15:38:30.273131 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=209, pq.top=209
E20240128 15:38:31.116405 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2852
W20240128 15:38:31.235033 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:31.273167 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=227, pq.top=227
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.181 ms                  | 20.399 ms                 |
| Forward                   | 4.169 ms                  | 6.033 ms                  |
| Backward                  | 3.303 ms                  | 6.252 ms                  |
| Optimize                  | 1.849 ms                  | 3.737 ms                  |
| BarrierTimeBeforeRank0    | 29.336 us                 | 16.863 ms                 |
| AfterBackward             | 17.906 ms                 | 22.180 ms                 |
| BlockToStepN              | 16.840 ms                 | 44.662 ms                 |
| OneStep                   | 49.598 ms                 | 97.925 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.044 ms                  | 4.490 ms                  |
| ProcessBack:UpdateCache   | 1.491 ms                  | 1.963 ms                  |
| ProcessBack:UpsertPq      | 13.270 ms                 | 16.492 ms                 |
| ProcessOneStep            | 17.909 ms                 | 22.124 ms                 |
| BlockToStepN              | 17.382 ms                 | 44.624 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:32.116015 414920 parallel_pq_v2.h:76] insert failed, size(hashtable)=1450
W20240128 15:38:32.241971 415545 grad_async_v2.h:121] Detect new sample comes, old_end4, new_end5
W20240128 15:38:32.315690 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=246, pq.top=246
E20240128 15:38:33.116027 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=5468
W20240128 15:38:33.241340 415545 grad_async_v2.h:121] Detect new sample comes, old_end2, new_end3
W20240128 15:38:33.334316 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=264, pq.top=264
E20240128 15:38:34.116015 415278 parallel_pq_v2.h:76] insert failed, size(hashtable)=1970
W20240128 15:38:34.249871 415545 grad_async_v2.h:121] Detect new sample comes, old_end9, new_end0
W20240128 15:38:34.352185 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=281, pq.top=281
E20240128 15:38:35.116009 414920 parallel_pq_v2.h:76] insert failed, size(hashtable)=1143
W20240128 15:38:35.255930 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:35.361364 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=298, pq.top=298
[proc 1] 300 steps, total: 5.738, sample: 0.302, forward: 0.419, backward: 0.340, update: 0.173
[proc 2] 300 steps, total: 5.738, sample: 0.241, forward: 0.292, backward: 0.255, update: 0.133
[proc 3] 300 steps, total: 5.738, sample: 0.313, forward: 0.393, backward: 0.315, update: 0.154
[proc 0] 300 steps, total: 5.738, sample: 0.353, forward: 0.410, backward: 0.303, update: 0.187
E20240128 15:38:36.116034 415278 parallel_pq_v2.h:76] insert failed, size(hashtable)=12
W20240128 15:38:36.279428 415545 grad_async_v2.h:121] Detect new sample comes, old_end3, new_end4
W20240128 15:38:36.368978 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=315, pq.top=315
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.220 ms                  | 20.691 ms                 |
| Forward                   | 4.195 ms                  | 5.572 ms                  |
| Backward                  | 3.178 ms                  | 5.983 ms                  |
| Optimize                  | 1.852 ms                  | 3.737 ms                  |
| BarrierTimeBeforeRank0    | 38.290 us                 | 17.758 ms                 |
| AfterBackward             | 18.371 ms                 | 22.180 ms                 |
| BlockToStepN              | 18.644 ms                 | 42.740 ms                 |
| OneStep                   | 51.384 ms                 | 76.546 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.100 ms                  | 3.983 ms                  |
| ProcessBack:UpdateCache   | 1.577 ms                  | 1.964 ms                  |
| ProcessBack:UpsertPq      | 13.810 ms                 | 16.716 ms                 |
| ProcessOneStep            | 18.372 ms                 | 22.124 ms                 |
| BlockToStepN              | 18.542 ms                 | 42.671 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:37.116122 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=6554
W20240128 15:38:37.279250 415545 grad_async_v2.h:121] Detect new sample comes, old_end0, new_end1
W20240128 15:38:37.373073 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=332, pq.top=332
E20240128 15:38:38.116065 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2519
W20240128 15:38:38.285476 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:38.393863 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=349, pq.top=349
E20240128 15:38:39.116580 415545 parallel_pq_v2.h:76] insert failed, size(hashtable)=51
W20240128 15:38:39.290447 415545 grad_async_v2.h:121] Detect new sample comes, old_end3, new_end4
W20240128 15:38:39.393522 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=365, pq.top=365
E20240128 15:38:40.116129 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2742
W20240128 15:38:40.306594 415545 grad_async_v2.h:121] Detect new sample comes, old_end0, new_end1
W20240128 15:38:40.402897 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=382, pq.top=382
E20240128 15:38:41.116063 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2491
W20240128 15:38:41.315986 415545 grad_async_v2.h:121] Detect new sample comes, old_end6, new_end7
W20240128 15:38:41.402563 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=398, pq.top=398
[proc 2] 400 steps, total: 6.035, sample: 0.269, forward: 0.298, backward: 0.259, update: 0.132
[proc 1] 400 steps, total: 6.035, sample: 0.296, forward: 0.413, backward: 0.310, update: 0.199
[proc 0] 400 steps, total: 6.035, sample: 0.405, forward: 0.407, backward: 0.303, update: 0.181
[proc 3] 400 steps, total: 6.035, sample: 0.292, forward: 0.399, backward: 0.279, update: 0.162
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.242 ms                  | 21.676 ms                 |
| Forward                   | 4.196 ms                  | 5.517 ms                  |
| Backward                  | 3.154 ms                  | 5.777 ms                  |
| Optimize                  | 1.874 ms                  | 3.660 ms                  |
| BarrierTimeBeforeRank0    | 40.939 us                 | 16.863 ms                 |
| AfterBackward             | 18.591 ms                 | 22.289 ms                 |
| BlockToStepN              | 19.187 ms                 | 47.344 ms                 |
| OneStep                   | 52.972 ms                 | 78.985 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.164 ms                  | 3.983 ms                  |
| ProcessBack:UpdateCache   | 1.709 ms                  | 1.971 ms                  |
| ProcessBack:UpsertPq      | 14.096 ms                 | 17.015 ms                 |
| ProcessOneStep            | 18.581 ms                 | 22.259 ms                 |
| BlockToStepN              | 19.123 ms                 | 47.977 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:42.116012 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=4968
W20240128 15:38:42.326179 415545 grad_async_v2.h:121] Detect new sample comes, old_end3, new_end4
W20240128 15:38:42.402616 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=415, pq.top=415
E20240128 15:38:43.116012 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=3272
W20240128 15:38:43.336221 415545 grad_async_v2.h:121] Detect new sample comes, old_end9, new_end0
W20240128 15:38:43.402048 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=431, pq.top=431
E20240128 15:38:44.116042 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=3070
W20240128 15:38:44.346997 415545 grad_async_v2.h:121] Detect new sample comes, old_end5, new_end6
W20240128 15:38:44.402134 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=447, pq.top=447
E20240128 15:38:45.116561 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=2438
W20240128 15:38:45.350327 415545 grad_async_v2.h:121] Detect new sample comes, old_end2, new_end3
W20240128 15:38:45.419376 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=464, pq.top=464
E20240128 15:38:46.116016 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=3687
W20240128 15:38:46.404120 415545 grad_async_v2.h:121] Detect new sample comes, old_end9, new_end0
W20240128 15:38:46.433789 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=480, pq.top=480
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.261 ms                  | 21.878 ms                 |
| Forward                   | 4.196 ms                  | 5.507 ms                  |
| Backward                  | 3.154 ms                  | 5.756 ms                  |
| Optimize                  | 1.878 ms                  | 3.602 ms                  |
| BarrierTimeBeforeRank0    | 40.317 us                 | 16.863 ms                 |
| AfterBackward             | 18.720 ms                 | 22.180 ms                 |
| BlockToStepN              | 20.161 ms                 | 50.034 ms                 |
| OneStep                   | 54.361 ms                 | 85.046 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.173 ms                  | 2.933 ms                  |
| ProcessBack:UpdateCache   | 1.718 ms                  | 1.971 ms                  |
| ProcessBack:UpsertPq      | 14.198 ms                 | 16.845 ms                 |
| ProcessOneStep            | 18.681 ms                 | 22.124 ms                 |
| BlockToStepN              | 20.114 ms                 | 53.447 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 15:38:47.116019 415544 parallel_pq_v2.h:76] insert failed, size(hashtable)=3309
W20240128 15:38:47.433478 414920 grad_async_v2.h:250] Sleep in <BlockToStepN>, step_no=495, pq.top=495
W20240128 15:38:47.439838 415545 grad_async_v2.h:121] Detect new sample comes, old_end5, new_end6
[proc 0] 500 steps, total: 6.203, sample: 0.350, forward: 0.404, backward: 0.314, update: 0.193
[proc 3] 500 steps, total: 6.203, sample: 0.270, forward: 0.396, backward: 0.293, update: 0.173
[proc 2] 500 steps, total: 6.203, sample: 0.291, forward: 0.296, backward: 0.256, update: 0.144
[proc 1] 500 steps, total: 6.203, sample: 0.277, forward: 0.408, backward: 0.308, update: 0.190
Successfully xmh. training takes 29.923658847808838 seconds
before call kg_cache_controller.StopThreads()
W20240128 15:38:47.752781 414920 grad_async_v2.h:71] call StopThreads. PID = 414644
W20240128 15:38:47.752810 414920 grad_base.h:212] before processOneStepNegThread_.join();
W20240128 15:38:47.752981 414920 grad_base.h:214] after processOneStepNegThread_.join();
W20240128 15:38:47.752986 414920 grad_async_v2.h:73] call GradProcessingBase::StopThreads.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
W20240128 15:38:47.762840 414920 grad_async_v2.h:92] StopThreads done.
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7f414e56e410>
