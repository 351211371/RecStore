WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 12:00:59.800760 47851 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_80', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.1, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [47851 sampler.py:454] Start PreSampling
WARNING [47851 sampler.py:532] Before construct renumbering_dict
WARNING [47851 sampler.py:555] PreSampling done
W20240128 12:01:02.203187 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 12:01:02.203342 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 12:01:02.203366 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 12:01:02.203392 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 12:01:02.203410 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 12:01:02.203433 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 12:01:02.203454 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 12:01:02.203480 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 12:01:02.203503 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 12:01:02.203521 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 12:01:02.203558 47851 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 12:01:02.203578 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 12:01:02.203595 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 12:01:02.203692 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 12:01:02.203714 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 12:01:02.203735 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 12:01:02.203774 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 12:01:02.203801 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 12:01:02.203826 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 12:01:02.203847 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 12:01:02.203866 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 12:01:02.203882 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 12:01:02.203902 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 12:01:02.203920 47851 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 12:01:02.203935 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 12:01:02.203954 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 12:01:02.203994 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 12:01:02.204015 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 12:01:02.204037 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 12:01:02.204058 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 12:01:02.204074 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 12:01:02.204097 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 12:01:02.204113 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 12:01:02.204133 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 12:01:02.204154 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 12:01:02.204171 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 12:01:02.204188 47851 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 12:01:02.204202 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 12:01:02.204217 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 12:01:02.204250 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 12:01:02.204268 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 12:01:02.204286 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 12:01:02.204314 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 12:01:02.204339 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 12:01:02.204361 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 12:01:02.204377 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 12:01:02.204397 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 12:01:02.204417 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 12:01:02.204435 47851 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 12:01:02.204455 47851 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 12:01:02.204469 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 12:01:02.204483 47851 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240128 12:01:02.339392 47851 IPCTensor.h:368] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240128 12:01:02.339515 47851 IPCTensor.h:368] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 373
Rank1: cached key size 373
Rank2: cached key size 373
Rank3: cached key size 373
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([1659, 1961, 2038,  ..., 2393, 6334, 8255]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.571 seconds
[Rank1] pid = 48061
[Rank2] pid = 48126
INFO [47851 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [48061 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [48126 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [48061 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [48126 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [48190 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [48190 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 12:01:05.553642 48127 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_2 [1495, 400]; dev=2; size=2.281 MB
W20240128 12:01:05.554190 48127 IPCTensor.h:368] NewIPCTensor: input_keys_2 [1000000]0x100014876000 7.629 MB
W20240128 12:01:05.554313 48127 IPCTensor.h:368] NewIPCTensor: input_keys_neg_2 [1000000]0x100015019000 7.629 MB
W20240128 12:01:05.554359 48127 IPCTensor.h:368] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000157bc000 1.49 GB
W20240128 12:01:05.554406 48127 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x100074d9f000 1.49 GB
W20240128 12:01:05.554328 48062 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_1 [1495, 400]; dev=1; size=2.281 MB
W20240128 12:01:05.554450 48127 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 12:01:05.554792 48192 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_3 [1495, 400]; dev=3; size=2.281 MB
W20240128 12:01:05.557351 48062 IPCTensor.h:368] NewIPCTensor: input_keys_1 [1000000]0x1000d4384000 7.629 MB
W20240128 12:01:05.557608 48062 IPCTensor.h:368] NewIPCTensor: input_keys_neg_1 [1000000]0x1000d4b27000 7.629 MB
W20240128 12:01:05.557731 48062 IPCTensor.h:368] NewIPCTensor: backward_grads_1 [1000000, 400]0x1000d52cc000 1.49 GB
W20240128 12:01:05.557834 48062 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1001348b1000 1.49 GB
W20240128 12:01:05.557876 48127 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 12:01:05.557927 48062 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 12:01:05.557940 48192 IPCTensor.h:368] NewIPCTensor: input_keys_3 [1000000]0x100193e94000 7.629 MB
W20240128 12:01:05.558109 48192 IPCTensor.h:368] NewIPCTensor: input_keys_neg_3 [1000000]0x100194637000 7.629 MB
W20240128 12:01:05.558187 48192 IPCTensor.h:368] NewIPCTensor: backward_grads_3 [1000000, 400]0x100194dda000 1.49 GB
W20240128 12:01:05.558252 48192 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001f43bd000 1.49 GB
W20240128 12:01:05.558310 48192 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
INFO [47851 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 12:01:05.561614 48191 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_0 [1495, 400]; dev=0; size=2.281 MB
W20240128 12:01:05.568542 48062 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 12:01:05.574232 48192 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240128 12:01:05.579282 48191 IPCTensor.h:368] NewIPCTensor: input_keys_0 [1000000]0x1002539ac000 7.629 MB
W20240128 12:01:05.579494 48191 IPCTensor.h:368] NewIPCTensor: input_keys_neg_0 [1000000]0x10025414f000 7.629 MB
W20240128 12:01:05.579591 48191 IPCTensor.h:368] NewIPCTensor: backward_grads_0 [1000000, 400]0x1002548f2000 1.49 GB
W20240128 12:01:05.579666 48191 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x1002b3ed5000 1.49 GB
W20240128 12:01:05.579735 48191 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 12:01:05.585661 48191 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [48126 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [48190 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [48061 DistTensor.py:56] The tensor name already exists in the kvstore
[Rank3] pid = 48190
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 1495), (1495, 2990), (2990, 4485), (4485, 5980)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [47851 DistTensor.py:56] The tensor name already exists in the kvstore
I20240128 12:01:06.617480 48191 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240128 12:01:06.617623 48127 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 12:01:06.617709 48062 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 12:01:06.617867 48192 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240128 12:01:06.619319 48191 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 1,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.1,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240128 12:01:06.619446 48191 grad_base.h:184] Init GradProcessingBase done
I20240128 12:01:06.623930 48191 grad_async_v2.h:32] Use background thread to update emb. nr_background_threads=32
W20240128 12:01:06.624033 48191 kg_controller.h:78] after init GradAsyncProcessingV2
I20240128 12:01:06.624038 48191 kg_controller.h:84] Construct KGCacheController done
I20240128 12:01:06.990504 48191 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240128 12:01:07.620911 48605 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240128 12:01:07.621237 48605 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
I20240128 12:01:07.644006 48191 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 12:01:07.647466 48127 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 12:01:07.671638 48192 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 12:01:07.673821 48062 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240128 12:01:10.238240 48381 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
W20240128 12:01:10.249727 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=1, pq.top=0
W20240128 12:01:10.256000 48605 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 12:01:11.238029 48191 parallel_pq_v2.h:76] insert failed, size(hashtable)=1445
W20240128 12:01:11.258031 48605 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
W20240128 12:01:11.272976 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=31, pq.top=31
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.063 ms                  | 16.283 ms                 |
| Forward                   | 3.209 ms                  | 1.629 s                   |
| Backward                  | 2.627 ms                  | 279.673 ms                |
| Optimize                  | 1.230 ms                  | 2.980 ms                  |
| BarrierTimeBeforeRank0    | 22.695 us                 | 2.075 ms                  |
| AfterBackward             | 19.171 ms                 | 662.579 ms                |
| BlockToStepN              | 5.252 ms                  | 17.005 ms                 |
| OneStep                   | 35.034 ms                 | 2.581 s                   |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.314 ms                  | 66.045 ms                 |
| ProcessBack:UpdateCache   | 1.899 ms                  | 210.423 ms                |
| ProcessBack:UpsertPq      | 13.396 ms                 | 16.541 ms                 |
| ProcessOneStep            | 19.261 ms                 | 662.271 ms                |
| BlockToStepN              | 5.811 ms                  | 16.957 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:01:12.238013 48381 parallel_pq_v2.h:76] insert failed, size(hashtable)=1456
W20240128 12:01:12.260890 48605 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
W20240128 12:01:12.289708 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=58, pq.top=58
E20240128 12:01:13.238147 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=4011
W20240128 12:01:13.261890 48605 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240128 12:01:13.289115 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=83, pq.top=83
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 6.334, sample: 0.220, forward: 1.190, backward: 0.539, update: 0.103
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 6.332, sample: 0.228, forward: 1.212, backward: 0.609, update: 0.114
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 6.359, sample: 0.154, forward: 1.875, backward: 0.539, update: 0.112
train_sampler.Prefill()
-------Step 0-------
tensor([10566,   286,  9328,  7981,  9862,  5827, 10039,  4556, 11526,   120]) tensor([ 2038,  7705,  9411,  1478,  7850,  9999, 13519, 10435,  8839,  8271])
-------Step 1-------
tensor([10566,   286,  9328,  7981,  9862,  5827, 10039,  4556, 11526,   120]) tensor([ 7227, 13258, 12080, 14197,  7328,  9266,  6096,  2300,  2530,  7975])
-------Step 2-------
tensor([ 8884,  3014,  4139,    23,   680,   292,   125, 10318, 11522,  8524]) tensor([10718,  4707,  3947, 12307,  2340,  2740, 12390,  6146, 14264,  8808])
-------Step 3-------
tensor([ 8884,  3014,  4139,    23,   680,   292,   125, 10318, 11522,  8524]) tensor([  536, 11653,  6836, 13224,   293,   532,  2347, 11832,  5048,   227])
-------Step 4-------
tensor([ 3936, 14873, 11240, 10703,  5166,  6083, 14729,  6835,  4089,  2148]) tensor([13633,  1007, 10834, 11053,  3938,   743,  6048,  1102,  9349, 11936])
-------Step 5-------
tensor([ 3936, 14873, 11240, 10703,  5166,  6083, 14729,  6835,  4089,  2148]) tensor([ 6933,  7113,  8700, 14343,  1243, 11492,  3124, 13835,  7865,  6262])
-------Step 6-------
tensor([12064,   608,  8460,   116, 11486, 11109, 14253, 11240, 11655,  6873]) tensor([ 3462,  8600,  6807, 11110,  9793, 12106,  1979,  2996, 11680,  1354])
-------Step 7-------
tensor([12064,   608,  8460,   116, 11486, 11109, 14253, 11240, 11655,  6873]) tensor([ 5102, 13424,  8666,  8108,  5010,   880,  6781,   990, 10970, 13312])
-------Step 8-------
tensor([ 9497,  9996, 13115,  9610,  5153,  7034,  1775,  5621,  5104, 14529]) tensor([ 8460, 11156, 13008,  1770, 10793, 11984,  2334,  8713,  7875,  8640])
-------Step 9-------
tensor([ 9497,  9996, 13115,  9610,  5153,  7034,  1775,  5621,  5104, 14529]) tensor([ 9255, 11674,  1674,  3743,  2462,   603,  6044,  3071,  2530, 13389])
before start barrier
start train
[proc 0] 100 steps, total: 6.362, sample: 0.273, forward: 1.940, backward: 0.576, update: 0.121
E20240128 12:01:14.238008 48605 parallel_pq_v2.h:76] insert failed, size(hashtable)=97
W20240128 12:01:14.269501 48605 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
W20240128 12:01:14.296490 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=107, pq.top=107
E20240128 12:01:15.238039 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=4090
W20240128 12:01:15.273164 48605 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
W20240128 12:01:15.300348 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=131, pq.top=131
E20240128 12:01:16.238008 48381 parallel_pq_v2.h:76] insert failed, size(hashtable)=483
W20240128 12:01:16.275475 48605 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
W20240128 12:01:16.300091 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=156, pq.top=156
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.181 ms                  | 14.634 ms                 |
| Forward                   | 3.135 ms                  | 4.741 ms                  |
| Backward                  | 2.722 ms                  | 5.004 ms                  |
| Optimize                  | 1.196 ms                  | 2.376 ms                  |
| BarrierTimeBeforeRank0    | 19.636 us                 | 1.598 ms                  |
| AfterBackward             | 18.007 ms                 | 20.940 ms                 |
| BlockToStepN              | 10.339 ms                 | 21.107 ms                 |
| OneStep                   | 39.898 ms                 | 53.447 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.281 ms                  | 2.995 ms                  |
| ProcessBack:UpdateCache   | 1.730 ms                  | 2.085 ms                  |
| ProcessBack:UpsertPq      | 12.984 ms                 | 15.985 ms                 |
| ProcessOneStep            | 17.986 ms                 | 20.917 ms                 |
| BlockToStepN              | 10.289 ms                 | 21.042 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:01:17.238013 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=2664
W20240128 12:01:17.294612 48605 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
W20240128 12:01:17.320904 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=181, pq.top=181
[proc 1] 200 steps, total: 4.168, sample: 0.249, forward: 0.287, backward: 0.261, update: 0.106
[proc 3] 200 steps, total: 4.168, sample: 0.249, forward: 0.285, backward: 0.239, update: 0.106
[proc 2] 200 steps, total: 4.168, sample: 0.172, forward: 0.265, backward: 0.289, update: 0.104
[proc 0] 200 steps, total: 4.168, sample: 0.308, forward: 0.309, backward: 0.278, update: 0.116
E20240128 12:01:18.238018 48381 parallel_pq_v2.h:76] insert failed, size(hashtable)=749
W20240128 12:01:18.312453 48605 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
W20240128 12:01:18.337930 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=204, pq.top=204
E20240128 12:01:19.238015 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=6500
W20240128 12:01:19.314735 48605 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
W20240128 12:01:19.339709 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=227, pq.top=227
E20240128 12:01:20.238036 48605 parallel_pq_v2.h:76] insert failed, size(hashtable)=52
W20240128 12:01:20.336097 48605 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
W20240128 12:01:20.383548 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=248, pq.top=248
E20240128 12:01:21.238015 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=6463
W20240128 12:01:21.336262 48605 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
W20240128 12:01:21.397277 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=270, pq.top=270
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.242 ms                  | 15.127 ms                 |
| Forward                   | 3.154 ms                  | 4.741 ms                  |
| Backward                  | 2.680 ms                  | 4.860 ms                  |
| Optimize                  | 1.186 ms                  | 2.396 ms                  |
| BarrierTimeBeforeRank0    | 19.752 us                 | 9.807 ms                  |
| AfterBackward             | 18.319 ms                 | 25.245 ms                 |
| BlockToStepN              | 11.619 ms                 | 25.329 ms                 |
| OneStep                   | 41.789 ms                 | 56.243 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.296 ms                  | 2.986 ms                  |
| ProcessBack:UpdateCache   | 1.735 ms                  | 2.812 ms                  |
| ProcessBack:UpsertPq      | 13.394 ms                 | 19.830 ms                 |
| ProcessOneStep            | 18.320 ms                 | 25.224 ms                 |
| BlockToStepN              | 11.460 ms                 | 25.266 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:01:22.238009 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=6741
W20240128 12:01:22.361083 48605 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
W20240128 12:01:22.397176 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=291, pq.top=291
[proc 2] 300 steps, total: 4.679, sample: 0.210, forward: 0.280, backward: 0.279, update: 0.117
[proc 1] 300 steps, total: 4.679, sample: 0.235, forward: 0.305, backward: 0.245, update: 0.106
[proc 3] 300 steps, total: 4.679, sample: 0.246, forward: 0.301, backward: 0.245, update: 0.103
[proc 0] 300 steps, total: 4.679, sample: 0.283, forward: 0.324, backward: 0.263, update: 0.123
E20240128 12:01:23.238006 48191 parallel_pq_v2.h:76] insert failed, size(hashtable)=519
W20240128 12:01:23.361613 48605 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240128 12:01:23.402509 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=312, pq.top=312
E20240128 12:01:24.238006 48191 parallel_pq_v2.h:76] insert failed, size(hashtable)=1160
W20240128 12:01:24.379829 48605 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240128 12:01:24.410207 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=333, pq.top=333
E20240128 12:01:25.238008 48191 parallel_pq_v2.h:76] insert failed, size(hashtable)=1251
W20240128 12:01:25.410409 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=353, pq.top=353
W20240128 12:01:25.411895 48605 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
E20240128 12:01:26.238014 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=6440
W20240128 12:01:26.413388 48605 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
W20240128 12:01:26.443378 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=374, pq.top=374
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.249 ms                  | 15.015 ms                 |
| Forward                   | 3.134 ms                  | 4.447 ms                  |
| Backward                  | 2.680 ms                  | 4.802 ms                  |
| Optimize                  | 1.175 ms                  | 2.376 ms                  |
| BarrierTimeBeforeRank0    | 20.368 us                 | 11.621 ms                 |
| AfterBackward             | 19.171 ms                 | 25.249 ms                 |
| BlockToStepN              | 11.645 ms                 | 29.114 ms                 |
| OneStep                   | 43.212 ms                 | 58.876 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.279 ms                  | 2.941 ms                  |
| ProcessBack:UpdateCache   | 1.722 ms                  | 2.782 ms                  |
| ProcessBack:UpsertPq      | 13.859 ms                 | 19.830 ms                 |
| ProcessOneStep            | 19.303 ms                 | 25.224 ms                 |
| BlockToStepN              | 11.595 ms                 | 29.059 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:01:27.238564 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=5190
W20240128 12:01:27.434617 48605 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
W20240128 12:01:27.472397 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=395, pq.top=395
[proc 2] 400 steps, total: 4.886, sample: 0.222, forward: 0.280, backward: 0.290, update: 0.115
[proc 1] 400 steps, total: 4.886, sample: 0.257, forward: 0.309, backward: 0.252, update: 0.101
[proc 3] 400 steps, total: 4.886, sample: 0.226, forward: 0.306, backward: 0.247, update: 0.108
[proc 0] 400 steps, total: 4.886, sample: 0.234, forward: 0.286, backward: 0.263, update: 0.108
E20240128 12:01:28.238595 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=3771
W20240128 12:01:28.471284 48605 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
W20240128 12:01:28.516100 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=414, pq.top=414
E20240128 12:01:29.238008 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=7214
W20240128 12:01:29.491544 48605 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
W20240128 12:01:29.525833 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=434, pq.top=434
E20240128 12:01:30.238009 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=5887
W20240128 12:01:30.494623 48605 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
W20240128 12:01:30.536988 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=453, pq.top=453
E20240128 12:01:31.238041 48381 parallel_pq_v2.h:76] insert failed, size(hashtable)=926
W20240128 12:01:31.495976 48605 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240128 12:01:31.567997 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=473, pq.top=473
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.269 ms                  | 15.391 ms                 |
| Forward                   | 3.159 ms                  | 4.463 ms                  |
| Backward                  | 2.676 ms                  | 5.178 ms                  |
| Optimize                  | 1.184 ms                  | 2.396 ms                  |
| BarrierTimeBeforeRank0    | 20.962 us                 | 12.460 ms                 |
| AfterBackward             | 20.294 ms                 | 25.868 ms                 |
| BlockToStepN              | 11.932 ms                 | 30.738 ms                 |
| OneStep                   | 44.337 ms                 | 65.026 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.298 ms                  | 2.847 ms                  |
| ProcessBack:UpdateCache   | 1.759 ms                  | 2.826 ms                  |
| ProcessBack:UpsertPq      | 14.551 ms                 | 20.428 ms                 |
| ProcessOneStep            | 20.300 ms                 | 25.835 ms                 |
| BlockToStepN              | 11.883 ms                 | 32.223 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:01:32.238010 48604 parallel_pq_v2.h:76] insert failed, size(hashtable)=6575
W20240128 12:01:32.535248 48605 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
W20240128 12:01:32.580138 48191 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=492, pq.top=492
[proc 2] 500 steps, total: 5.259, sample: 0.244, forward: 0.275, backward: 0.276, update: 0.114
[proc 0] 500 steps, total: 5.259, sample: 0.302, forward: 0.326, backward: 0.272, update: 0.116
[proc 3] 500 steps, total: 5.259, sample: 0.190, forward: 0.289, backward: 0.249, update: 0.108
[proc 1] 500 steps, total: 5.259, sample: 0.236, forward: 0.315, backward: 0.276, update: 0.097
Successfully xmh. training takes 25.354528188705444 seconds
before call kg_cache_controller.StopThreads()
W20240128 12:01:32.998529 48191 grad_async_v2.h:71] call StopThreads. PID = 47851
W20240128 12:01:32.998555 48191 grad_base.h:212] before processOneStepNegThread_.join();
W20240128 12:01:32.998827 48191 grad_base.h:214] after processOneStepNegThread_.join();
W20240128 12:01:32.998834 48191 grad_async_v2.h:73] call GradProcessingBase::StopThreads.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
W20240128 12:01:33.007222 48191 grad_async_v2.h:91] StopThreads done.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7fc346e16250>
