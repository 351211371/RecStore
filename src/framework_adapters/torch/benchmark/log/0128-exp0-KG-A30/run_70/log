WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240128 12:47:09.820386 109058 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='DistMult', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/DistMult_FB15k_10', no_save_emb=True, max_step=500, batch_size=1800, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='KnownLocalCachedEmbedding', use_my_emb=True, cache_ratio=0.01, shuffle=False, backwardMode='CppAsyncV2', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [109058 sampler.py:454] Start PreSampling
WARNING [109058 sampler.py:532] Before construct renumbering_dict
WARNING [109058 sampler.py:555] PreSampling done
W20240128 12:47:12.078150 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240128 12:47:12.078296 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240128 12:47:12.078323 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240128 12:47:12.078347 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240128 12:47:12.078372 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240128 12:47:12.078390 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240128 12:47:12.078413 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240128 12:47:12.078437 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240128 12:47:12.078455 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240128 12:47:12.078478 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240128 12:47:12.078502 109058 IPCTensor.h:368] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240128 12:47:12.078523 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240128 12:47:12.078544 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240128 12:47:12.078635 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240128 12:47:12.078656 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240128 12:47:12.078677 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240128 12:47:12.078716 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240128 12:47:12.078737 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240128 12:47:12.078753 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240128 12:47:12.078774 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240128 12:47:12.078791 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240128 12:47:12.078812 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240128 12:47:12.078832 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240128 12:47:12.078852 109058 IPCTensor.h:368] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240128 12:47:12.078868 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240128 12:47:12.078883 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240128 12:47:12.078922 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240128 12:47:12.078943 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240128 12:47:12.078963 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240128 12:47:12.078979 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240128 12:47:12.078998 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240128 12:47:12.079015 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240128 12:47:12.079044 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240128 12:47:12.079068 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240128 12:47:12.079092 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240128 12:47:12.079119 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240128 12:47:12.079138 109058 IPCTensor.h:368] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240128 12:47:12.079154 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240128 12:47:12.079174 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240128 12:47:12.079214 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240128 12:47:12.079236 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240128 12:47:12.079252 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240128 12:47:12.079274 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240128 12:47:12.079296 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240128 12:47:12.079317 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240128 12:47:12.079340 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240128 12:47:12.079357 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240128 12:47:12.079378 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240128 12:47:12.079397 109058 IPCTensor.h:368] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240128 12:47:12.079419 109058 IPCTensor.h:368] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240128 12:47:12.079434 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240128 12:47:12.079448 109058 IPCTensor.h:368] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
W20240128 12:47:12.235129 109058 IPCTensor.h:368] NewIPCTensor: full_emb [14951, 400]0x100013192000 22.81 MB
W20240128 12:47:12.235270 109058 IPCTensor.h:368] NewIPCTensor: full_emb_SparseRowWiseAdaGrad_sum [14951]0x100014864000 58.4 kB
{0: Graph(num_nodes=10523, num_edges=182012,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=10996, num_edges=244360,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=9404, num_edges=143355,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=10954, num_edges=175447,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 10523 N 182012 E
MertisPartition: part 1 has 10996 N 244360 E
MertisPartition: part 2 has 9404 N 143355 E
MertisPartition: part 3 has 10954 N 175447 E
Rank0: cached key size 37
Rank1: cached key size 37
Rank2: cached key size 37
Rank3: cached key size 37
Before renumbering graph:  {'_ID': tensor([    5,    14,    17,  ..., 11245,  2040,  3009]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
After renumbering graph:  {'_ID': tensor([ 273,  499,  569,  ..., 1167, 6463, 6962]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 2, 3, 3])}
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=10523, num_edges=182012,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 2.445 seconds
[Rank1] pid = 109377
[Rank2] pid = 109442
INFO [109058 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [109377 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [109442 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [109442 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [109506 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
W20240128 12:47:15.494980 109443 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_2 [149, 400]; dev=2; size=232.8 kB
INFO [109506 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 12:47:15.495615 109443 IPCTensor.h:368] NewIPCTensor: input_keys_2 [1000000]0x100014876000 7.629 MB
W20240128 12:47:15.495805 109443 IPCTensor.h:368] NewIPCTensor: input_keys_neg_2 [1000000]0x100015019000 7.629 MB
W20240128 12:47:15.495865 109443 IPCTensor.h:368] NewIPCTensor: backward_grads_2 [1000000, 400]0x1000157bc000 1.49 GB
W20240128 12:47:15.495914 109443 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_2 [1000000, 400]0x100074d9f000 1.49 GB
W20240128 12:47:15.495956 109443 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 12:47:15.497813 109508 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_3 [149, 400]; dev=3; size=232.8 kB
W20240128 12:47:15.498438 109443 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_2_gpu [1000000, 400]; dev=2; size=1.49 GB
W20240128 12:47:15.500941 109508 IPCTensor.h:368] NewIPCTensor: input_keys_3 [1000000]0x1000d4388000 7.629 MB
INFO [109058 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 12:47:15.501230 109508 IPCTensor.h:368] NewIPCTensor: input_keys_neg_3 [1000000]0x1000d4b2b000 7.629 MB
W20240128 12:47:15.501353 109508 IPCTensor.h:368] NewIPCTensor: backward_grads_3 [1000000, 400]0x1000d52ce000 1.49 GB
W20240128 12:47:15.501443 109508 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_3 [1000000, 400]0x1001348b1000 1.49 GB
W20240128 12:47:15.501533 109508 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_3_gpu [1000000, 400]; dev=3; size=1.49 GB
INFO [109377 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
W20240128 12:47:15.502677 109507 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_0 [149, 400]; dev=0; size=232.8 kB
W20240128 12:47:15.504534 109378 IPCTensor.h:408] NewIPCGPUTensor: embedding_cache_1 [149, 400]; dev=1; size=232.8 kB
W20240128 12:47:15.508000 109508 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_3_gpu [1000000, 400]; dev=3; size=1.49 GB
W20240128 12:47:15.508307 109378 IPCTensor.h:368] NewIPCTensor: input_keys_1 [1000000]0x100193e98000 7.629 MB
W20240128 12:47:15.508631 109378 IPCTensor.h:368] NewIPCTensor: input_keys_neg_1 [1000000]0x10019463b000 7.629 MB
W20240128 12:47:15.508777 109378 IPCTensor.h:368] NewIPCTensor: backward_grads_1 [1000000, 400]0x100194dde000 1.49 GB
W20240128 12:47:15.508900 109378 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_1 [1000000, 400]0x1001f43c1000 1.49 GB
W20240128 12:47:15.508999 109378 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 12:47:15.519351 109378 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_1_gpu [1000000, 400]; dev=1; size=1.49 GB
W20240128 12:47:15.519977 109507 IPCTensor.h:368] NewIPCTensor: input_keys_0 [1000000]0x1002539aa000 7.629 MB
W20240128 12:47:15.520210 109507 IPCTensor.h:368] NewIPCTensor: input_keys_neg_0 [1000000]0x10025414d000 7.629 MB
W20240128 12:47:15.520356 109507 IPCTensor.h:368] NewIPCTensor: backward_grads_0 [1000000, 400]0x1002548f0000 1.49 GB
W20240128 12:47:15.520443 109507 IPCTensor.h:368] NewIPCTensor: backward_grads_neg_0 [1000000, 400]0x1002b3ed3000 1.49 GB
W20240128 12:47:15.520545 109507 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_0_gpu [1000000, 400]; dev=0; size=1.49 GB
W20240128 12:47:15.534387 109507 IPCTensor.h:408] NewIPCGPUTensor: backward_grads_neg_0_gpu [1000000, 400]; dev=0; size=1.49 GB
cudaHostRegister 0x100013192000
2: KnownLocalCachedEmbedding init done
WARNING [109442 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
3: KnownLocalCachedEmbedding init done
WARNING [109506 DistTensor.py:56] The tensor name already exists in the kvstore
[Rank3] pid = 109506
New CachedEmbedding, name=full_emb, shape=(14951, 400), cache_type=KnownLocalCachedEmbedding
fixed cache_range is [(0, 149), (149, 298), (298, 447), (447, 596)]
cudaHostRegister 0x100013192000
0: KnownLocalCachedEmbedding init done
WARNING [109058 DistTensor.py:56] The tensor name already exists in the kvstore
cudaHostRegister 0x100013192000
1: KnownLocalCachedEmbedding init done
WARNING [109377 DistTensor.py:56] The tensor name already exists in the kvstore
I20240128 12:47:16.618927 109378 IPC_barrier.h:118] CreateBarrier: new barrier, name: kgcachecontroller, count: 4
I20240128 12:47:16.618988 109507 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 12:47:16.619207 109443 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
I20240128 12:47:16.619343 109508 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: kgcachecontroller, count: 4
W20240128 12:47:16.620386 109507 grad_base.h:55] KGCacheController, config={
        "num_gpus": 4,
        "L": 10,
        "backgrad_init": "both", 
        "kForwardItersPerStep": 2,
        "clr": 1,
        "nr_background_threads": 32,
        "backwardMode": "CppAsyncV2",
        "cache_ratio": 0.01,
        "update_cache_use_omp":  0,
        "update_pq_use_omp":  0
        }
W20240128 12:47:16.620491 109507 grad_base.h:184] Init GradProcessingBase done
I20240128 12:47:16.623982 109507 grad_async_v2.h:32] Use background thread to update emb. nr_background_threads=32
W20240128 12:47:16.624065 109507 kg_controller.h:78] after init GradAsyncProcessingV2
I20240128 12:47:16.624071 109507 kg_controller.h:84] Construct KGCacheController done
I20240128 12:47:16.989619 109507 grad_base.h:60] GraphEnv RegTensorsPerProcess
W20240128 12:47:17.677831 109916 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240128 12:47:17.678189 109916 parallel_pq_v2.h:76] insert failed, size(hashtable)=1
I20240128 12:47:17.703363 109507 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240128 12:47:17.733495 109443 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 12:47:17.742753 109508 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240128 12:47:17.749835 109378 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
E20240128 12:47:20.041254 109692 parallel_pq_v2.h:76] insert failed, size(hashtable)=6
W20240128 12:47:20.058095 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=1, pq.top=0
W20240128 12:47:20.065200 109916 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 12:47:21.041056 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7822
W20240128 12:47:21.067967 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=23, pq.top=23
W20240128 12:47:21.120571 109916 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end3
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.446 ms                  | 21.142 ms                 |
| Forward                   | 3.679 ms                  | 1.241 s                   |
| Backward                  | 2.488 ms                  | 173.841 ms                |
| Optimize                  | 1.956 ms                  | 48.879 ms                 |
| BarrierTimeBeforeRank0    | 40.087 us                 | 3.763 ms                  |
| AfterBackward             | 23.189 ms                 | 842.477 ms                |
| BlockToStepN              | 5.852 ms                  | 74.343 ms                 |
| OneStep                   | 44.939 ms                 | 2.314 s                   |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.257 ms                  | 92.237 ms                 |
| ProcessBack:UpdateCache   | 1.900 ms                  | 218.975 ms                |
| ProcessBack:UpsertPq      | 18.403 ms                 | 26.754 ms                 |
| ProcessOneStep            | 24.310 ms                 | 842.215 ms                |
| BlockToStepN              | 8.648 ms                  | 74.281 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:22.041030 109692 parallel_pq_v2.h:76] insert failed, size(hashtable)=928
W20240128 12:47:22.095028 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=41, pq.top=41
W20240128 12:47:22.140089 109916 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end2
E20240128 12:47:23.041009 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7602
W20240128 12:47:23.115737 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=61, pq.top=61
W20240128 12:47:23.174105 109916 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end3
E20240128 12:47:24.041009 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=4730
W20240128 12:47:24.115657 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=81, pq.top=81
W20240128 12:47:24.217824 109916 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end3
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 7.251, sample: 0.297, forward: 1.023, backward: 0.522, update: 0.183
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 7.258, sample: 0.221, forward: 0.984, backward: 0.523, update: 0.173
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 7.267, sample: 0.286, forward: 1.375, backward: 0.562, update: 0.214
train_sampler.Prefill()
-------Step 0-------
tensor([   13,  2631,  8838,  2742,  9053,  3908,  9998,  4298, 12974,  9220]) tensor([  569,  8487,  8924,  3477,  8355,  7609, 13096,  7954,  7564,  8076])
-------Step 1-------
tensor([   13,  2631,  8838,  2742,  9053,  3908,  9998,  4298, 12974,  9220]) tensor([ 9729,  4270,   412,  2795,  1176, 11559,  6290,  2083,  1554, 14904])
-------Step 2-------
tensor([ 9788,  6382,  5365,  6994,   850,  6073,  7458,  1874, 13253,  7170]) tensor([ 8394,  5095,  3102, 11269,  7287,  2215,  3633, 12022, 12955,  3311])
-------Step 3-------
tensor([ 9788,  6382,  5365,  6994,   850,  6073,  7458,  1874, 13253,  7170]) tensor([ 9460,  4840,  3971,  3198, 12676, 10801, 13293,  9988, 14336,  5168])
-------Step 4-------
tensor([11353,  4398,  7676,  2259, 11096, 11146, 14676, 12596,  8901,  6906]) tensor([  980,  7871,  6121, 11732,  9767, 12666,   365,  1704, 11689, 13640])
-------Step 5-------
tensor([11353,  4398,  7676,  2259, 11096, 11146, 14676, 12596,  8901,  6906]) tensor([11600,  6401, 10731, 13723,   869, 11537,  5593, 13565, 12069, 14256])
-------Step 6-------
tensor([11043, 10579,  2446,  7986, 12950,  8339,  7999,  2012,  1960,  9586]) tensor([ 5645, 11770,  7425, 12206,  6817,   970,  9378, 12616,  4593, 12601])
-------Step 7-------
tensor([11043, 10579,  2446,  7986, 12950,  8339,  7999,  2012,  1960,  9586]) tensor([11243, 13241,  6977, 11691,  8257, 12427, 11346, 13736, 13686,  9408])
-------Step 8-------
tensor([ 4497,  7736, 13578, 10838,    33, 11290,  8033,  9610,  5033,  6382]) tensor([ 8828, 11000, 14415,   107, 13212,  3732,  5885,  1284,  7133,  9234])
-------Step 9-------
tensor([ 4497,  7736, 13578, 10838,    33, 11290,  8033,  9610,  5033,  6382]) tensor([ 9210, 12991,  6304,  7219,  4162,  6192,     7,  7512,  6888, 13314])
before start barrier
start train
[proc 0] 100 steps, total: 7.298, sample: 0.335, forward: 1.582, backward: 0.412, update: 0.215
E20240128 12:47:25.041015 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=3816
W20240128 12:47:25.137929 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=103, pq.top=103
W20240128 12:47:25.235823 109916 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end4
E20240128 12:47:26.041009 109692 parallel_pq_v2.h:76] insert failed, size(hashtable)=1666
W20240128 12:47:26.156196 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=122, pq.top=122
W20240128 12:47:26.242781 109916 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.384 ms                  | 20.951 ms                 |
| Forward                   | 3.414 ms                  | 6.110 ms                  |
| Backward                  | 2.450 ms                  | 4.087 ms                  |
| Optimize                  | 1.533 ms                  | 3.513 ms                  |
| BarrierTimeBeforeRank0    | 26.474 us                 | 5.821 ms                  |
| AfterBackward             | 21.958 ms                 | 34.642 ms                 |
| BlockToStepN              | 12.684 ms                 | 59.560 ms                 |
| OneStep                   | 47.814 ms                 | 104.368 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.220 ms                  | 2.909 ms                  |
| ProcessBack:UpdateCache   | 1.921 ms                  | 3.970 ms                  |
| ProcessBack:UpsertPq      | 16.465 ms                 | 27.381 ms                 |
| ProcessOneStep            | 21.803 ms                 | 34.616 ms                 |
| BlockToStepN              | 12.606 ms                 | 59.505 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:27.041018 109507 parallel_pq_v2.h:76] insert failed, size(hashtable)=2982
W20240128 12:47:27.176991 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=144, pq.top=144
W20240128 12:47:27.242695 109916 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
E20240128 12:47:28.041031 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6059
W20240128 12:47:28.176164 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=163, pq.top=163
W20240128 12:47:28.251739 109916 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
E20240128 12:47:29.041023 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=1381
W20240128 12:47:29.176271 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=181, pq.top=181
W20240128 12:47:29.257241 109916 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
E20240128 12:47:30.041011 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6810
W20240128 12:47:30.182441 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=199, pq.top=199
[proc 1] 200 steps, total: 5.253, sample: 0.331, forward: 0.325, backward: 0.227, update: 0.139
[proc 3] 200 steps, total: 5.253, sample: 0.308, forward: 0.315, backward: 0.236, update: 0.146
[proc 2] 200 steps, total: 5.253, sample: 0.321, forward: 0.305, backward: 0.242, update: 0.153
[proc 0] 200 steps, total: 5.253, sample: 0.379, forward: 0.332, backward: 0.240, update: 0.141
W20240128 12:47:30.261191 109916 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
E20240128 12:47:31.041038 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=5489
W20240128 12:47:31.198132 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=217, pq.top=217
W20240128 12:47:31.272029 109916 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.389 ms                  | 21.142 ms                 |
| Forward                   | 3.351 ms                  | 5.313 ms                  |
| Backward                  | 2.452 ms                  | 3.389 ms                  |
| Optimize                  | 1.454 ms                  | 3.463 ms                  |
| BarrierTimeBeforeRank0    | 39.485 us                 | 17.320 ms                 |
| AfterBackward             | 20.237 ms                 | 32.782 ms                 |
| BlockToStepN              | 15.633 ms                 | 54.056 ms                 |
| OneStep                   | 49.842 ms                 | 103.452 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.196 ms                  | 2.879 ms                  |
| ProcessBack:UpdateCache   | 1.833 ms                  | 2.762 ms                  |
| ProcessBack:UpsertPq      | 15.401 ms                 | 27.095 ms                 |
| ProcessOneStep            | 20.160 ms                 | 32.756 ms                 |
| BlockToStepN              | 15.559 ms                 | 53.960 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:32.041009 109507 parallel_pq_v2.h:76] insert failed, size(hashtable)=2573
W20240128 12:47:32.198137 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=235, pq.top=235
W20240128 12:47:32.286295 109916 grad_async_v2.h:120] Detect new sample comes, old_end6, new_end7
E20240128 12:47:33.041038 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7619
W20240128 12:47:33.209522 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=253, pq.top=253
W20240128 12:47:33.302651 109916 grad_async_v2.h:120] Detect new sample comes, old_end4, new_end5
E20240128 12:47:34.041016 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6526
W20240128 12:47:34.218273 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=271, pq.top=271
W20240128 12:47:34.311161 109916 grad_async_v2.h:120] Detect new sample comes, old_end2, new_end3
E20240128 12:47:35.041010 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=3926
W20240128 12:47:35.245002 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=289, pq.top=289
W20240128 12:47:35.317386 109916 grad_async_v2.h:120] Detect new sample comes, old_end0, new_end1
[proc 0] 300 steps, total: 5.648, sample: 0.290, forward: 0.297, backward: 0.252, update: 0.129
[proc 1] 300 steps, total: 5.648, sample: 0.307, forward: 0.326, backward: 0.237, update: 0.148
[proc 3] 300 steps, total: 5.648, sample: 0.327, forward: 0.313, backward: 0.238, update: 0.140
[proc 2] 300 steps, total: 5.648, sample: 0.266, forward: 0.303, backward: 0.260, update: 0.159
E20240128 12:47:36.041016 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=5817
W20240128 12:47:36.244344 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=306, pq.top=306
W20240128 12:47:36.328444 109916 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.355 ms                  | 20.951 ms                 |
| Forward                   | 3.294 ms                  | 4.870 ms                  |
| Backward                  | 2.458 ms                  | 3.389 ms                  |
| Optimize                  | 1.399 ms                  | 3.331 ms                  |
| BarrierTimeBeforeRank0    | 124.007 us                | 18.204 ms                 |
| AfterBackward             | 19.372 ms                 | 32.354 ms                 |
| BlockToStepN              | 17.405 ms                 | 50.856 ms                 |
| OneStep                   | 52.114 ms                 | 100.870 ms                |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.160 ms                  | 2.879 ms                  |
| ProcessBack:UpdateCache   | 1.561 ms                  | 2.744 ms                  |
| ProcessBack:UpsertPq      | 14.224 ms                 | 26.928 ms                 |
| ProcessOneStep            | 19.280 ms                 | 32.328 ms                 |
| BlockToStepN              | 17.514 ms                 | 50.792 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:37.041010 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6601
W20240128 12:47:37.244123 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=324, pq.top=324
W20240128 12:47:37.328111 109916 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
E20240128 12:47:38.041013 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=4593
W20240128 12:47:38.255268 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=342, pq.top=342
W20240128 12:47:38.334913 109916 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
E20240128 12:47:39.041018 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7021
W20240128 12:47:39.297037 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=361, pq.top=361
W20240128 12:47:39.335520 109916 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 12:47:40.041007 109507 parallel_pq_v2.h:76] insert failed, size(hashtable)=3054
W20240128 12:47:40.331076 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=379, pq.top=379
W20240128 12:47:40.348897 109916 grad_async_v2.h:120] Detect new sample comes, old_end9, new_end0
E20240128 12:47:41.041013 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=5371
W20240128 12:47:41.334328 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=395, pq.top=395
W20240128 12:47:41.360615 109916 grad_async_v2.h:120] Detect new sample comes, old_end5, new_end6
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.361 ms                  | 20.836 ms                 |
| Forward                   | 3.252 ms                  | 4.867 ms                  |
| Backward                  | 2.461 ms                  | 3.273 ms                  |
| Optimize                  | 1.366 ms                  | 3.271 ms                  |
| BarrierTimeBeforeRank0    | 253.724 us                | 18.634 ms                 |
| AfterBackward             | 19.099 ms                 | 32.265 ms                 |
| BlockToStepN              | 18.174 ms                 | 49.387 ms                 |
| OneStep                   | 53.516 ms                 | 89.836 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 0] 400 steps, total: 5.786, sample: 0.311, forward: 0.290, backward: 0.241, update: 0.124
[proc 3] 400 steps, total: 5.786, sample: 0.306, forward: 0.324, backward: 0.236, update: 0.149
[proc 1] 400 steps, total: 5.786, sample: 0.299, forward: 0.334, backward: 0.232, update: 0.145
[proc 2] 400 steps, total: 5.786, sample: 0.259, forward: 0.304, backward: 0.253, update: 0.173
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.138 ms                  | 2.818 ms                  |
| ProcessBack:UpdateCache   | 1.450 ms                  | 2.741 ms                  |
| ProcessBack:UpsertPq      | 13.935 ms                 | 26.463 ms                 |
| ProcessOneStep            | 19.072 ms                 | 32.239 ms                 |
| BlockToStepN              | 18.261 ms                 | 50.792 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:42.041018 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7911
W20240128 12:47:42.382253 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=411, pq.top=411
W20240128 12:47:42.402271 109916 grad_async_v2.h:120] Detect new sample comes, old_end1, new_end2
E20240128 12:47:43.041031 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=2496
W20240128 12:47:43.421837 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=427, pq.top=427
W20240128 12:47:43.442323 109916 grad_async_v2.h:120] Detect new sample comes, old_end7, new_end8
E20240128 12:47:44.041033 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6919
W20240128 12:47:44.465682 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=443, pq.top=443
W20240128 12:47:44.485738 109916 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
E20240128 12:47:45.041010 109692 parallel_pq_v2.h:76] insert failed, size(hashtable)=511
W20240128 12:47:45.465636 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=458, pq.top=458
W20240128 12:47:45.486896 109916 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
E20240128 12:47:46.041008 109692 parallel_pq_v2.h:76] insert failed, size(hashtable)=3878
W20240128 12:47:46.465713 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=473, pq.top=473
W20240128 12:47:46.495066 109916 grad_async_v2.h:120] Detect new sample comes, old_end3, new_end4
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.411 ms                  | 21.332 ms                 |
| Forward                   | 3.257 ms                  | 4.799 ms                  |
| Backward                  | 2.465 ms                  | 3.273 ms                  |
| Optimize                  | 1.368 ms                  | 3.239 ms                  |
| BarrierTimeBeforeRank0    | 228.565 us                | 18.634 ms                 |
| AfterBackward             | 19.642 ms                 | 32.264 ms                 |
| BlockToStepN              | 19.181 ms                 | 51.497 ms                 |
| OneStep                   | 55.491 ms                 | 88.956 ms                 |
+---------------------------+---------------------------+---------------------------+
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| ProcessBack:Shuffle       | 2.173 ms                  | 2.738 ms                  |
| ProcessBack:UpdateCache   | 1.532 ms                  | 2.728 ms                  |
| ProcessBack:UpsertPq      | 14.655 ms                 | 26.220 ms                 |
| ProcessOneStep            | 19.643 ms                 | 32.239 ms                 |
| BlockToStepN              | 19.127 ms                 | 51.425 ms                 |
+---------------------------+---------------------------+---------------------------+
E20240128 12:47:47.041023 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=6036
W20240128 12:47:47.484675 109507 grad_async_v2.h:249] Sleep in <BlockToStepN>, step_no=488, pq.top=488
W20240128 12:47:47.505883 109916 grad_async_v2.h:120] Detect new sample comes, old_end8, new_end9
E20240128 12:47:48.041011 109915 parallel_pq_v2.h:76] insert failed, size(hashtable)=7009
[proc 3] 500 steps, total: 6.589, sample: 0.294, forward: 0.337, backward: 0.234, update: 0.149
[proc 0] 500 steps, total: 6.589, sample: 0.407, forward: 0.327, backward: 0.247, update: 0.144
[proc 2] 500 steps, total: 6.589, sample: 0.332, forward: 0.330, backward: 0.256, update: 0.166
[proc 1] 500 steps, total: 6.589, sample: 0.297, forward: 0.334, backward: 0.224, update: 0.142
Successfully xmh. training takes 30.574055194854736 seconds
before call kg_cache_controller.StopThreads()
W20240128 12:47:48.277463 109507 grad_async_v2.h:71] call StopThreads. PID = 109058
W20240128 12:47:48.277493 109507 grad_base.h:212] before processOneStepNegThread_.join();
W20240128 12:47:48.277665 109507 grad_base.h:214] after processOneStepNegThread_.join();
W20240128 12:47:48.277673 109507 grad_async_v2.h:73] call GradProcessingBase::StopThreads.
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker2: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker1: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
[W tensorpipe_agent.cpp:725] RPC agent for worker0 encountered error when reading incoming request from worker3: eof (this error originated at tensorpipe/transport/shm/connection_impl.cc:259)
W20240128 12:47:48.311060 109507 grad_async_v2.h:91] StopThreads done.
On rank0, prepare to call self.controller.StopThreads(), self=<python.controller_process.KGCacheControllerWrapper object at 0x7f0cd6b8f5d0>
