WARNING: Logging before InitGoogleLogging() is written to STDERR
I20240129 12:18:28.477460 31972 IPC_barrier.h:128] MultiProcessBarrierFactory->ClearIPCMemory()
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/_deprecate/graph.py:1023: DGLWarning: multigraph will be deprecated.DGL will treat all graphs as multigraph in the future.
  dgl_warning("multigraph will be deprecated." \
/data/home/xieminhui/RecStore/src/framework_adapters/torch/kg/dgl-0.9.1/python/dgl/heterograph.py:72: DGLWarning: Recommend creating graphs by `dgl.graph(data)` instead of `dgl.DGLGraph(data)`.
  dgl_warning('Recommend creating graphs by `dgl.graph(data)`'
Reading train triples....
Finished. Read 483142 train triples.
Reading valid triples....
Finished. Read 50000 valid triples.
Reading test triples....
Finished. Read 59071 test triples.
ARGS:  Namespace(model_name='TransE', data_path='/home/xieminhui/dgl-data', dataset='FB15k', format='built_in', data_files=None, delimiter='\t', save_path='/tmp/ckpts/TransE_FB15k_6', no_save_emb=True, max_step=500, batch_size=1200, batch_size_eval=16, neg_sample_size=200, neg_deg_sample=False, neg_deg_sample_eval=False, neg_sample_size_eval=14951, eval_percent=1, no_eval_filter=False, log_interval=100, eval_interval=10000, test=False, num_proc=4, num_thread=1, force_sync_interval=1, hidden_dim=400, lr=0.01, gamma=16.0, double_ent=False, double_rel=False, neg_adversarial_sampling=False, adversarial_temperature=1.0, regularization_coef=0.0, regularization_norm=3, pairwise=False, loss_genre='Logsigmoid', margin=1.0, nr_gpus=4, gpu=[0, 1, 2, 3], mix_cpu_gpu=True, valid=False, rel_part=False, async_update=None, has_edge_importance=False, cached_emb_type='None', use_my_emb=False, cache_ratio=0.05, shuffle=False, backwardMode='CppSync', L=10, update_cache_use_omp=0, update_pq_use_omp=0, kForwardItersPerStep=2, backgrad_init='both', eval_filter=True, soft_rel_part=False)
|Train|: 483142
original graph:  DGLGraph(num_nodes=14951, num_edges=592213,
         ndata_schemes={}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Loading cached metis
WARNING [31972 sampler.py:454] Start PreSampling
WARNING [31972 sampler.py:532] Before construct renumbering_dict
WARNING [31972 sampler.py:555] PreSampling done
W20240129 12:18:33.774487 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_0 [1000000]0x100000002000 7.629 MB
W20240129 12:18:33.774675 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_1 [1000000]0x1000007a5000 7.629 MB
W20240129 12:18:33.774724 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_2 [1000000]0x100000f48000 7.629 MB
W20240129 12:18:33.774763 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_3 [1000000]0x1000016eb000 7.629 MB
W20240129 12:18:33.774807 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_4 [1000000]0x100001e8e000 7.629 MB
W20240129 12:18:33.774857 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_5 [1000000]0x100002631000 7.629 MB
W20240129 12:18:33.774899 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_6 [1000000]0x100002dd4000 7.629 MB
W20240129 12:18:33.774999 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_7 [1000000]0x100003577000 7.629 MB
W20240129 12:18:33.775043 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_8 [1000000]0x100003d1a000 7.629 MB
W20240129 12:18:33.775084 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r0_9 [1000000]0x1000044bd000 7.629 MB
W20240129 12:18:33.775125 31972 IPCTensor.h:369] NewIPCTensor: step_r0 [10]0x100004c60000 80 B 
W20240129 12:18:33.775156 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r0 [1]0x100004c62000 8 B 
W20240129 12:18:33.775192 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r0 [1]0x100004c64000 8 B 
W20240129 12:18:33.775382 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_0 [1000000]0x100004c66000 7.629 MB
W20240129 12:18:33.775425 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_1 [1000000]0x100005409000 7.629 MB
W20240129 12:18:33.775460 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_2 [1000000]0x100005bac000 7.629 MB
W20240129 12:18:33.775516 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_3 [1000000]0x10000634f000 7.629 MB
W20240129 12:18:33.775552 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_4 [1000000]0x100006af2000 7.629 MB
W20240129 12:18:33.775594 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_5 [1000000]0x100007295000 7.629 MB
W20240129 12:18:33.775627 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_6 [1000000]0x100007a38000 7.629 MB
W20240129 12:18:33.775669 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_7 [1000000]0x1000081db000 7.629 MB
W20240129 12:18:33.775702 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_8 [1000000]0x10000897e000 7.629 MB
W20240129 12:18:33.775735 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r1_9 [1000000]0x100009121000 7.629 MB
W20240129 12:18:33.775774 31972 IPCTensor.h:369] NewIPCTensor: step_r1 [10]0x1000098c4000 80 B 
W20240129 12:18:33.775803 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r1 [1]0x1000098c6000 8 B 
W20240129 12:18:33.775838 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r1 [1]0x1000098c8000 8 B 
W20240129 12:18:33.775908 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_0 [1000000]0x1000098ca000 7.629 MB
W20240129 12:18:33.775944 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_1 [1000000]0x10000a06d000 7.629 MB
W20240129 12:18:33.775977 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_2 [1000000]0x10000a810000 7.629 MB
W20240129 12:18:33.776022 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_3 [1000000]0x10000afb3000 7.629 MB
W20240129 12:18:33.776074 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_4 [1000000]0x10000b756000 7.629 MB
W20240129 12:18:33.776120 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_5 [1000000]0x10000bef9000 7.629 MB
W20240129 12:18:33.776154 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_6 [1000000]0x10000c69c000 7.629 MB
W20240129 12:18:33.776187 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_7 [1000000]0x10000ce3f000 7.629 MB
W20240129 12:18:33.776221 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_8 [1000000]0x10000d5e2000 7.629 MB
W20240129 12:18:33.776261 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r2_9 [1000000]0x10000dd85000 7.629 MB
W20240129 12:18:33.776295 31972 IPCTensor.h:369] NewIPCTensor: step_r2 [10]0x10000e528000 80 B 
W20240129 12:18:33.776324 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r2 [1]0x10000e52a000 8 B 
W20240129 12:18:33.776360 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r2 [1]0x10000e52c000 8 B 
W20240129 12:18:33.776423 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_0 [1000000]0x10000e52e000 7.629 MB
W20240129 12:18:33.776458 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_1 [1000000]0x10000ecd1000 7.629 MB
W20240129 12:18:33.776492 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_2 [1000000]0x10000f474000 7.629 MB
W20240129 12:18:33.776526 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_3 [1000000]0x10000fc17000 7.629 MB
W20240129 12:18:33.776561 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_4 [1000000]0x1000103ba000 7.629 MB
W20240129 12:18:33.776604 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_5 [1000000]0x100010b5d000 7.629 MB
W20240129 12:18:33.776645 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_6 [1000000]0x100011300000 7.629 MB
W20240129 12:18:33.776690 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_7 [1000000]0x100011aa3000 7.629 MB
W20240129 12:18:33.776732 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_8 [1000000]0x100012246000 7.629 MB
W20240129 12:18:33.776777 31972 IPCTensor.h:369] NewIPCTensor: cached_sampler_r3_9 [1000000]0x1000129e9000 7.629 MB
W20240129 12:18:33.776810 31972 IPCTensor.h:369] NewIPCTensor: step_r3 [10]0x10001318c000 80 B 
W20240129 12:18:33.776839 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_r3 [1]0x10001318e000 8 B 
W20240129 12:18:33.776868 31972 IPCTensor.h:369] NewIPCTensor: circle_buffer_end_cppseen_r3 [1]0x100013190000 8 B 
{0: Graph(num_nodes=9703, num_edges=161860,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 1: Graph(num_nodes=11374, num_edges=168961,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 2: Graph(num_nodes=10715, num_edges=190828,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)}), 3: Graph(num_nodes=11184, num_edges=240046,
      ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_node': Scheme(shape=(), dtype=torch.int32), 'part_id': Scheme(shape=(), dtype=torch.int64)}
      edata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64), 'inner_edge': Scheme(shape=(), dtype=torch.int8)})}
MertisPartition: part 0 has 9703 N 161860 E
MertisPartition: part 1 has 11374 N 168961 E
MertisPartition: part 2 has 10715 N 190828 E
MertisPartition: part 3 has 11184 N 240046 E
Rank0: cached key size 186
Rank1: cached key size 186
Rank2: cached key size 186
Rank3: cached key size 186
Before renumbering graph:  {'_ID': tensor([   6,   10,   11,  ..., 5824, 6189, 2559]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
After renumbering graph:  {'_ID': tensor([ 913, 1013, 1029,  ..., 8465, 5949, 8774]), 'inner_node': tensor([1, 1, 1,  ..., 0, 0, 0], dtype=torch.int32), 'part_id': tensor([0, 0, 0,  ..., 1, 1, 2])}
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
part_g: DGLGraph(num_nodes=9703, num_edges=161860,
         ndata_schemes={'_ID': Scheme(shape=(), dtype=torch.int64)}
         edata_schemes={'tid': Scheme(shape=(), dtype=torch.int64)})
Total initialize time 5.673 seconds
[Rank1] pid = 32397
[Rank2] pid = 32461
INFO [31972 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 0
INFO [32397 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 1
INFO [32525 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 3
INFO [32461 distributed_c10d.py:442] Added key: store_based_barrier_key:1 to store for rank: 2
INFO [32525 distributed_c10d.py:476] Rank 3: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [32397 distributed_c10d.py:476] Rank 1: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [32461 distributed_c10d.py:476] Rank 2: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
INFO [31972 distributed_c10d.py:476] Rank 0: Completed store-based barrier for key:store_based_barrier_key:1 with 4 nodes.
E20240129 12:18:36.015187 32462 recstore.cc:66] init folly done
E20240129 12:18:36.015249 32589 recstore.cc:66] init folly done
E20240129 12:18:36.015264 32526 recstore.cc:66] init folly done
E20240129 12:18:36.015256 32398 recstore.cc:66] init folly done
I20240129 12:18:36.088899 32398 IPC_barrier.h:118] CreateBarrier: new barrier, name: start_barrier, count: 4
I20240129 12:18:36.091008 32462 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240129 12:18:36.091085 32589 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
I20240129 12:18:36.091573 32526 IPC_barrier.h:112] CreateBarrier: find existing barrier, name: start_barrier, count: 4
train_sampler.Prefill()
before start barrier
start train
[proc 2] 100 steps, total: 3.423, sample: 0.427, forward: 1.286, backward: 0.765, update: 0.643
train_sampler.Prefill()
before start barrier
start train
[proc 3] 100 steps, total: 3.423, sample: 0.427, forward: 1.259, backward: 0.772, update: 0.656
[Rank3] pid = 32525
train_sampler.Prefill()
-------Step 0-------
tensor([ 6530, 10814, 13713,  4068,   152,  4317, 10890,   135,   139,  8804]) tensor([ 1029,  8354,  3116, 14119,  3582,  8259,  2953,  7521,  5887, 10803])
-------Step 1-------
tensor([ 6530, 10814, 13713,  4068,   152,  4317, 10890,   135,   139,  8804]) tensor([ 2851,  9989, 12327,  9901,  6996, 13146,  8292,  3544,  6639, 10987])
-------Step 2-------
tensor([13876,  8047, 11450,  4485,   105,  3388,    53,  6609,  4856,  3415]) tensor([12387,  1329,  7789, 10630,  7298,    87, 11513,  8100,  8159, 12526])
-------Step 3-------
tensor([13876,  8047, 11450,  4485,   105,  3388,    53,  6609,  4856,  3415]) tensor([11447,  1758, 14250,  2786,  9487,  3884, 13417,  3989,  6001,  9345])
-------Step 4-------
tensor([ 9884,  8916,  8930,  2726,  8046, 12958, 11829, 11243,    75, 12698]) tensor([  564,  4989, 12861,  4931,  4609,    95,  3300,  4542, 13040,  8847])
-------Step 5-------
tensor([ 9884,  8916,  8930,  2726,  8046, 12958, 11829, 11243,    75, 12698]) tensor([ 5561,  7210,  2185, 14325, 13113, 12709,  3203, 12205,  3338, 11856])
-------Step 6-------
tensor([ 1894,  2269,  1819, 14493,   156, 12905, 13748,  3792,   123,  3805]) tensor([ 6408, 11485, 10099,  4115, 12443, 12108,  2726,  8196, 11310,  6930])
-------Step 7-------
tensor([ 1894,  2269,  1819, 14493,   156, 12905, 13748,  3792,   123,  3805]) tensor([12821,  4265, 12030,  7713,  2078,   968,  2162,  4103,  2680,  2756])
-------Step 8-------
tensor([  128, 11530,    21, 10158,  5491,  9987, 12863,  7251,   100,  2891]) tensor([ 6523,  2605,  1746,  6632,  9390, 10732,  1971,  5771, 10026, 13813])
-------Step 9-------
tensor([  128, 11530,    21, 10158,  5491,  9987, 12863,  7251,   100,  2891]) tensor([ 5802,  5886,  7123,  3650,  9739,  1865, 14945,  3544,  5421,  3501])
before start barrier
start train
[proc 0] 100 steps, total: 3.423, sample: 0.398, forward: 1.237, backward: 0.816, update: 0.647
train_sampler.Prefill()
before start barrier
start train
[proc 1] 100 steps, total: 3.426, sample: 0.407, forward: 1.229, backward: 0.764, update: 0.655
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.587 ms                  | 26.836 ms                 |
| Forward                   | 6.946 ms                  | 13.598 ms                 |
| Backward                  | 6.164 ms                  | 12.126 ms                 |
| Optimize                  | 6.055 ms                  | 13.203 ms                 |
| OneStep                   | 24.343 ms                 | 54.841 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 3] 200 steps, total: 2.650, sample: 0.437, forward: 0.710, backward: 0.608, update: 0.607
[proc 1] 200 steps, total: 2.650, sample: 0.455, forward: 0.673, backward: 0.588, update: 0.619
[proc 0] 200 steps, total: 2.650, sample: 0.439, forward: 0.694, backward: 0.599, update: 0.610
[proc 2] 200 steps, total: 2.650, sample: 0.465, forward: 0.704, backward: 0.593, update: 0.623
[proc 2] 300 steps, total: 2.780, sample: 0.408, forward: 0.724, backward: 0.601, update: 0.630
[proc 0] 300 steps, total: 2.780, sample: 0.404, forward: 0.727, backward: 0.589, update: 0.646
[proc 1] 300 steps, total: 2.780, sample: 0.403, forward: 0.685, backward: 0.596, update: 0.645
[proc 3] 300 steps, total: 2.780, sample: 0.407, forward: 0.724, backward: 0.605, update: 0.621
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.600 ms                  | 27.384 ms                 |
| Forward                   | 6.872 ms                  | 13.598 ms                 |
| Backward                  | 6.031 ms                  | 10.609 ms                 |
| Optimize                  | 5.966 ms                  | 15.220 ms                 |
| OneStep                   | 24.662 ms                 | 55.460 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 1] 400 steps, total: 3.407, sample: 0.516, forward: 0.754, backward: 0.596, update: 0.715
[proc 0] 400 steps, total: 3.407, sample: 0.446, forward: 0.815, backward: 0.600, update: 0.699
[proc 3] 400 steps, total: 3.407, sample: 0.474, forward: 0.788, backward: 0.608, update: 0.665
[proc 2] 400 steps, total: 3.407, sample: 0.478, forward: 0.779, backward: 0.607, update: 0.683
+---------------------------+---------------------------+---------------------------+
| Name                      | P50                       | P99                       |
+---------------------------+---------------------------+---------------------------+
| GenInput                  | 1.721 ms                  | 27.090 ms                 |
| Forward                   | 7.105 ms                  | 13.956 ms                 |
| Backward                  | 6.038 ms                  | 10.609 ms                 |
| Optimize                  | 6.126 ms                  | 13.581 ms                 |
| OneStep                   | 26.707 ms                 | 55.460 ms                 |
+---------------------------+---------------------------+---------------------------+
[proc 0] 500 steps, total: 3.405, sample: 0.497, forward: 0.826, backward: 0.610, update: 0.703
[proc 2] 500 steps, total: 3.405, sample: 0.475, forward: 0.778, backward: 0.616, update: 0.695
[proc 1] 500 steps, total: 3.405, sample: 0.437, forward: 0.771, backward: 0.597, update: 0.716
[proc 3] 500 steps, total: 3.405, sample: 0.481, forward: 0.797, backward: 0.603, update: 0.668
Successfully xmh. training takes 15.665346384048462 seconds
before call kg_cache_controller.StopThreads()
KGCacheControllerWrapperDummy.StopThreads
